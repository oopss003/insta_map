<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>저장된 매장 목록</title>

  <!-- 네이버 지도 -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=qpbrmxiff4"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    *{box-sizing:border-box}
    body{margin:0;display:flex;height:100vh;font-family:sans-serif}
    #map{flex:3}
    #list{
      flex:1;max-width:320px;overflow-y:auto;
      border-left:1px solid #ccc;padding:12px;background:#fafbff
    }
    #list h3{margin:0 0 12px 0}
    .store{padding:8px 6px;border-bottom:1px solid #e0e0e0;cursor:pointer;transition:background .2s}
    .store:hover{background:#eef3ff}
    .empty{color:#777;padding:6px}
    #locBtn{
      display:block;width:100%;margin-bottom:10px;padding:8px;border:none;border-radius:4px;
      background:#28a745;color:#fff;font-size:14px;cursor:pointer
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="list">
    <h3>매장 리스트</h3>
    <button id="locBtn">내 위치로 이동</button>
  </div>

<script>
/* ---------- Firebase 초기화 ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCVYV1UxfSREQYnah3tBEKBTprgq9wRgii",
  authDomain: "instamap-9b595.firebaseapp.com",
  projectId: "instamap-9b595",
  storageBucket: "instamap-9b595.appspot.com",
  messagingSenderId: "280950399933",
  appId: "1:280950399933:web:8282e0d352e50c8bcd2be0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------- 지도 ---------- */
const map = new naver.maps.Map('map',{
  center:new naver.maps.LatLng(37.5665,126.9780),zoom:12
});
let myMarker=null;   // 내 위치 마커

/* ---------- 내 위치 버튼 ---------- */
document.getElementById('locBtn').onclick=()=>{
  if(!navigator.geolocation){
    alert('브라우저가 위치 기능을 지원하지 않습니다.'); return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    const latlng = new naver.maps.LatLng(lat,lng);
    map.setCenter(latlng); map.setZoom(15);

    // 파란 원형 마커(내 위치)
    if(myMarker) myMarker.setMap(null);
    myMarker = new naver.maps.Marker({
      position: latlng, map,
      icon:{content:'<div style="width:14px;height:14px;border:3px solid #007bff;border-radius:50%;background:#fff"></div>'}
    });
  },()=>alert('위치 권한을 허용해주세요.'));
};

/* ---------- 매장 데이터 실시간 구독 ---------- */
const $list=document.getElementById('list');
db.collection('stores').orderBy('created','desc').onSnapshot(snapshot=>{
  // 리스트 새로 그리기 (버튼 아래부터)
  $list.innerHTML = '<h3>매장 리스트</h3><button id="locBtn">내 위치로 이동</button>';
  document.getElementById('locBtn').onclick = () => {     // 버튼 다시 바인딩
    document.getElementById('locBtn').click();
  };

  if(snapshot.empty){
    $list.insertAdjacentHTML('beforeend','<p class="empty">저장된 가게가 없습니다.</p>');
  }
  snapshot.forEach(doc=>{
    const s=doc.data();
    const pos=new naver.maps.LatLng(s.lat,s.lng);
    const marker=new naver.maps.Marker({position:pos,map});
    const info=new naver.maps.InfoWindow({
      content:`<div style="min-width:160px;padding:6px;font-size:13px">
                <strong>${s.name}</strong><br>
                <a href="https://instagram.com/${s.insta}" target="_blank">@${s.insta}</a><br>
                <span>${s.desc||''}</span>
              </div>`
    });
    naver.maps.Event.addListener(marker,'click',()=>info.open(map,marker));

    const div=document.createElement('div');
    div.className='store';
    div.innerHTML=`<strong>${s.name}</strong><br><small>@${s.insta}</small>`;
    div.onclick=()=>{map.setCenter(pos);map.setZoom(15);info.open(map,marker);}
    $list.appendChild(div);
  });
});
</script>
</body>
</html>

