<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>저장된 매장 목록</title>

  <!-- Naver Maps -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=qpbrmxiff4"></script>
  <!-- Firebase App & Firestore (compat 모드) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <style>
    body{margin:0;display:flex;height:100vh;font-family:sans-serif}
    #map{flex:3}
    #list{flex:1;overflow:auto;padding:10px;border-left:1px solid #ccc}
    h3{margin-top:0}
    #locBtn{
      display:block;
      width:100%;
      padding:10px;
      margin:10px 0;
      background:#28a745;
      color:#fff;
      border:none;
      border-radius:4px;
      font-size:16px;
      cursor:pointer;
    }
    .store{
      padding:6px;
      border-bottom:1px solid #ddd;
      cursor:pointer;
    }
    .store:hover{background:#f0f4ff}
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="list">
    <h3>준비하세요</h3>
    <button id="locBtn">내 위치로 이동</button>
    <!-- 매장 리스트가 여기 뒤로 쭉 붙습니다 -->
  </div>

  <script>
    // ────────────────────────────────
    // 1) Firebase 초기화
    // ────────────────────────────────
    const firebaseConfig = {
      apiKey: "AIzaSyCVV1XUfsREQYnah3tbEKBTPprgq9wRgiic",
      authDomain: "instamap-9b595.firebaseapp.com",
      projectId: "instamap-9b595",
      storageBucket: "instamap-9b595.appspot.com",
      messagingSenderId: "280950399393",
      appId: "1:280950399393:web:8282e0d352e50c8bcd2be0",
      measurementId: "G-46V9K6S14R"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ────────────────────────────────
    // 2) Naver Map 세팅
    // ────────────────────────────────
    const map = new naver.maps.Map('map', {
      center: new naver.maps.LatLng(37.5665,126.9780),
      zoom: 12
    });

    // 마커 관리
    let markers = [];
    let myMarker = null;

    function clearMarkers(){
      markers.forEach(m=>m.setMap(null));
      markers = [];
    }

    // ────────────────────────────────
    // 3) 내 위치로 이동 함수
    // ────────────────────────────────
    function moveToMyLoc(){
      if(!navigator.geolocation){
        alert('브라우저가 위치 기능을 지원하지 않습니다.');
        return;
      }
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude,longitude} = pos.coords;
        const latlng = new naver.maps.LatLng(latitude,longitude);
        map.setCenter(latlng);
        map.setZoom(15);

        // 파란 원형 마커
        if(myMarker) myMarker.setMap(null);
        myMarker = new naver.maps.Marker({
          position: latlng,
          map: map,
          icon: {
            content: '<div style="width:14px;height:14px;border:3px solid #007bff;border-radius:50%;background:#fff"></div>'
          }
        });
      },()=>{
        alert('위치 권한을 허용해주세요.');
      });
    }

    // 최초 버튼 바인딩
    document.getElementById('locBtn').onclick = moveToMyLoc;

    // ────────────────────────────────
    // 4) Firestore 실시간 스냅샷 & 렌더링
    // ────────────────────────────────
    const $list = document.getElementById('list');

    db.collection('stores')
      .orderBy('created','desc')
      .onSnapshot(snapshot=>{
        // 1) 리스트와 마커 초기화
        $list.innerHTML = '<h3>준비하세요</h3><button id="locBtn">내 위치로 이동</button>';
        document.getElementById('locBtn').onclick = moveToMyLoc;
        clearMarkers();

        // 2) 각 문서 마커 + 리스트 생성
        snapshot.docs.forEach(doc => {
          const s = doc.data();
          const lat = parseFloat(s.lat), lng = parseFloat(s.lng);
          if(isNaN(lat)||isNaN(lng)) return;

          // 마커
          const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(lat,lng),
            map: map
          });
          markers.push(marker);

          // 정보창
          const info = new naver.maps.InfoWindow({
            content: `
              <div style="min-width:160px;padding:6px">
                <strong>${s.name}</strong><br>
                <a href="https://instagram.com/${s.insta}" target="_blank">@${s.insta}</a><br>
                ${s.desc||''}
              </div>`
          });
          naver.maps.Event.addListener(marker,'click',()=> info.open(map,marker));

          // 사이드 리스트 아이템
          const div = document.createElement('div');
          div.className = 'store';
          div.innerHTML = `<strong>${s.name}</strong><br>@${s.insta}`;
          div.onclick = () => {
            map.setCenter(marker.getPosition());
            map.setZoom(15);
            info.open(map,marker);
          };
          $list.appendChild(div);
        });
      });
  </script>
</body>
</html>
