<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <!-- ë‹¤í¬ ëª¨ë“œ ë¹„ì§€ì› ëª…ì‹œ -->
  <meta name="color-scheme" content="light">
  <!-- CSS ë ˆë²¨ì—ì„œë„ ê°•ì œ light ëª¨ë“œ -->
  <style>
    html { color-scheme: light; }
  </style>  
  <link rel="stylesheet" href="style.css" />
  <title>ì €ì¥ëœ ë§¤  ì¥ ëª©ë¡</title>

  <!-- Pretendard í°íŠ¸ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />

  <!-- Naver Maps SDK -->
  <script defer src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=qpbrmxiff4"></script>
  <script src="https://openapi.map.naver.com/openapi/v3/markerclusterer.js"></script>
  <!-- Firebase SDK (compat) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
  :root{
    --primary:#0F9ED5; --primary-dark:#0E2841; --bg:#FFF; --text:#222; --muted:#666;
    --radius:14px;
  }
  *{box-sizing:border-box;font-family:"Pretendard",system-ui,sans-serif;margin:0;padding:0}
  html, body {
    width: 100%;
    height: 100%;
    min-height: 100vh;
    background: var(--bg);
    color: var(--text);
    overflow: hidden;
    position: absolute;
    top: 0;
    left: 0;       
  }

  /* ì§€ë„ */
  #map{position:absolute;top:0;left:0;width:100vw;height:100vh;z-index:0}

  /* â‘  íƒ€ì´í‹€å…¼ë‚´ìœ„ì¹˜ ë²„íŠ¼(Pill) */
  #titleBtn{
    position:fixed;top:12px;left:50%;transform:translateX(-50%);
    padding:10px 30px;background:var(--bg);border-radius:40px;z-index:1003;
    box-shadow:0 2px 8px rgba(0,0,0,.12);text-align:center;cursor:pointer;
  }
  #titleBtn b{display:block;font-size:15px;letter-spacing:-.3px}
  #titleBtn span{font-size:12px;color:var(--muted)}

  /* â”€â”€â”€ drawer (ë‹«íŒ ìƒíƒœì—ì„œë§Œ ë³´ì´ëŠ” ì†ì¡ì´ ë°”) â”€â”€â”€ */
  #drawer{
    position:fixed;left:0;right:0;bottom:env(safe-area-inset-bottom, 0);z-index:1001;
    height:48px;display:flex;flex-direction:column;align-items:center;justify-content:center;
    background:var(--bg);box-shadow:0 -1px 6px rgba(0,0,0,.12);
    cursor:pointer;user-select:none;transition:transform .25s;
  }
  #drawer .handle{
    width:38px;height:4px;border-radius:3px;background:#ccc;margin-bottom:6px;
  }
  #drawer span{font-size:13px;color:var(--muted)}
  #drawer.hide{transform:translateY(100%);}  /* íŒ¨ë„ ì—´ë¦´ ë•Œ drawer ìˆ¨ê¹€ */

  /* â”€â”€â”€ íŒ¨ë„ ìœ„ì¹˜Â·ì• ë‹ˆë©”ì´ì…˜ ë³€ê²½ â”€â”€â”€ */
  #panel{
    position:fixed;left:0;right:0;bottom:-50%;height:50vh;z-index:1002;
    background:var(--bg);border-top-left-radius:var(--radius);border-top-right-radius:var(--radius);
    box-shadow:0 -4px 8px rgba(0,0,0,.15);transition:bottom .25s;
    display:flex;flex-direction:column;padding-top:8px;
  }

  /* ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ (ê¸°ì¡´) */

  #panel.open{bottom:0}
  #panel .handle{width:38px;height:4px;border-radius:3px;background:#ccc;margin:0 auto 12px}
  #list{flex:1;overflow-y:auto;padding:0 12px 20px;display:flex;flex-direction:column;gap:12px}
  .card{
    display:flex;gap:12px;padding:12px;background:#F9F9F9;border-radius:var(--radius);
    align-items:center;cursor:pointer;transition:background .15s;
  }
  .card:hover{background:#EEF8FF}
  .card img{width:64px;height:64px;border-radius:8px;object-fit:cover;flex-shrink:0;background:#DDD}
  .meta{flex:1;font-size:14px;min-width:0}
  .meta b{display:block;font-size:15px;margin-bottom:2px;white-space:normal;overflow:visible;text-overflow:clip}
  .meta span{color:var(--muted);font-size:13px;white-space:normal;overflow:visible;text-overflow:clip}


  /* â‘¡ ë§ˆì»¤ í´ë¦­ ì‹œ í‘œì‹œë˜ëŠ” í•˜ë‹¨ ì¹´ë“œ */
/* ì¹´ë“œ ì „ì²´ (í•˜ë‹¨ ì˜¤ë²„ë ˆì´)  â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #infoCard{
    position:fixed;left:12px;right:12px;bottom:-320px;z-index:1002;
    display:flex;align-items:flex-start;gap:14px;
    padding:14px 16px;background:var(--bg);
    border-radius:18px;                /* â¬†ï¸ ì‹œì•ˆê³¼ ê°™ì€ í° ë¼ìš´ë“œ */
    box-shadow:0 8px 16px rgba(0,0,0,.25);  /* â†˜ï¸ ë°©í–¥ì˜ ë‘í„°ìš´ ê·¸ë¦¼ì */
    transition:bottom .25s ease;
  }

  /* ì¹´ë“œê°€ ì—´ë ¸ì„ ë•Œ ìœ„ì¹˜ (FAB ìœ„ ê°„ê²©) */
  #infoCard.show{bottom:96px}

  /* ì´ë¯¸ì§€ ì˜ì—­ â”€â”€â”€ */
  #infoCard img{
    width:96px;height:96px;            /* ì‹œì•ˆ ë¹„ìœ¨ */
    border-radius:14px;                /* ëª¨ì„œë¦¬ ë™ì¼ */
    object-fit:cover;                  /* â€œê½‰ ì°¨ê²Œâ€ */
    flex-shrink:0;
  }

  /* í…ìŠ¤íŠ¸ ë©”íƒ€ */
  #infoCard .meta{flex:1;min-width:0;font-size:14px;line-height:1.35}
  #infoCard .meta b{display:block;font-size:15px;margin-bottom:2px;white-space:normal;overflow:visible;text-overflow:clip}
  #infoCard .meta span{color:var(--muted);font-size:13px;white-space:normal;overflow:visible;text-overflow:clip}
  /* ëª¨ë‹¬ ë°±ê·¸ë¼ìš´ë“œ (Flex ì¤‘ì•™ ì •ë ¬) */
  #videoModal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }

  /* ë‹«ê¸° ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨) */
  #closeVideo {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 50%;
    width: 32px; height: 32px;
    font-size: 18px;
    line-height: 1;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    z-index: 1;
  }
  @supports not (aspect-ratio: 1 / 1) {
    #videoModal .modal-content {
      /* 'ì„¸ë¡œ 9:16' ë¹„ìœ¨ì„ width ë¡œ ê³„ì‚° */
      width: calc(90vh * (9 / 16));
      height: 90vh;
      max-width: 90vw;
    }
  }
  #videoModal .modal-content {
    position: relative;
    height: 90vh;
    aspect-ratio: 9 / 16;
    max-width: 90vw;
    /* ì•„ë˜ ë‘ ì¤„ì„ ì¶”ê°€ */
    border-radius: 16px;
    overflow: hidden;
  }

  /* iframe (í’€ì‚¬ì´ì¦ˆ) */
  #videoModal iframe {
    width: 100%;
    height: 100%;
    border: 0;
    /* ì˜µì…˜: iframe ìì²´ì— ë¼ìš´ë“œë„ ì£¼ë ¤ë©´ ì•„ë˜ ì¶”ê°€ */
    border-radius: 16px;
  }
  /* ëª¨ë°”ì¼ í™”ë©´(ë„ˆë¹„ 600px ì´í•˜)ì—ì„œ ë†’ì´Â·ì—¬ë°± ì¡°ê¸ˆ ì¡°ì • */
  @media (max-width: 600px) {
  #videoModal .modal-content {
    height: 85vh;
  }
  #titleBtn {
    padding: 8px 24px;
    font-size: 14px;
  }
}
  /* InfoCard ë‚´ ë¹„ë””ì˜¤ ì—¬ë¶€ íƒœê·¸ (íƒ€ì´í‹€ ìœ„) */
  #infoCard .tag {
    display: inline-block;
    padding: 2px 8px;
    margin-bottom: 6px;
    font-size: 12px;
    font-weight: 500;
    border-radius: 12px;
    /* ê¸°ë³¸ì€ íˆ¬ëª… ë°°ê²½ */
    background: transparent;
  }

  /* ë¹„ë””ì˜¤ ìˆì„ ë•Œ: íŒŒë€ í…Œë‘ë¦¬Â·íŒŒë€ ê¸€ì”¨ */
  #infoCard .tag.video {
    border: 1px solid var(--primary);
    color: var(--primary);
    /* background: none; ì´ë¯¸ íˆ¬ëª… */
  }

  /* ë¹„ë””ì˜¤ ì—†ì„ ë•Œ: íšŒìƒ‰ í…Œë‘ë¦¬Â·íšŒìƒ‰ ê¸€ì”¨ */
  #infoCard .tag.no-video {
    border: 1px solid var(--muted);
    color: var(--muted);
  }
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  /* â‘¢: ì‚¬ì´ë“œ ë©”ë‰´ ìŠ¤íƒ€ì¼ ------------------------------------------------ */
  /* ì‚¬ì´ë“œ ë©”ë‰´ íŒ¨ë„ ì´ˆê¸° ìƒíƒœ: í™”ë©´ ì™¼ìª½ ë°–ìœ¼ë¡œ ìˆ¨ê¹€ */
  #sideMenu {
    position: fixed;
    top: 0;
    left: 0;
    width: 240px;               /* ë©”ë‰´ ë„ˆë¹„ */
    height: 100%;
    background: var(--bg);      /* ê¸°ì¡´ ë³€ìˆ˜ ì‚¬ìš© */
    box-shadow: 2px 0 8px rgba(0,0,0,0.15);
    transform: translateX(-100%);
    transition: transform 0.25s ease;
    z-index: 3000;              /* ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ ìœ„ì— ë³´ì´ë„ë¡ ì¶©ë¶„íˆ ë†’ê²Œ */
    padding-top: 60px;          /* ë©”ë‰´ í•­ëª© ìœ„ ì—¬ìœ  ê³µê°„ (ë²„íŠ¼ ì•„ë˜ ê°„ê²©) */
    overflow-y: auto;
  }

  /* ë©”ë‰´ê°€ ì—´ë¦° ìƒíƒœì¼ ë•Œ translateX(0) */
  #sideMenu.open {
    transform: translateX(0);
  }

  /* ë©”ë‰´ ë‚´ë¶€ ulÂ·li ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
  #sideMenu ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 16px; 
  }

  /* ë©”ë‰´ ë§í¬ ìŠ¤íƒ€ì¼ */
  #sideMenu a {
    display: block;
    padding: 12px 20px;
    font-size: 16px;
    color: var(--text);
    text-decoration: none;
    border-radius: 6px;
    transition: background 0.15s;
  }
  #sideMenu a:hover {
    background: rgba(0,0,0,0.04);
  }

  /* â‘£: ë©”ë‰´ ì—´ê¸°/ë‹«ê¸° ë²„íŠ¼ (Ã—) */
  #menuBtn {
    position: fixed;
    top: 12px;
    left: 12px;
    z-index: 3100;            /* sideMenuë³´ë‹¤ ë” ìœ„ì— ë„ìš°ê¸° */
    width: 32px;
    height: 32px;
    background: var(--bg);
    border: 1px solid var(--muted);
    border-radius: 50%; 
    font-size: 20px;
    line-height: 1;
    color: var(--text);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transition: background 0.15s, transform 0.15s;
  }
  #menuBtn:hover {
    background: #f5f5f5;
  }
  #menuBtn.open {               /* ë©”ë‰´ ì—´ë ¤ ìˆì„ ë•Œ ë²„íŠ¼ íšŒì „ íš¨ê³¼ (ì„ íƒì‚¬í•­) */
    transform: rotate(90deg);
  }
  #panel {
  touch-action: none;
  }
  #myPageBtn {
    position: fixed;
    top: 12px;
    right: 12px;
    width: 48px;
    height: 48px;
    background: var(--bg);
    border: none;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1003;
    padding: 0;
  }

  #myPageBtn img {
    width: 24px;
    height: 24px;
  }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

</style>
</head>
<body>
  <!-- ì§€ë„ -->
  <div id="map"></div>

  <!-- â‘  íƒ€ì´í‹€å…¼ë‚´ìœ„ì¹˜ -->
  <div id="titleBtn" aria-label="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">
    <b>2ì°¨ ì–´ë””ê°€?</b>
    <span>íƒ­í•˜ë©´ ë‚´ ì£¼ë³€ìœ¼ë¡œ ì´ë™</span>
  </div>
  <!-- â‘  FAB ë²„íŠ¼ ë¸”ë¡ ì‚­ì œ  (ê¸°ì¡´ <button id="fab">â€¦</button>) -->
  <!-- ë§ˆì´í˜ì´ì§€ ë²„íŠ¼ -->
  <button id="myPageBtn" aria-label="ë§ˆì´í˜ì´ì§€ ì´ë™">
    <img src="/images/store.svg" alt="ë§ˆì´í˜ì´ì§€" />
  </button>

  <!-- ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ -->
  <div id="panel" aria-label="ë§¤ì¥ ë¦¬ìŠ¤íŠ¸">
    <div class="handle"></div>
    <ul id="list"></ul>
  </div>

  <!-- â‘¡ drawer(ì†ì¡ì´ ë°”) ì¶”ê°€ â€“ #panel ë°”ë¡œ ì•„ë˜ ë„£ì–´ì£¼ì„¸ìš” -->
  <div id="drawer">
    <div class="handle"></div>
    <span id="storeCnt">ë§¤ì¥ 0ê°œ</span>
  </div>

  <!-- â‘¡ ë§ˆì»¤ í´ë¦­ ì‹œ í•˜ë‹¨ ì¹´ë“œ -->
  <div id="infoCard">
    <img id="infoImg" src="" alt="">
    <div class="meta">
     <div id="infoTopRow" style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
        <span id="infoTag" class="tag"></span>
        <a id="infoInsta" href="#" target="_blank" style="color: var(--primary); text-decoration: none;"></a>
      </div>
      <span id="infoHash" style="color: var(--muted); font-size: 13px; margin-bottom: 4px; display: block;"></span>
      <b id="infoName"></b>
      <span id="infoDesc"></span>
    </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ JS â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <script>
document.addEventListener('DOMContentLoaded', () => {
  /* Firebase ì´ˆê¸°í™” */
  firebase.initializeApp({
    apiKey: "AIzaSyCVV1XUfsREQYnah3tbEKBTprgq9wRgiic",
    authDomain: "instamap-9b595.firebaseapp.com",
    projectId: "instamap-9b595",
    storageBucket: "instamap-9b595.firebasestorage.app",
    messagingSenderId: "280950399393",
    appId: "1:280950399393:web:8282e0d352e50c8bcd2be0",
  });
  const db = firebase.firestore();

  // ë©”ë‰´ ë§í¬ ì´ë²¤íŠ¸ ì„¤ì •
  document.getElementById('linkHome')?.addEventListener('click', e => {
    e.preventDefault();
    window.location.href = 'https://inwave.ai.kr/';
  });
  document.getElementById('linkAdwave')?.addEventListener('click', e => {
    e.preventDefault();
    window.location.href = 'https://inwave.ai.kr/adwave1.html';
  });
  document.getElementById('linkWaveshare')?.addEventListener('click', e => {
    e.preventDefault();
    window.location.href = 'https://inwave.ai.kr/waveshare.html';
  });
  document.getElementById('linkInvest')?.addEventListener('click', e => {
    e.preventDefault();
    window.location.href = 'https://inwave.ai.kr/invest.html';
  });
  document.getElementById('linkSupport')?.addEventListener('click', e => {
    e.preventDefault();
    window.location.href = 'https://inwave.ai.kr/privacy_policy.html';
  });

  // âœ… ë§ˆì´í˜ì´ì§€ ë²„íŠ¼ ì´ë²¤íŠ¸ëŠ” ì—¬ê¸°ì—ì„œ ë‹¨ 1ë²ˆë§Œ ë“±ë¡
  const myPageBtn = document.getElementById('myPageBtn');
  if (myPageBtn) {
    myPageBtn.addEventListener('click', () => {
      window.location.href = 'https://inwave.ai.kr/mypage.html';
    });
  }

  /* ì§€ë„ ìƒì„± */
  const map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(37.4880158, 126.8119221),
    zoom: 12
  });

  // ì¤Œ ë³€ê²½ ì‹œ ì²˜ë¦¬ (ì¤‘ë³µ ì´ë²¤íŠ¸ ë“±ë¡ ì—†ì´ ê¹”ë”í•˜ê²Œ)
  let currentZoom = map.getZoom();
  naver.maps.Event.addListener(map, 'zoom_changed', () => {
    const newZoom = map.getZoom();
    if ((currentZoom < 13 && newZoom >= 13) ||
        (currentZoom >= 13 && newZoom < 13)) {
      renderStores();
    }
    currentZoom = newZoom;
  });

  /* ì»¤ìŠ¤í…€ ë§ˆì»¤ */
  const markerIcon = {
    content: '<div style="width:18px;height:18px;background:var(--primary);border:3px solid #fff;border-radius:50%;box-shadow:0 0 0 2px rgba(0,0,0,.15)"></div>',
    size: new naver.maps.Size(24, 24),
    anchor: new naver.maps.Point(12, 12)
  };
    // â”€â”€â”€ 1ë²ˆ: markerIcon ì„ ì–¸ ë°”ë¡œ ë‹¤ìŒì— ì¶”ê°€ â”€â”€â”€

    // "HH:mm" ë¬¸ìì—´ â†’ ì´ ë¶„(0~1439) ë°˜í™˜
    function toMinutes(hhmm) {
      if (!hhmm) return null;
      const [h, m] = hhmm.split(':').map(Number);
      return h * 60 + m;
    }

    // â”€â”€â”€ 1ë²ˆ: markerIcon ì„ ì–¸ ë°”ë¡œ ë‹¤ìŒì— ì¶”ê°€ â”€â”€â”€
    function createMarkerIconWithText(text) {
      return {
        content: `
          <div style="
            position: relative;
            transform: translate(-50%, -100%);
            background: #fff;
            color: #222;
            padding: 4px 10px;
            border: 2px solid #fff;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,.12);
            font-size: 12px;
            white-space: nowrap;
          ">
            ${text}
          </div>
        `,
        size: new naver.maps.Size(0, 0),
        anchor: new naver.maps.Point(0, 0)
      };
    }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /* DOM ìºì‹œ */
    const listEl   = document.getElementById('list');
    const infoCard = document.getElementById('infoCard');
    const infoImg  = document.getElementById('infoImg');
    const infoName = document.getElementById('infoName');
    const infoInsta= document.getElementById('infoInsta');
    const infoDesc = document.getElementById('infoDesc');
    const storeCnt = document.getElementById('storeCnt');   // ë§¤ì¥ ìˆ˜ í…ìŠ¤íŠ¸
    // ëª¨ë‹¬ ìš”ì†Œ ìºì‹œ
    const videoModal = document.getElementById('videoModal');
    const videoFrame = document.getElementById('videoFrame');
    const closeVideo = document.getElementById('closeVideo');

    // ì´ë¯¸ì§€ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
    infoImg.style.cursor = 'pointer';
    infoImg.addEventListener('click', () => {
      const url = infoImg.dataset.videoUrl;
      if (!url) return alert('ë“±ë¡ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤');
      // ê³µí†µ íŒŒë¼ë¯¸í„°
      const params = 'autoplay=1&muted=1&playsinline=1';
      // ê¸°ì¡´ URLì— ë¶™ì¼ êµ¬ë¶„ì ê²°ì •
      const sep = url.includes('?') ? '&' : '?';
      // ìµœì¢… ì¬ìƒ URL
      videoFrame.src = url + sep + params;

      videoModal.style.display = 'flex';
      videoModal.setAttribute('aria-hidden', 'false');
    });

    // ëª¨ë‹¬ ë‹«ê¸°
    function hideVideoModal(){
      videoFrame.src = '';
      videoModal.style.display = 'none';
      videoModal.setAttribute('aria-hidden', 'true');
    }
    closeVideo.addEventListener('click', hideVideoModal);
    videoModal.addEventListener('click', e => {
      if (e.target === videoModal) hideVideoModal();
    });

    let markers=[]; let selectedMarker=null;

    let isRendering = false; // ğŸ”¹ [ì¶”ê°€] ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ìš© í”Œë˜ê·¸

async function renderStores() {
  if (isRendering) return;
  isRendering = true;

  console.log('â–¶ï¸ renderStores í˜¸ì¶œë¨');

  const zoom = map.getZoom();
  const useOffset = zoom < 13;
  markers.forEach(m => m.setMap(null));
  markers.length = 0;
  listEl.innerHTML = '';

  const now = new Date();
  const dayMap = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  const todayStr   = dayMap[now.getDay()];
  const nowMinutes = now.getHours() * 60 + now.getMinutes();

  const bounds = map.getBounds();

  const snap = await db.collection('stores')
                       .orderBy('created','desc')
                       .get();

  const bucket = new Map();
  snap.forEach(doc => {
    const d = doc.data();
    const { lat, lng } = d;
    if (typeof lat !== 'number' || typeof lng !== 'number') return;
    const key = `${lat.toFixed(6)}_${lng.toFixed(6)}`;
    if (!bucket.has(key)) bucket.set(key, []);
    bucket.get(key).push(d);
  });

  let visibleCount = 0;

  bucket.forEach((items, key) => {
    const [someLat, someLng] = key.split('_').map(v => parseFloat(v));
    const centerPos = new naver.maps.LatLng(someLat, someLng);
    if (!bounds.hasLatLng(centerPos)) return;

    const groupSize = items.length;
    const baseRadius = 0.001;

    items.forEach((data, idx) => {
      const {
        lat, lng, name, insta, desc, photo, vimeo, hashtags,
        offDays, hours, break: breakTimes
      } = data;

      if (Array.isArray(offDays) && offDays.includes(todayStr)) return;

      // âœ… ìš”ì¼ë³„ ì˜ì—…ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
      const todayHours = (hours && hours[todayStr] && hours[todayStr].time) || {};
      const openTime = todayHours.start;
      const closeTime = todayHours.end;
      
      if (!openTime || !closeTime) return;
      
      const openMin  = toMinutes(openTime);
      const closeMin = toMinutes(closeTime);
      
      let isOpen;
      
      // 1) ë§ˆê°ì‹œê°„ì´ ìì •(1440ë¶„) ë„˜ì–´ê°€ë©´ ìµì¼ ë§ˆê°ìœ¼ë¡œ ì²˜ë¦¬
      if (closeMin > 1440) {
        const adjClose = closeMin - 1440;  // ì˜ˆ: 27:00 â†’ 1620ë¶„, 1620âˆ’1440 = 180ë¶„(ìµì¼ 03:00)
        isOpen = nowMinutes >= openMin   // ì˜¤ëŠ˜ ì˜¤í”ˆ ì´í›„
              || nowMinutes <  adjClose;  // ìµì¼ ë§ˆê° ì „
      }
      // 2) ì •ìƒì ì¸ ë‹¹ì¼ ë§ˆê°
      else if (closeMin > openMin) {
        isOpen = nowMinutes >= openMin && nowMinutes < closeMin;
      // 3) (ê²½ìš°ê°€ í¬ë°•í•˜ì§€ë§Œ) closeMin â‰¤ openMin ì¸ ê²½ìš°
      } else {
        isOpen = nowMinutes >= openMin || nowMinutes < closeMin;
      }
      
      if (!isOpen) return;

      
      // ë¸Œë ˆì´í¬ íƒ€ì„
      const breakStart = breakTimes?.[todayStr]?.start;
      const breakEnd   = breakTimes?.[todayStr]?.end;
      if (breakStart && breakEnd) {
        const bs = toMinutes(breakStart);
        const be = toMinutes(breakEnd);
        if (nowMinutes >= bs && nowMinutes < be) return;
      }


      let newLat = lat;
      let newLng = lng;
      if (useOffset && groupSize > 1) {
        const angleDeg = (360 / groupSize) * idx;
        const angleRad = angleDeg * Math.PI / 180;
        const offsetLat = baseRadius * Math.cos(angleRad);
        const offsetLng = baseRadius * Math.sin(angleRad);
        newLat = lat + offsetLat;
        newLng = lng + offsetLng;
      }

      const position = new naver.maps.LatLng(newLat, newLng);
      if (!bounds.hasLatLng(position)) return;
      visibleCount++;

      let tagText = "";
      if (Array.isArray(hashtags) && hashtags.length > 0) {
        tagText = hashtags[0];
      }
      const customIcon = createMarkerIconWithText(tagText);

      const marker = new naver.maps.Marker({
        position,
        map,
        icon: customIcon
      });
      markers.push(marker);

      function openStore() {
        map.setCenter(new naver.maps.LatLng(lat, lng));
        map.setZoom(20);
        showInfoCard({ name, insta, desc, thumbnail: photo, videoUrl: vimeo, hashtags });
      }

      naver.maps.Event.addListener(marker, 'click', openStore);

      const li = document.createElement('li');
      li.className = 'card';
      li.innerHTML = `
        <img src="${photo||''}" alt="">
        <div class="meta">
          <b>${name}</b>
          <span>@${insta}</span><br>
          <span>${desc||''}</span>
        </div>`;
      li.addEventListener('click', openStore);
      listEl.appendChild(li);
    });
  });

  storeCnt.textContent = `ë§¤ì¥ ${visibleCount}ê°œ`;
  storeCnt.innerText   = `ë§¤ì¥ ${visibleCount}ê°œ`;
  setTimeout(() => {
    storeCnt.style.display = 'block';
  }, 50);

  isRendering = false;
}

    // ë§µì´ ì›€ì§ì¼ ë•Œë§ˆë‹¤ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
    naver.maps.Event.addListener(map, 'idle', renderStores);
    renderStores();

  function showInfoCard(d) {
    infoImg.src = d.thumbnail || '';
    infoImg.dataset.videoUrl = d.videoUrl || '';

    // 1. VIDEO ë§ˆí¬
    const tag = document.getElementById('infoTag');
    if (d.videoUrl) {
      tag.textContent = 'VIDEO';
      tag.classList.add('video');
      tag.classList.remove('no-video');
    } else {
      tag.textContent = 'VIDEO';
      tag.classList.add('no-video');
      tag.classList.remove('video');
    }

    // 2. ì¸ìŠ¤íƒ€ê·¸ë¨ ID
    const instaLink = document.getElementById('infoInsta');
    instaLink.textContent = `@${d.insta}`;
    instaLink.href = `https://instagram.com/${d.insta}`;

    // 3. í•´ì‹œíƒœê·¸ (ì²« ë²ˆì§¸)
    const hash = Array.isArray(d.hashtags) && d.hashtags.length > 0 ? d.hashtags[0] : '';
    document.getElementById('infoHash').textContent = hash;

    // 4. ì´ë¦„ê³¼ ì„¤ëª…
    infoName.textContent = d.name;
    infoDesc.textContent = d.desc || '';

    infoCard.classList.add('show');
    updateInfoCardPosition();
  }

    window.moveToLocation = function(lat, lng) {
    const latlng = new naver.maps.LatLng(lat, lng);
    map.setCenter(latlng);
    map.setZoom(18);
    new naver.maps.Marker({ position: latlng, map, icon: markerIcon });
    hideInfoCard();
  };
    function hideInfoCard(){
      infoCard.classList.remove('show');
      // â”€â”€ íŒì—…ì¹´ë“œë¥¼ í™”ë©´ ì•„ë˜(ìˆ¨ê¹€) ìœ„ì¹˜ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤ â”€â”€
      infoCard.style.bottom = '-320px';
    }
    /* ì§€ë„ ì•„ë¬´ ê³³ í´ë¦­í•˜ë©´ ì¹´ë“œ ë‹«ê¸°(InfoCard) + íŒ¨ë„ì´ ì—´ë ¤ ìˆìœ¼ë©´ ë‹«ê¸° */
    naver.maps.Event.addListener(map, 'click', () => {
    // 1) InfoCard ë‹«ê¸°
    hideInfoCard();
     // 2) íŒ¨ë„ì´ ì—´ë ¤ ìˆìœ¼ë©´ togglePanel() í˜¸ì¶œ
    if (panelOpen) {
      togglePanel();
    }
  });
    /* íƒ€ì´í‹€å…¼ë‚´ìœ„ì¹˜ ë²„íŠ¼ */
    document.getElementById('titleBtn').addEventListener('click',()=>{
      if(!navigator.geolocation) return alert('GeoLocation ë¯¸ì§€ì› ë¸Œë¼ìš°ì €');
      navigator.geolocation.getCurrentPosition(p=>{
        const {latitude,longitude}=p.coords;
        const latlng=new naver.maps.LatLng(latitude,longitude);
        map.setCenter(latlng); map.setZoom(18);
        new naver.maps.Marker({position:latlng,map,icon:markerIcon});
        hideInfoCard();            // ìœ„ì¹˜ ì´ë™ ì‹œ ì—´ë¦° ì¹´ë“œ ë‹«ê¸°
        // âœ… ì—¬ê¸° â†“ ì¶”ê°€í•˜ì„¸ìš”!
        setTimeout(() => {
          naver.maps.Event.trigger(map, 'resize');
        }, 200);
      },()=>alert('ìœ„ì¹˜ ê¶Œí•œ í•„ìš”'));
    });

    /* drawer â†” íŒ¨ë„ í† ê¸€ --------------------- */
    const panel    = document.getElementById('panel');
    const drawer   = document.getElementById('drawer');

    let panelOpen  = false;

    function togglePanel(){
    panelOpen = !panelOpen;
    panel.classList.toggle('open',  panelOpen);  // íŒ¨ë„ ìŠ¬ë¼ì´ë“œ
    drawer.classList.toggle('hide', panelOpen);  // drawer ìˆ¨ê¹€/í‘œì‹œ
    updateInfoCardPosition();
    }

    /* drawer ë°” ìì²´ë¥¼ íƒ­í•˜ë©´ ì—´ê³  ë‹«ê¸° */
    drawer.addEventListener('click', togglePanel);
    /* íŒ¨ë„ ìƒë‹¨ handle(ì²« ë²ˆì§¸ div.handle) íƒ­í•´ì„œë„ ë‹«ê¸° */
    panel.querySelector('.handle').addEventListener('click', togglePanel);
    /**
     * ìŠ¬ë¼ì´ë“œíŒ¨ë„(open/close) ìƒíƒœì— ë”°ë¼
     * íŒì—…ì¹´ë“œ(#infoCard)ì˜ bottom ê°’ì„ ë™ì ìœ¼ë¡œ ê³„ì‚°í•˜ì—¬ ì ìš©í•œë‹¤.
     */
    function updateInfoCardPosition() {
      // (1) íŒì—…ì¹´ë“œê°€ ì‹¤ì œë¡œ ë³´ì´ëŠ” ìƒíƒœì¸ì§€ í™•ì¸
      if (!infoCard.classList.contains('show')) {
        return;  // ë³´ì´ì§€ ì•ŠëŠ” ìƒíƒœë¼ë©´ ìœ„ì¹˜ ê³„ì‚° ì•ˆ í•¨
      }
        
  if (panelOpen) {
    // â”€â”€ â‘  íŒ¨ë„ì´ ì—´ë¦° ìƒíƒœ â”€â”€
    // íŒ¨ë„ì˜ ì‹¤ì œ ë†’ì´(px)ë¥¼ ê°€ì ¸ì˜¨ë‹¤
    const panelHeight = panel.offsetHeight;

    // ì¹´ë“œì™€ íŒ¨ë„ ì‚¬ì´ì— ë¶™ì¼ ì—¬ë°±(px)
    const gapBetween = 8;

    // íŒì—…ì¹´ë“œë¥¼ íŒ¨ë„ ìœ„ë¡œ ë„ìš°ê¸°
    infoCard.style.bottom = (panelHeight + gapBetween) + 'px';
  } else {
    // â”€â”€ â‘¡ íŒ¨ë„ì´ ë‹«íŒ ìƒíƒœ â”€â”€
    // í™”ë©´ ë°”ë‹¥ì—ì„œ ê³ ì •ìœ¼ë¡œ ë„ìš°ê³  ì‹¶ë˜ ê¸°ì¡´ ê°’ (ì˜ˆ: 96px)
    const defaultBottom = 96;
    infoCard.style.bottom = defaultBottom + 'px';
  }
}

    });
  </script>
  <!-- â†“ ì—¬ê¸°ê°€ ì‚¬ì´ë“œ ë©”ë‰´ í† ê¸€ ë¡œì§ì„ ë„£ì„ ìœ„ì¹˜ì…ë‹ˆë‹¤. â†“ -->
   
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* â”€â”€â”€ ì‚¬ì´ë“œ ë©”ë‰´ ì—´ê¸°/ë‹«ê¸° â”€â”€â”€ */
    const menuBtn = document.getElementById('menuBtn');
    const sideMenu = document.getElementById('sideMenu');
    let menuOpen = false;
  
    function toggleSideMenu() {
      menuOpen = !menuOpen;
      sideMenu.classList.toggle('open', menuOpen);
      menuBtn.classList.toggle('open', menuOpen);
      sideMenu.setAttribute('aria-hidden', menuOpen ? 'false' : 'true');
    }

    menuBtn?.addEventListener('click', toggleSideMenu);

    document.addEventListener('click', e => {
      if (menuOpen && !sideMenu.contains(e.target) && e.target !== menuBtn) {
        toggleSideMenu();
      }
    });

    /* â”€â”€â”€ ë“œë˜ê·¸ë¡œ íŒ¨ë„ ì—´ê³  ë‹«ê¸° â”€â”€â”€ */
    let startY = 0;
    let currentY = 0;
    let dragging = false;
    let threshold = 50;
    let initialPanelOpen = false;

    const panel = document.getElementById('panel');
    const drawer = document.getElementById('drawer');

    panel.addEventListener('touchstart', (e) => {
      if (e.touches.length > 1) return;
      startY = e.touches[0].clientY;
      currentY = startY;
      dragging = true;
      initialPanelOpen = panel.classList.contains('open');
      panel.style.transition = 'none';
    }, { passive: true });

    panel.addEventListener('touchmove', (e) => {
      if (!dragging || e.touches.length > 1) return;
      currentY = e.touches[0].clientY;
      const deltaY = currentY - startY;

      if (deltaY > 0 && initialPanelOpen) {
        panel.style.transform = `translateY(${deltaY}px)`;
      }
      if (deltaY < 0 && !initialPanelOpen) {
        panel.style.transform = `translateY(${deltaY}px)`;
      }

      e.preventDefault();
    }, { passive: false });

    panel.addEventListener('touchend', () => {
      if (!dragging) return;
      const deltaY = currentY - startY;
      panel.style.transition = '';
      panel.style.transform = '';
  
      if (Math.abs(deltaY) > threshold) {
        if (deltaY < 0 && !initialPanelOpen) {
          panelOpen = true;
          panel.classList.add('open');
          drawer.classList.add('hide');
        } else if (deltaY > 0 && initialPanelOpen) {
          panelOpen = false;
          panel.classList.remove('open');
          drawer.classList.remove('hide');
        }
        updateInfoCardPosition();
      }

      dragging = false;
    });
  });

  </script>
  <!-- â†‘ ì‚¬ì´ë“œ ë©”ë‰´ í† ê¸€ ë¡œì§ ë â†‘ -->

  <div id="videoModal" aria-hidden="true">
  <div class="modal-content">
    <button id="closeVideo" aria-label="ë‹«ê¸°">&times;</button>
    <iframe
      id="videoFrame"
      src=""
      frameborder="0"
      allow="autoplay; fullscreen"
      allowfullscreen
      playsinline
      webkit-playsinline
    ></iframe>
  </div>
</div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì—¬ê¸°ë¶€í„° ì‚¬ì´ë“œ ë©”ë‰´ ìš”ì†Œ ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

  <!-- â‘  ë©”ë‰´ ì—´ê¸°/ë‹«ê¸° ë²„íŠ¼ (Ã—) -->
  <!--
  <button id="menuBtn" aria-label="ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°">âœš</button>
  -->

  <!-- â‘¡ ì‚¬ì´ë“œ ë©”ë‰´ ë‚´ìš© -->
  <nav id="sideMenu" aria-hidden="true">
    <ul>
      <li><a href="#" id="linkHome">ì¸ì›¨ì´ë¸Œ</a></li>
      <li><a href="#" id="linkAdwave">ì• ë“œì›¨ì´ë¸Œ 1.0</a></li>
      <li><a href="#" id="linkWaveshare">ì›¨ì´ë¸Œì‰ì–´</a></li>
      <li><a href="#" id="linkInvest">íˆ¬ìë¼ìš´ì§€</a></li>
      <li><a href="#" id="linkSupport">ê³ ê°ì§€ì›</a></li>
    </ul>
  </nav>
<!-- âœ… ì´ ì•„ë˜ì— ì¶”ê°€í•´ì£¼ì„¸ìš” -->
  <script>
    window.addEventListener('message', async (event) => {
      try {
        const { type, token, email } = JSON.parse(event.data);
        if (type === 'LOGIN' && token) {
          const credential = firebase.auth.GoogleAuthProvider.credential(token);
          await firebase.auth().signInWithCredential(credential);
          console.log("âœ… Firebase ë¡œê·¸ì¸ ì„±ê³µ:", email);
        }
      } catch (err) {
        console.error("âŒ WebView ë¡œê·¸ì¸ ì‹¤íŒ¨:", err);
      }
    });
  </script>
</body>
