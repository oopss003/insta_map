<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ÏΩîÎìú ÎπÑÍµê Î∞è Ï†ÄÏû• ÎèÑÍµ¨</title>
  <style>
    body {
      font-family: 'Pretendard', monospace;
      padding: 20px;
      background: #f4f4f4;
    }

    .top-bar {
      margin-bottom: 12px;
    }

    .top-bar input {
      padding: 8px;
      width: 200px;
    }

    .top-bar button, select {
      padding: 8px 14px;
      margin-left: 5px;
      font-weight: bold;
    }

    .container {
      display: flex;
      gap: 10px;
    }

    .editor-wrapper {
      display: flex;
      width: 48%;
      height: 250px;
      border: 1px solid #ccc;
      background: white;
      font-family: monospace;
    }

    .line-numbers {
      width: 40px;
      background: #eee;
      text-align: right;
      padding: 10px 4px;
      color: #888;
      user-select: none;
      overflow: hidden;
      line-height: 1.4em;
      white-space: pre-wrap;
    }

    textarea {
      flex: 1;
      border: none;
      resize: none;
      font-size: 14px;
      padding: 10px;
      line-height: 1.4em;
      outline: none;
      overflow: auto;
    }

    .diff-result {
      margin-top: 20px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      font-family: monospace;
      white-space: pre-wrap;
    }

    .added {
      background-color: #ddffdd;
    }

    .removed {
      background-color: #ffdddd;
    }

    .line-number {
      color: gray;
      display: inline-block;
      width: 40px;
      text-align: right;
      margin-right: 8px;
      user-select: none;
    }

    .copy-button-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .copy-button-wrapper button {
      font-size: 20px;
      padding: 8px 12px;
      cursor: pointer;
    }

    mark.add {
      background-color: #aaffaa;
      color: #060;
    }

    mark.del {
      background-color: #ffcccc;
      color: #900;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <input type="text" id="codeName" placeholder="ÏΩîÎìú Ïù¥Î¶Ñ ÏûÖÎ†• (Ïòà: ÏΩîÎìú1)">
    <button onclick="compareCode()">üîç Î∂ÑÏÑù</button>
    <button onclick="saveCode()">üíæ Ï†ÄÏû•</button>
    <button onclick="loadSavedCodes()">üìÇ Ï†ÄÏû•Îêú ÏΩîÎìú Î∂àÎü¨Ïò§Í∏∞</button>
    <select id="codeSelect"></select>
    <button onclick="exportCodeToFile()">üì• ÌååÏùºÎ°ú Ï†ÄÏû•</button>
  </div>

  <div class="container">
    <!-- Ïù¥Ï†Ñ ÏΩîÎìú -->
    <div class="editor-wrapper">
      <pre class="line-numbers" id="oldLineNumbers">1</pre>
      <textarea id="oldCode" oninput="updateLineNumbers('oldCode', 'oldLineNumbers')" onscroll="syncScroll('oldCode','oldLineNumbers')" placeholder="Ïù¥Ï†Ñ ÏΩîÎìú ÏûÖÎ†•"></textarea>
    </div>

    <!-- ‚Üê Î≤ÑÌäº -->
    <div class="copy-button-wrapper">
      <button onclick="copyNewToOld()">‚Üê</button>
    </div>

    <!-- Ïã†Í∑ú ÏΩîÎìú -->
    <div class="editor-wrapper">
      <pre class="line-numbers" id="newLineNumbers">1</pre>
      <textarea id="newCode" oninput="updateLineNumbers('newCode', 'newLineNumbers')" onscroll="syncScroll('newCode','newLineNumbers')" placeholder="Ïã†Í∑ú ÏΩîÎìú ÏûÖÎ†•"></textarea>
    </div>
  </div>

  <div id="diffOutput" class="diff-result"></div>

  <!-- diff-match-patch ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
  <script src="https://cdn.jsdelivr.net/npm/diff-match-patch@1.0.5/index.min.js"></script>

  <script>
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function pad(n) {
      return n.toString().padStart(2, '0');
    }

    function updateLineNumbers(textareaId, lineNumberId) {
      const textarea = document.getElementById(textareaId);
      const lineNumberDiv = document.getElementById(lineNumberId);
      const lineCount = textarea.value.split('\n').length;
      let lines = '';
      for (let i = 1; i <= lineCount; i++) {
        lines += i + '\n';
      }
      lineNumberDiv.textContent = lines;
    }

    function syncScroll(textareaId, lineNumberId) {
      const textarea = document.getElementById(textareaId);
      const lineNumberDiv = document.getElementById(lineNumberId);
      lineNumberDiv.scrollTop = textarea.scrollTop;
    }

    function compareCode() {
      const oldCode = document.getElementById("oldCode").value.trim().split('\n');
      const newCode = document.getElementById("newCode").value.trim().split('\n');

      const maxLines = Math.max(oldCode.length, newCode.length);
      let resultHTML = "";
      const dmp = new diff_match_patch();

      for (let i = 0; i < maxLines; i++) {
        const oldLine = oldCode[i] || "";
        const newLine = newCode[i] || "";
        const lineNum = `<span class="line-number">${i + 1}</span>`;

        if (oldLine === newLine) {
          resultHTML += `${lineNum}${escapeHtml(newLine)}\n`;
        } else if (!oldLine && newLine) {
          resultHTML += `<span class="added">${lineNum}${escapeHtml(newLine)}</span>\n`;
        } else if (oldLine && !newLine) {
          resultHTML += `<span class="removed">${lineNum}${escapeHtml(oldLine)}</span>\n`;
        } else {
          const diffs = dmp.diff_main(oldLine, newLine);
          dmp.diff_cleanupSemantic(diffs);

          let oldLineHtml = "";
          let newLineHtml = "";

          for (const [op, data] of diffs) {
            const escaped = escapeHtml(data);
            if (op === 0) {
              oldLineHtml += escaped;
              newLineHtml += escaped;
            } else if (op === -1) {
              oldLineHtml += `<mark class="del">${escaped}</mark>`;
            } else if (op === 1) {
              newLineHtml += `<mark class="add">${escaped}</mark>`;
            }
          }

          resultHTML += `<span class="removed">${lineNum}${oldLineHtml}</span>\n`;
          resultHTML += `<span class="added">${lineNum}${newLineHtml}</span>\n`;
        }
      }

      document.getElementById("diffOutput").innerHTML = `<pre>${resultHTML}</pre>`;
    }

    function saveCode() {
      const codeName = document.getElementById("codeName").value.trim();
      const newCode = document.getElementById("newCode").value;

      if (!codeName) {
        alert("ÏΩîÎìú Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");
        return;
      }

      let history = JSON.parse(localStorage.getItem("codeHistory") || "{}");
      history[codeName] = newCode;
      localStorage.setItem("codeHistory", JSON.stringify(history));

      alert(`'${codeName}' ÏΩîÎìúÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`);
    }

    function loadSavedCodes() {
      const history = JSON.parse(localStorage.getItem("codeHistory") || "{}");
      const select = document.getElementById("codeSelect");
      select.innerHTML = "";

      Object.keys(history).forEach((name) => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });

      select.onchange = function () {
        const selectedCode = select.value;
        document.getElementById("newCode").value = history[selectedCode];
        updateLineNumbers('newCode', 'newLineNumbers');
        alert(`'${selectedCode}' ÏΩîÎìúÍ∞Ä Î∂àÎü¨ÏôÄÏ°åÏäµÎãàÎã§.`);
      };
    }

    function exportCodeToFile() {
      const codeName = document.getElementById("codeName").value.trim();
      const codeText = document.getElementById("newCode").value;

      if (!codeName) {
        alert("ÏΩîÎìú Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");
        return;
      }

      const blob = new Blob([codeText], { type: "text/plain;charset=utf-8" });

      const now = new Date();
      const dateStr = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;
      const filename = `${codeName}_${dateStr}.txt`;

      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function copyNewToOld() {
      const newCode = document.getElementById('newCode').value;
      document.getElementById('oldCode').value = newCode;
      updateLineNumbers('oldCode', 'oldLineNumbers');
    }

    // Ï¥àÍ∏∞ Ï§Ñ Î≤àÌò∏ Î∞òÏòÅ
    window.onload = () => {
      updateLineNumbers('oldCode', 'oldLineNumbers');
      updateLineNumbers('newCode', 'newLineNumbers');
    };
  </script>

</body>
</html>
