<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ë² ì´ìŠ¤ ì½”ë“œ ìˆ˜ì • ë„ìš°ë¯¸ (Ver 3.4 - HTML ë Œë”ë§ ë°©ì§€ & í•˜ì´ë¼ì´íŠ¸)</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; background-color: #f0f2f5; }
        header { background-color: #333; color: white; padding: 10px 20px; text-align: center; font-weight: bold; }
        
        /* ê¸°ë³¸ ë“œë˜ê·¸ ì„ íƒ ìƒ‰ìƒ */
        ::selection { background-color: #ffeb3b; color: #000; }
        
        /* âœ¨ [ì‹ ê·œ] ìˆ˜ì •ëœ ë¶€ë¶„ ë…¸ë€ìƒ‰ ë§ˆì»¤ (ëˆˆì— ì˜ ë„ê²Œ) */
        .highlight-marker { background-color: #fff176; color: #000; display: inline-block; min-width: 100%; font-weight: bold; }

        .container { display: flex; height: calc(100vh - 50px); }
        .panel { flex: 1; padding: 10px; display: flex; flex-direction: column; }
        .panel h3 { text-align: center; margin: 0 0 10px 0; color: #555; }
        
        /* ì¢Œì¸¡ ì—ë””í„° (textarea) */
        textarea.code-editor { flex: 1; padding: 10px; font-family: 'Consolas', monospace; font-size: 13px; border: 1px solid #ccc; border-radius: 5px; resize: none; line-height: 1.5; white-space: pre; overflow-wrap: normal; overflow-x: scroll; background-color: #fff; }
        
        /* ìš°ì¸¡ ê²°ê³¼ì°½ (HTML ë Œë”ë§ ë°©ì§€ ì²˜ë¦¬ëœ div) */
        #rightCode { 
            flex: 1; padding: 10px; 
            font-family: 'Consolas', monospace; font-size: 13px; 
            border: 1px solid #ccc; border-radius: 5px; 
            overflow: auto; line-height: 1.5; white-space: pre; 
            background-color: #fff; 
            color: #333;
        }

        .controls { flex: 0 0 380px; padding: 10px; background-color: #e9ecef; border-left: 2px solid #ddd; border-right: 2px solid #ddd; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .control-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .control-box h4 { margin: 0 0 10px 0; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .control-box.delete { border-top: 5px solid #ff6b6b; }
        .control-box.replace { border-top: 5px solid #4dabf7; }
        .control-box.insert { border-top: 5px solid #51cf66; }

        label { display: block; margin-top: 8px; font-size: 12px; font-weight: bold; color: #666; }
        .code-input { width: 100%; height: 80px; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: 'Consolas', monospace; font-size: 12px; resize: vertical; }
        
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-find { background-color: #fcc419; color: #333; }
        .btn-del { background-color: #fa5252; color: white; }
        .btn-mod { background-color: #228be6; color: white; }
        .btn-add { background-color: #40c057; color: white; }
        button:hover { opacity: 0.8; }
        
        #status-msg { text-align: center; color: #d6336c; font-weight: bold; min-height: 20px; margin-top: 5px; font-size: 13px; }
    </style>
</head>
<body>

<header>ğŸ› ï¸ ë…¸ë² ì´ìŠ¤ ì½”ë“œ ìˆ˜ì • ë„ìš°ë¯¸ (Ver 3.4 - ë…¸ë€ìƒ‰ ë§ˆì»¤ & ê¹¨ì§ ë°©ì§€)</header>

<div class="container">
    <div class="panel">
        <h3>1. ì›ë³¸ ì½”ë“œ (ê¸°ì¤€)</h3>
        <textarea id="leftCode" class="code-editor" placeholder="ì—¬ê¸°ì— ì›ë˜ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
    </div>

    <div class="controls">
        <div id="status-msg"></div>

        <div class="control-box delete">
            <h4>ğŸ—‘ï¸ ì½”ë“œ ì‚­ì œ</h4>
            <label>ì§€ìš¸ ì½”ë“œ</label>
            <textarea id="delTarget" class="code-input" placeholder="function abc() { ... }"></textarea>
            <div class="btn-group">
                <button class="btn-find" onclick="findBlock('delTarget')">ğŸ” ìœ„ì¹˜ í™•ì¸</button>
                <button class="btn-del" onclick="deleteBlock()">âŒ ë©ì–´ë¦¬ ì‚­ì œ</button>
            </div>
        </div>

        <div class="control-box replace">
            <h4>ğŸ”„ ì½”ë“œ ìˆ˜ì • (êµì²´)</h4>
            <label>ìˆ˜ì • ì „ ì½”ë“œ</label>
            <textarea id="modBefore" class="code-input" placeholder="ê¸°ì¡´ ì½”ë“œ"></textarea>
            <label>ìˆ˜ì • í›„ ì½”ë“œ</label>
            <textarea id="modAfter" class="code-input" placeholder="ìƒˆë¡œìš´ ì½”ë“œ (ë…¸ë€ìƒ‰ í‘œì‹œë¨)"></textarea>
            <div class="btn-group">
                <button class="btn-find" onclick="findBlock('modBefore')">ğŸ” ìœ„ì¹˜ í™•ì¸</button>
                <button class="btn-mod" onclick="replaceBlock()">ğŸ”„ ë©ì–´ë¦¬ êµì²´</button>
            </div>
        </div>

        <div class="control-box insert">
            <h4>â• ì½”ë“œ ì¶”ê°€ (ë¼ì›Œë„£ê¸°)</h4>
            <label>ê¸°ì¤€ ì½”ë“œ</label>
            <textarea id="addAnchor" class="code-input" style="height:50px;" placeholder="ì˜ˆ: void setup() {"></textarea>
            <label>ì¶”ê°€í•  ì½”ë“œ</label>
            <textarea id="addContent" class="code-input" placeholder="ìƒˆë¡œìš´ ê¸°ëŠ¥ (ë…¸ë€ìƒ‰ í‘œì‹œë¨)"></textarea>
            <div class="btn-group">
                <button class="btn-find" onclick="findBlock('addAnchor')">ğŸ” ìœ„ì¹˜ í™•ì¸</button>
                <button class="btn-add" onclick="insertBlock()">â• ì¶”ê°€ ì‹¤í–‰</button>
            </div>
        </div>
    </div>

    <div class="panel">
        <h3>3. ê²°ê³¼ ì½”ë“œ (ìˆ˜ì • ë‚´ì—­ í™•ì¸)</h3>
        <div id="rightCode"></div>
    </div>
</div>

<script>
    const leftArea = document.getElementById('leftCode');
    const rightArea = document.getElementById('rightCode');
    const msgArea = document.getElementById('status-msg');

    // âœ¨ [í•µì‹¬] HTML ì½”ë“œë¥¼ ê¸€ì ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ê¸° ìœ„í•œ ë³€í™˜ í•¨ìˆ˜ (ë°©ì–´ë§‰)
    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ì¢Œì¸¡ ì…ë ¥ ì‹œ ìš°ì¸¡ ì´ˆê¸°í™”
    leftArea.addEventListener('input', function() {
        if(rightArea.innerText.trim() === "") { 
            // ì´ˆê¸°í™” í•  ë•Œë„ ë°©ì–´ë§‰ì„ ì³ì„œ íƒœê·¸ê°€ ì‹¤í–‰ë˜ì§€ ì•Šê²Œ í•¨
            rightArea.innerText = leftArea.value; 
        }
    });

    function normalize(str) { return str.replace(/\s+/g, ''); }

    // ì¤„ ë²”ìœ„ ì°¾ê¸° (ê¸°ì¡´ ìœ ì§€)
    function findLineRange(searchText, sourceCode) {
        if (!searchText.trim()) return null;
        const sourceLines = sourceCode.split('\n');
        const searchLines = searchText.split('\n').filter(line => line.trim() !== ''); 
        if (searchLines.length === 0) return null;
        for (let i = 0; i < sourceLines.length; i++) {
            if (normalize(sourceLines[i]) === normalize(searchLines[0])) {
                let isMatch = true;
                for (let j = 1; j < searchLines.length; j++) {
                    if (i + j >= sourceLines.length) { isMatch = false; break; }
                    if (normalize(sourceLines[i + j]) !== normalize(searchLines[j])) {
                        isMatch = false; break;
                    }
                }
                if (isMatch) return { start: i, count: searchLines.length };
            }
        }
        return null;
    }

    // í•˜ì´ë¼ì´íŠ¸ (ê¸°ì¡´ ìœ ì§€)
    function highlightRange(startLineIndex, lineCount) {
        const fullText = leftArea.value;
        const lines = fullText.split('\n');
        let startCharIndex = 0;
        for (let i = 0; i < startLineIndex; i++) startCharIndex += lines[i].length + 1; 
        let endCharIndex = startCharIndex;
        let linesChecked = 0;
        let currentLineIdx = startLineIndex;
        while(linesChecked < lineCount && currentLineIdx < lines.length) {
            endCharIndex += lines[currentLineIdx].length + 1;
            currentLineIdx++;
            linesChecked++;
        }
        leftArea.focus();
        leftArea.setSelectionRange(startCharIndex, endCharIndex - 1); 
        const lineHeight = 20; 
        const scrollPos = (startLineIndex * lineHeight) - (leftArea.clientHeight / 2);
        leftArea.scrollTop = scrollPos > 0 ? scrollPos : 0;
    }

    // ì°¾ê¸° ë²„íŠ¼ (ê¸°ì¡´ ìœ ì§€)
    function findBlock(inputId) {
        const inputVal = document.getElementById(inputId).value;
        const currentCode = leftArea.value;
        const result = findLineRange(inputVal, currentCode);
        if (result) {
            showMsg(`âœ… ì°¾ì•˜ìŠµë‹ˆë‹¤! (í˜•ê´‘ìƒ‰ í™•ì¸)`);
            highlightRange(result.start, result.count);
        } else { showMsg("âš ï¸ ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
    }

    // ì‚­ì œ ì‹¤í–‰ (ê¸°ì¡´ ìœ ì§€)
    function deleteBlock() {
        const inputVal = document.getElementById('delTarget').value;
        // ìš°ì¸¡ ë‚´ìš©ì„ ê°€ì ¸ì˜¬ ë•Œ innerTextë¥¼ ì¨ì„œ ìˆœìˆ˜ ì½”ë“œë§Œ ê°€ì ¸ì˜´
        let currentCode = rightArea.innerText || leftArea.value; 
        const result = findLineRange(inputVal, currentCode);

        if (result) {
            const lines = currentCode.split('\n');
            let resultHtml = ""; // HTMLë¡œ ì¡°ë¦½ ì˜ˆì •
            const searchLines = inputVal.split('\n').filter(l => l.trim() !== '');

            for (let i = 0; i < lines.length; i++) {
                if (i === result.start) {
                    let matchIdx = 0; let scanning = i;
                    while(matchIdx < searchLines.length && scanning < lines.length) {
                        if (normalize(lines[scanning]) === normalize(searchLines[matchIdx])) matchIdx++;
                        scanning++;
                    }
                    i = scanning - 1;
                    showMsg("âœ… ì‚­ì œ ì™„ë£Œ!");
                } else {
                    // ì‚­ì œë˜ì§€ ì•Šì€ ì¤„ì€ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ë¡œ(ë°©ì–´ë§‰ ì²˜ë¦¬) ë³´ì—¬ì¤Œ
                    resultHtml += escapeHtml(lines[i]) + "\n";
                }
            }
            rightArea.innerHTML = resultHtml;
        } else { showMsg("âš ï¸ ì‚­ì œí•  ì½”ë“œë¥¼ ëª» ì°¾ì•˜ìŠµë‹ˆë‹¤."); }
    }

    // ìˆ˜ì • (êµì²´) ì‹¤í–‰ - âœ¨ ë…¸ë€ìƒ‰ ë§ˆì»¤ ì¶”ê°€
    function replaceBlock() {
        const beforeVal = document.getElementById('modBefore').value;
        const afterVal = document.getElementById('modAfter').value;
        let currentCode = rightArea.innerText || leftArea.value;
        const result = findLineRange(beforeVal, currentCode);

        if (result) {
            const lines = currentCode.split('\n');
            let resultHtml = "";
            const searchLines = beforeVal.split('\n').filter(l => l.trim() !== '');

            for (let i = 0; i < lines.length; i++) {
                if (i === result.start) {
                    const originalLine = lines[i];
                    const indentMatch = originalLine.match(/^\s*/); 
                    const indent = indentMatch ? indentMatch[0] : "";
                    
                    const newContentLines = afterVal.split('\n');
                    // âœ¨ ìƒˆ ì½”ë“œë¥¼ ë…¸ë€ìƒ‰ ë (<span class="highlight-marker">)ë¡œ ê°ì‹¸ê¸°
                    // ë‚´ìš©ë¬¼ì€ escapeHtmlë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                    const highlightedNewLines = newContentLines.map(line => {
                        return `<span class="highlight-marker">${escapeHtml(indent + line)}</span>`;
                    }).join('\n');
                    
                    resultHtml += highlightedNewLines + "\n";

                    let matchIdx = 0; let scanning = i;
                    while(matchIdx < searchLines.length && scanning < lines.length) {
                        if (normalize(lines[scanning]) === normalize(searchLines[matchIdx])) matchIdx++;
                        scanning++;
                    }
                    i = scanning - 1;
                    showMsg("âœ… êµì²´ ì™„ë£Œ! (ë…¸ë€ìƒ‰ í™•ì¸)");
                } else { 
                    resultHtml += escapeHtml(lines[i]) + "\n"; 
                }
            }
            rightArea.innerHTML = resultHtml;
        } else { showMsg("âš ï¸ êµì²´ ëŒ€ìƒì„ ëª» ì°¾ì•˜ìŠµë‹ˆë‹¤."); }
    }

    // ì¶”ê°€ ì‹¤í–‰ - âœ¨ ë…¸ë€ìƒ‰ ë§ˆì»¤ ì¶”ê°€
    function insertBlock() {
        const anchorVal = document.getElementById('addAnchor').value;
        const contentVal = document.getElementById('addContent').value;
        let currentCode = rightArea.innerText || leftArea.value;
        const result = findLineRange(anchorVal, currentCode);

        if (result) {
             const lines = currentCode.split('\n');
             let resultHtml = "";
             const searchLines = anchorVal.split('\n').filter(l => l.trim() !== '');
            
            for (let i = 0; i < lines.length; i++) {
                resultHtml += escapeHtml(lines[i]) + "\n"; // ê¸°ì¡´ ì½”ë“œ (ì•ˆì „ ì²˜ë¦¬)
                
                if (i === result.start) {
                    const originalLine = lines[i];
                    const indentMatch = originalLine.match(/^\s*/);
                    const indent = indentMatch ? indentMatch[0] : "";
                    let matchIdx = 1; let scanning = i + 1;
                    while(matchIdx < searchLines.length && scanning < lines.length) {
                        if (normalize(lines[scanning]) === normalize(searchLines[matchIdx])) { 
                            resultHtml += escapeHtml(lines[scanning]) + "\n"; 
                            matchIdx++; 
                        } else { 
                            resultHtml += escapeHtml(lines[scanning]) + "\n"; 
                        }
                        scanning++;
                    }
                    
                    const newContentLines = contentVal.split('\n');
                    // âœ¨ ì¶”ê°€ëœ ì½”ë“œë„ ë…¸ë€ìƒ‰ ë ë¡œ ê°ì‹¸ê¸°
                    const highlightedNewContent = newContentLines.map(line => {
                         return `<span class="highlight-marker">${escapeHtml(indent + line)}</span>`;
                    }).join('\n');
                    
                    resultHtml += highlightedNewContent + "\n";

                    i = scanning - 1; 
                    showMsg("âœ… ì¶”ê°€ ì™„ë£Œ! (ë…¸ë€ìƒ‰ í™•ì¸)");
                }
            }
            rightArea.innerHTML = resultHtml;
        } else { showMsg("âš ï¸ ê¸°ì¤€ ìœ„ì¹˜ë¥¼ ëª» ì°¾ì•˜ìŠµë‹ˆë‹¤."); }
    }

    function showMsg(text) {
        msgArea.innerText = text;
        setTimeout(() => { msgArea.innerText = ""; }, 5000);
    }
</script>

</body>
</html>
