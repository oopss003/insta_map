<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ë² ì´ìŠ¤ ì½”ë“œ ìˆ˜ì • ë„ìš°ë¯¸ (Ver 3.3 - ìˆ˜ì • ë‚´ì—­ í•˜ì´ë¼ì´íŠ¸)</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; background-color: #f0f2f5; }
        header { background-color: #333; color: white; padding: 10px 20px; text-align: center; font-weight: bold; }
        
        /* ê¸°ë³¸ í•˜ì´ë¼ì´íŠ¸ (ë“œë˜ê·¸ ì„ íƒ ì‹œ) */
        ::selection { background-color: #ffeb3b; color: #000; }
        ::-moz-selection { background-color: #ffeb3b; color: #000; }

        /* âœ¨ [ì‹ ê·œ ê¸°ëŠ¥] ìˆ˜ì •ëœ ì½”ë“œì— ì ìš©ë  í˜•ê´‘íœ ìŠ¤íƒ€ì¼ (ì—°í•œ ì´ˆë¡ìƒ‰) */
        .highlight-change { background-color: #d4edda; display: inline-block; width: 100%; }

        .container { display: flex; height: calc(100vh - 50px); }
        .panel { flex: 1; padding: 10px; display: flex; flex-direction: column; }
        .panel h3 { text-align: center; margin: 0 0 10px 0; color: #555; }
        
        /* ì¢Œì¸¡, ì¤‘ì•™ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        textarea.code-editor { flex: 1; padding: 10px; font-family: 'Consolas', monospace; font-size: 13px; border: 1px solid #ccc; border-radius: 5px; resize: none; line-height: 1.5; white-space: pre; overflow-wrap: normal; overflow-x: scroll; background-color: #fff; }
        
        /* ìš°ì¸¡ ê²°ê³¼ì°½ ìŠ¤íƒ€ì¼ (ìƒ‰ìƒ í‘œí˜„ì„ ìœ„í•´ divë¡œ ë³€ê²½ë¨) */
        #rightCode { flex: 1; padding: 10px; font-family: 'Consolas', monospace; font-size: 13px; border: 1px solid #ccc; border-radius: 5px; overflow: auto; line-height: 1.5; white-space: pre; background-color: #fff; }

        .controls { flex: 0 0 380px; padding: 10px; background-color: #e9ecef; border-left: 2px solid #ddd; border-right: 2px solid #ddd; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .control-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .control-box h4 { margin: 0 0 10px 0; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .control-box.delete { border-top: 5px solid #ff6b6b; }
        .control-box.replace { border-top: 5px solid #4dabf7; }
        .control-box.insert { border-top: 5px solid #51cf66; }

        label { display: block; margin-top: 8px; font-size: 12px; font-weight: bold; color: #666; }
        
        .code-input { 
            width: 100%; height: 80px; 
            padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: 'Consolas', monospace; font-size: 12px;
            resize: vertical; 
        }
        
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        .btn-find { background-color: #fcc419; color: #333; }
        .btn-del { background-color: #fa5252; color: white; }
        .btn-mod { background-color: #228be6; color: white; }
        .btn-add { background-color: #40c057; color: white; }
        
        button:hover { opacity: 0.8; }
        
        #status-msg { text-align: center; color: #d6336c; font-weight: bold; min-height: 20px; margin-top: 5px; font-size: 13px; }
    </style>
</head>
<body>

<header>ğŸ› ï¸ ë…¸ë² ì´ìŠ¤ ì½”ë“œ ìˆ˜ì • ë„ìš°ë¯¸ (Ver 3.3 - ìˆ˜ì • ë‚´ì—­ í•˜ì´ë¼ì´íŠ¸)</header>

<div class="container">
    <div class="panel">
        <h3>1. ì›ë³¸ ì½”ë“œ (ê¸°ì¤€)</h3>
        <textarea id="leftCode" class="code-editor" placeholder="ì—¬ê¸°ì— ì›ë˜ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
    </div>

    <div class="controls">
        <div id="status-msg"></div>

        <div class="control-box delete">
            <h4>ğŸ—‘ï¸ ì½”ë“œ ì‚­ì œ</h4>
            <label>ì§€ìš¸ ì½”ë“œ (ì—¬ëŸ¬ ì¤„ ë³µì‚¬í•´ë„ ë©ë‹ˆë‹¤)</label>
            <textarea id="delTarget" class="code-input" placeholder="function abc() { ... }"></textarea>
            <div class="btn-group">
                <button class="btn-find" onclick="findBlock('delTarget')">ğŸ” ìœ„ì¹˜ í™•ì¸</button>
                <button class="btn-del" onclick="deleteBlock()">âŒ ë©ì–´ë¦¬ ì‚­ì œ</button>
            </div>
        </div>

        <div class="control-box replace">
            <h4>ğŸ”„ ì½”ë“œ ìˆ˜ì • (êµì²´)</h4>
            <label>ìˆ˜ì • ì „ ì½”ë“œ (ì°¾ì„ ë‚´ìš©)</label>
            <textarea id="modBefore" class="code-input" placeholder="ê¸°ì¡´ ì½”ë“œ"></textarea>
            <label>ìˆ˜ì • í›„ ì½”ë“œ (ë°”ê¿€ ë‚´ìš©)</label>
            <textarea id="modAfter" class="code-input" placeholder="ìƒˆë¡œìš´ ì½”ë“œ (ì´ˆë¡ìƒ‰ í‘œì‹œë¨)"></textarea>
            <div class="btn-group">
                <button class="btn-find" onclick="findBlock('modBefore')">ğŸ” ìœ„ì¹˜ í™•ì¸</button>
                <button class="btn-mod" onclick="replaceBlock()">ğŸ”„ ë©ì–´ë¦¬ êµì²´</button>
            </div>
        </div>

        <div class="control-box insert">
            <h4>â• ì½”ë“œ ì¶”ê°€ (ë¼ì›Œë„£ê¸°)</h4>
            <label>ê¸°ì¤€ ì½”ë“œ (ì´ ì½”ë“œ ë°‘ì— ì¶”ê°€ë¨)</label>
            <textarea id="addAnchor" class="code-input" style="height:50px;" placeholder="ì˜ˆ: void setup() {"></textarea>
            <label>ì¶”ê°€í•  ì½”ë“œ</label>
            <textarea id="addContent" class="code-input" placeholder="ìƒˆë¡œìš´ ê¸°ëŠ¥ (ì´ˆë¡ìƒ‰ í‘œì‹œë¨)"></textarea>
            <div class="btn-group">
                <button class="btn-find" onclick="findBlock('addAnchor')">ğŸ” ìœ„ì¹˜ í™•ì¸</button>
                <button class="btn-add" onclick="insertBlock()">â• ì¶”ê°€ ì‹¤í–‰</button>
            </div>
        </div>
    </div>

    <div class="panel">
        <h3>3. ê²°ê³¼ ì½”ë“œ (ìˆ˜ì • ë‚´ì—­ í™•ì¸)</h3>
        <div id="rightCode" contenteditable="true" spellcheck="false"></div>
    </div>
</div>

<script>
    const leftArea = document.getElementById('leftCode');
    const rightArea = document.getElementById('rightCode');
    const msgArea = document.getElementById('status-msg');

    // ìš°ì¸¡ ì½”ë“œì°½ì˜ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ëŠ” í—¬í¼ í•¨ìˆ˜ (divë¡œ ë°”ë€Œì–´ì„œ í•„ìš”í•¨)
    function getRightCodeContent() {
        return rightArea.innerText || ""; 
    }

    // ì´ˆê¸°í™” ë° ë™ê¸°í™” ë¡œì§ ì—…ë°ì´íŠ¸
    leftArea.addEventListener('input', function() {
        if(getRightCodeContent().trim() === "") { 
            rightArea.innerText = leftArea.value; // ì´ˆê¸°ì—” ê·¸ëƒ¥ í…ìŠ¤íŠ¸ë¡œ ë„£ìŒ
        }
    });

    function normalize(str) { return str.replace(/\s+/g, ''); }

    // ê¸°ì¡´ ë¡œì§ ìœ ì§€
    function findLineRange(searchText, sourceCode) {
        if (!searchText.trim()) return null;
        const sourceLines = sourceCode.split('\n');
        const searchLines = searchText.split('\n').filter(line => line.trim() !== ''); 
        if (searchLines.length === 0) return null;
        for (let i = 0; i < sourceLines.length; i++) {
            if (normalize(sourceLines[i]) === normalize(searchLines[0])) {
                let isMatch = true;
                for (let j = 1; j < searchLines.length; j++) {
                    if (i + j >= sourceLines.length) { isMatch = false; break; }
                    if (normalize(sourceLines[i + j]) !== normalize(searchLines[j])) {
                        isMatch = false; break;
                    }
                }
                if (isMatch) return { start: i, count: searchLines.length };
            }
        }
        return null;
    }

    // ê¸°ì¡´ ë¡œì§ ìœ ì§€
    function highlightRange(startLineIndex, lineCount) {
        const fullText = leftArea.value;
        const lines = fullText.split('\n');
        let startCharIndex = 0;
        for (let i = 0; i < startLineIndex; i++) startCharIndex += lines[i].length + 1; 
        let endCharIndex = startCharIndex;
        let linesChecked = 0;
        let currentLineIdx = startLineIndex;
        while(linesChecked < lineCount && currentLineIdx < lines.length) {
            endCharIndex += lines[currentLineIdx].length + 1;
            currentLineIdx++;
            linesChecked++;
        }
        leftArea.focus();
        leftArea.setSelectionRange(startCharIndex, endCharIndex - 1); 
        const lineHeight = 20; 
        const scrollPos = (startLineIndex * lineHeight) - (leftArea.clientHeight / 2);
        leftArea.scrollTop = scrollPos > 0 ? scrollPos : 0;
    }

    // ê¸°ì¡´ ë¡œì§ ìœ ì§€
    function findBlock(inputId) {
        const inputVal = document.getElementById(inputId).value;
        const currentCode = leftArea.value;
        const result = findLineRange(inputVal, currentCode);
        if (result) {
            showMsg(`âœ… ì°¾ì•˜ìŠµë‹ˆë‹¤! (ì¢Œì¸¡ í˜•ê´‘ìƒ‰ ë¶€ë¶„)`);
            highlightRange(result.start, result.count);
        } else { showMsg("âš ï¸ ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
    }

    // 2. ì‚­ì œ ì‹¤í–‰ (ì—…ë°ì´íŠ¸: ìš°ì¸¡ ë‚´ìš© ê°€ì ¸ì˜¤ëŠ” ë°©ì‹ ë³€ê²½)
    function deleteBlock() {
        const inputVal = document.getElementById('delTarget').value;
        let currentCode = getRightCodeContent() || leftArea.value; 
        const result = findLineRange(inputVal, currentCode);

        if (result) {
            const lines = currentCode.split('\n');
            let newLines = [];
            const searchLines = inputVal.split('\n').filter(l => l.trim() !== '');
            for (let i = 0; i < lines.length; i++) {
                if (i === result.start) {
                    let matchIdx = 0; let scanning = i;
                    while(matchIdx < searchLines.length && scanning < lines.length) {
                        if (normalize(lines[scanning]) === normalize(searchLines[matchIdx])) matchIdx++;
                        scanning++;
                    }
                    i = scanning - 1;
                    showMsg("âœ… ì‚­ì œ ì™„ë£Œ!");
                } else { newLines.push(lines[i]); }
            }
            // ê²°ê³¼ë¥¼ HTMLë¡œ ë„£ìŒ (ê¸°ì¡´ í•˜ì´ë¼ì´íŠ¸ ìœ ì§€ ìœ„í•´)
            rightArea.innerHTML = newLines.join('\n');
        } else { showMsg("âš ï¸ ì‚­ì œí•  ì½”ë“œë¥¼ ë³¸ë¬¸ì—ì„œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
    }

    // 3. ìˆ˜ì • (êµì²´) ì‹¤í–‰ - âœ¨ [í•µì‹¬ ìˆ˜ì •] ë³€ê²½ëœ ë¶€ë¶„ì— ìƒ‰ìƒ íƒœê·¸ ì¶”ê°€
    function replaceBlock() {
        const beforeVal = document.getElementById('modBefore').value;
        const afterVal = document.getElementById('modAfter').value;
        let currentCode = getRightCodeContent() || leftArea.value;
        const result = findLineRange(beforeVal, currentCode);

        if (result) {
            const lines = currentCode.split('\n');
            let newLines = [];
            const searchLines = beforeVal.split('\n').filter(l => l.trim() !== '');

            for (let i = 0; i < lines.length; i++) {
                if (i === result.start) {
                    const originalLine = lines[i];
                    const indentMatch = originalLine.match(/^\s*/); 
                    const indent = indentMatch ? indentMatch[0] : "";
                    
                    const newContentLines = afterVal.split('\n');
                    const indentedNewLines = newContentLines.map(line => indent + line).join('\n');
                    
                    // âœ¨ ì—¬ê¸°! ìˆ˜ì •ëœ ì½”ë“œë¥¼ <span class="highlight-change"> íƒœê·¸ë¡œ ê°ìŒ‰ë‹ˆë‹¤.
                    newLines.push('<span class="highlight-change">' + indentedNewLines + '</span>');

                    let matchIdx = 0; let scanning = i;
                    while(matchIdx < searchLines.length && scanning < lines.length) {
                        if (normalize(lines[scanning]) === normalize(searchLines[matchIdx])) matchIdx++;
                        scanning++;
                    }
                    i = scanning - 1;
                    showMsg("âœ… êµì²´ ì™„ë£Œ! (ì´ˆë¡ìƒ‰ í™•ì¸)");
                } else { newLines.push(lines[i]); }
            }
            // ê²°ê³¼ë¥¼ HTMLë¡œ ë„£ìŒ
            rightArea.innerHTML = newLines.join('\n');
        } else { showMsg("âš ï¸ êµì²´í•  ëŒ€ìƒì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
    }

    // 4. ì¶”ê°€ ì‹¤í–‰ - âœ¨ [í•µì‹¬ ìˆ˜ì •] ì¶”ê°€ëœ ë¶€ë¶„ì— ìƒ‰ìƒ íƒœê·¸ ì¶”ê°€
    function insertBlock() {
        const anchorVal = document.getElementById('addAnchor').value;
        const contentVal = document.getElementById('addContent').value;
        let currentCode = getRightCodeContent() || leftArea.value;
        const result = findLineRange(anchorVal, currentCode);

        if (result) {
             const lines = currentCode.split('\n');
             let newLines = [];
             const searchLines = anchorVal.split('\n').filter(l => l.trim() !== '');
            
            for (let i = 0; i < lines.length; i++) {
                newLines.push(lines[i]); 
                if (i === result.start) {
                    const originalLine = lines[i];
                    const indentMatch = originalLine.match(/^\s*/);
                    const indent = indentMatch ? indentMatch[0] : "";
                    let matchIdx = 1; let scanning = i + 1;
                    while(matchIdx < searchLines.length && scanning < lines.length) {
                        if (normalize(lines[scanning]) === normalize(searchLines[matchIdx])) { newLines.push(lines[scanning]); matchIdx++; }
                        else { newLines.push(lines[scanning]); }
                        scanning++;
                    }
                    
                    const newContentLines = contentVal.split('\n');
                    const indentedNewContent = newContentLines.map(line => indent + line).join('\n');
                    
                    // âœ¨ ì—¬ê¸°! ì¶”ê°€ëœ ì½”ë“œë¥¼ <span class="highlight-change"> íƒœê·¸ë¡œ ê°ìŒ‰ë‹ˆë‹¤.
                    newLines.push('<span class="highlight-change">' + indentedNewContent + '</span>');

                    i = scanning - 1; 
                    showMsg("âœ… ì¶”ê°€ ì™„ë£Œ! (ì´ˆë¡ìƒ‰ í™•ì¸)");
                }
            }
            // ê²°ê³¼ë¥¼ HTMLë¡œ ë„£ìŒ
            rightArea.innerHTML = newLines.join('\n');
        } else { showMsg("âš ï¸ ê¸°ì¤€ ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
    }

    function showMsg(text) {
        msgArea.innerText = text;
        setTimeout(() => { msgArea.innerText = ""; }, 5000);
    }
</script>

</body>
</html>
