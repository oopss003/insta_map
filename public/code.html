<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ë² ì´ìŠ¤ ì½”ë“œ ìˆ˜ì • ë„ìš°ë¯¸ (Ver 3.2 - ì¤„ë§ì¶¤ ì™„ë²½ í•´ê²°)</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; background-color: #f0f2f5; }
        header { background-color: #333; color: white; padding: 10px 20px; text-align: center; font-weight: bold; }
        
        /* í•˜ì´ë¼ì´íŠ¸ ìƒ‰ìƒ (í˜•ê´‘ ë…¸ë‘) - Ver 3.1 ê¸°ëŠ¥ ìœ ì§€ */
        ::selection { background-color: #ffeb3b; color: #000; }
        ::-moz-selection { background-color: #ffeb3b; color: #000; }

        .container { display: flex; height: calc(100vh - 50px); }
        .panel { flex: 1; padding: 10px; display: flex; flex-direction: column; }
        .panel h3 { text-align: center; margin: 0 0 10px 0; color: #555; }
        
        textarea { flex: 1; padding: 10px; font-family: 'Consolas', monospace; font-size: 13px; border: 1px solid #ccc; border-radius: 5px; resize: none; line-height: 1.5; white-space: pre; overflow-wrap: normal; overflow-x: scroll; background-color: #fff; }
        
        .controls { flex: 0 0 380px; padding: 10px; background-color: #e9ecef; border-left: 2px solid #ddd; border-right: 2px solid #ddd; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .control-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .control-box h4 { margin: 0 0 10px 0; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .control-box.delete { border-top: 5px solid #ff6b6b; }
        .control-box.replace { border-top: 5px solid #4dabf7; }
        .control-box.insert { border-top: 5px solid #51cf66; }

        label { display: block; margin-top: 8px; font-size: 12px; font-weight: bold; color: #666; }
        
        .code-input { 
            width: 100%; height: 80px; 
            padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: 'Consolas', monospace; font-size: 12px;
            resize: vertical; 
        }
        
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        .btn-find { background-color: #fcc419; color: #333; }
        .btn-del { background-color: #fa5252; color: white; }
        .btn-mod { background-color: #228be6; color: white; }
        .btn-add { background-color: #40c057; color: white; }
        
        button:hover { opacity: 0.8; }
        
        #status-msg { text-align: center; color: #d6336c; font-weight: bold; min-height: 20px; margin-top: 5px; font-size: 13px; }
    </style>
</head>
<body>

<header>ğŸ› ï¸ ë…¸ë² ì´ìŠ¤ ì½”ë“œ ìˆ˜ì • ë„ìš°ë¯¸ (Ver 3.2 - ì¤„ë§ì¶¤ ì™„ë²½ í•´ê²°)</header>

<div class="container">
    <div class="panel">
        <h3>1. ì›ë³¸ ì½”ë“œ (ê¸°ì¤€)</h3>
        <textarea id="leftCode" placeholder="ì—¬ê¸°ì— ì›ë˜ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
    </div>

    <div class="controls">
        <div id="status-msg"></div>

        <div class="control-box delete">
            <h4>ğŸ—‘ï¸ ì½”ë“œ ì‚­ì œ</h4>
            <label>ì§€ìš¸ ì½”ë“œ (ì—¬ëŸ¬ ì¤„ ë³µì‚¬í•´ë„ ë©ë‹ˆë‹¤)</label>
            <textarea id="delTarget" class="code-input" placeholder="function abc() { ... }"></textarea>
            <div class="btn-group">
                <button class="btn-find" onclick="findBlock('delTarget')">ğŸ” ìœ„ì¹˜ í™•ì¸</button>
                <button class="btn-del" onclick="deleteBlock()">âŒ ë©ì–´ë¦¬ ì‚­ì œ</button>
            </div>
        </div>

        <div class="control-box replace">
            <h4>ğŸ”„ ì½”ë“œ ìˆ˜ì • (êµì²´)</h4>
            <label>ìˆ˜ì • ì „ ì½”ë“œ (ì°¾ì„ ë‚´ìš©)</label>
            <textarea id="modBefore" class="code-input" placeholder="ê¸°ì¡´ ì½”ë“œ"></textarea>
            <label>ìˆ˜ì • í›„ ì½”ë“œ (ë°”ê¿€ ë‚´ìš©)</label>
            <textarea id="modAfter" class="code-input" placeholder="ìƒˆë¡œìš´ ì½”ë“œ"></textarea>
            <div class="btn-group">
                <button class="btn-find" onclick="findBlock('modBefore')">ğŸ” ìœ„ì¹˜ í™•ì¸</button>
                <button class="btn-mod" onclick="replaceBlock()">ğŸ”„ ë©ì–´ë¦¬ êµì²´</button>
            </div>
        </div>

        <div class="control-box insert">
            <h4>â• ì½”ë“œ ì¶”ê°€ (ë¼ì›Œë„£ê¸°)</h4>
            <label>ê¸°ì¤€ ì½”ë“œ (ì´ ì½”ë“œ ë°‘ì— ì¶”ê°€ë¨)</label>
            <textarea id="addAnchor" class="code-input" style="height:50px;" placeholder="ì˜ˆ: void setup() {"></textarea>
            <label>ì¶”ê°€í•  ì½”ë“œ</label>
            <textarea id="addContent" class="code-input" placeholder="ìƒˆë¡œìš´ ê¸°ëŠ¥..."></textarea>
            <div class="btn-group">
                <button class="btn-find" onclick="findBlock('addAnchor')">ğŸ” ìœ„ì¹˜ í™•ì¸</button>
                <button class="btn-add" onclick="insertBlock()">â• ì¶”ê°€ ì‹¤í–‰</button>
            </div>
        </div>
    </div>

    <div class="panel">
        <h3>3. ê²°ê³¼ ì½”ë“œ (ì™„ì„±ë³¸)</h3>
        <textarea id="rightCode" placeholder="ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì—¬ê¸°ì— ìˆ˜ì •ëœ ì½”ë“œê°€ ë‚˜ì˜µë‹ˆë‹¤."></textarea>
    </div>
</div>

<script>
    const leftArea = document.getElementById('leftCode');
    const rightArea = document.getElementById('rightCode');
    const msgArea = document.getElementById('status-msg');

    leftArea.addEventListener('input', function() {
        if(rightArea.value.trim() === "") { 
            rightArea.value = leftArea.value;
        }
    });

    function normalize(str) {
        return str.replace(/\s+/g, '');
    }

    // ì¤„ ë²”ìœ„ ì°¾ê¸° í•¨ìˆ˜ (Ver 3.1 ìœ ì§€)
    function findLineRange(searchText, sourceCode) {
        if (!searchText.trim()) return null;

        const sourceLines = sourceCode.split('\n');
        const searchLines = searchText.split('\n').filter(line => line.trim() !== ''); 
        
        if (searchLines.length === 0) return null;

        for (let i = 0; i < sourceLines.length; i++) {
            if (normalize(sourceLines[i]) === normalize(searchLines[0])) {
                let isMatch = true;
                for (let j = 1; j < searchLines.length; j++) {
                    if (i + j >= sourceLines.length) { isMatch = false; break; }
                    if (normalize(sourceLines[i + j]) !== normalize(searchLines[j])) {
                        isMatch = false;
                        break;
                    }
                }
                if (isMatch) {
                    return { start: i, count: searchLines.length };
                }
            }
        }
        return null;
    }

// í•˜ì´ë¼ì´íŠ¸ í•¨ìˆ˜ (Ver 3.3 - ì–‘ìª½ ì°½ ì§€ì›)
    function highlightRange(targetArea, startLineIndex, lineCount) {
        const fullText = targetArea.value;
        const lines = fullText.split('\n');
        
        let startCharIndex = 0;
        let endCharIndex = 0;

        for (let i = 0; i < startLineIndex; i++) {
            startCharIndex += lines[i].length + 1; 
        }

        endCharIndex = startCharIndex;
        let linesChecked = 0;
        let currentLineIdx = startLineIndex;
        
        while(linesChecked < lineCount && currentLineIdx < lines.length) {
            endCharIndex += lines[currentLineIdx].length + 1;
            currentLineIdx++;
            linesChecked++;
        }

        targetArea.focus();
        targetArea.setSelectionRange(startCharIndex, endCharIndex - 1); 
        
        const lineHeight = 20; 
        const scrollPos = (startLineIndex * lineHeight) - (targetArea.clientHeight / 2);
        targetArea.scrollTop = scrollPos > 0 ? scrollPos : 0;
    }

// 1. ì°¾ê¸° ë²„íŠ¼ (Ver 3.3 - ì–‘ìª½ ë™ì‹œ ì°¾ê¸°)
    function findBlock(inputId) {
        const inputVal = document.getElementById(inputId).value;
        
        // ì™¼ìª½(ì›ë³¸) ì°¾ê¸°
        const leftResult = findLineRange(inputVal, leftArea.value);
        if (leftResult) {
            highlightRange(leftArea, leftResult.start, leftResult.count);
        }

        // ì˜¤ë¥¸ìª½(ê²°ê³¼) ì°¾ê¸°
        const rightResult = findLineRange(inputVal, rightArea.value);
        if (rightResult) {
            highlightRange(rightArea, rightResult.start, rightResult.count);
        }

        // ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ
        if (leftResult && rightResult) {
            showMsg(`âœ… ì–‘ìª½ ëª¨ë‘ì—ì„œ ì°¾ì•˜ìŠµë‹ˆë‹¤! (ì–‘ìª½ í™”ë©´ ì´ë™ë¨)`);
        } else if (leftResult) {
            showMsg(`âœ… ì›ë³¸(ì™¼ìª½)ì—ì„œë§Œ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
        } else if (rightResult) {
            showMsg(`âœ… ê²°ê³¼(ì˜¤ë¥¸ìª½)ì—ì„œë§Œ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
        } else {
            showMsg("âš ï¸ ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    // 2. ì‚­ì œ ì‹¤í–‰ (Ver 3.1 ìœ ì§€)
    function deleteBlock() {
        const inputVal = document.getElementById('delTarget').value;
        let currentCode = rightArea.value || leftArea.value; 
        const result = findLineRange(inputVal, currentCode);

        if (result) {
            const lines = currentCode.split('\n');
            let newLines = [];
            const searchLines = inputVal.split('\n').filter(l => l.trim() !== '');

            for (let i = 0; i < lines.length; i++) {
                if (i === result.start) {
                    let matchIdx = 0;
                    let scanning = i;
                    while(matchIdx < searchLines.length && scanning < lines.length) {
                        if (normalize(lines[scanning]) === normalize(searchLines[matchIdx])) {
                            matchIdx++;
                        }
                        scanning++;
                    }
                    i = scanning - 1;
                    showMsg("âœ… ì‚­ì œ ì™„ë£Œ!");
                } else {
                    newLines.push(lines[i]);
                }
            }
            rightArea.value = newLines.join('\n');

        } else {
            showMsg("âš ï¸ ì‚­ì œí•  ì½”ë“œë¥¼ ë³¸ë¬¸ì—ì„œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // 3. ìˆ˜ì • (êµì²´) ì‹¤í–‰ - [ì—¬ê¸°ë§Œ ìˆ˜ì •ë¨: ë“¤ì—¬ì“°ê¸° ê¸°ëŠ¥ ì¶”ê°€]
    function replaceBlock() {
        const beforeVal = document.getElementById('modBefore').value;
        const afterVal = document.getElementById('modAfter').value;
        let currentCode = rightArea.value || leftArea.value;
        const result = findLineRange(beforeVal, currentCode);

        if (result) {
            const lines = currentCode.split('\n');
            let newLines = [];
            const searchLines = beforeVal.split('\n').filter(l => l.trim() !== '');

            for (let i = 0; i < lines.length; i++) {
                if (i === result.start) {
                    // --- ìˆ˜ì •ëœ ë¶€ë¶„ ì‹œì‘ ---
                    const originalLine = lines[i];
                    const indentMatch = originalLine.match(/^\s*/); // ê³µë°± ì°¾ê¸°
                    const indent = indentMatch ? indentMatch[0] : "";
                    
                    const newContentLines = afterVal.split('\n');
                    const indentedNewLines = newContentLines.map(line => indent + line).join('\n');
                    
                    newLines.push(indentedNewLines);
                    // --- ìˆ˜ì •ëœ ë¶€ë¶„ ë ---

                    let matchIdx = 0;
                    let scanning = i;
                    while(matchIdx < searchLines.length && scanning < lines.length) {
                        if (normalize(lines[scanning]) === normalize(searchLines[matchIdx])) {
                            matchIdx++;
                        }
                        scanning++;
                    }
                    i = scanning - 1;
                    showMsg("âœ… êµì²´ ì™„ë£Œ! (ë“¤ì—¬ì“°ê¸° ì ìš©ë¨)");
                } else {
                    newLines.push(lines[i]);
                }
            }
            rightArea.value = newLines.join('\n');
        } else {
            showMsg("âš ï¸ êµì²´í•  ëŒ€ìƒì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // 4. ì¶”ê°€ ì‹¤í–‰ - [ì—¬ê¸°ë§Œ ìˆ˜ì •ë¨: ë“¤ì—¬ì“°ê¸° ê¸°ëŠ¥ ì¶”ê°€]
    function insertBlock() {
        const anchorVal = document.getElementById('addAnchor').value;
        const contentVal = document.getElementById('addContent').value;
        let currentCode = rightArea.value || leftArea.value;
        const result = findLineRange(anchorVal, currentCode);

        if (result) {
             const lines = currentCode.split('\n');
             let newLines = [];
             const searchLines = anchorVal.split('\n').filter(l => l.trim() !== '');
            
            for (let i = 0; i < lines.length; i++) {
                newLines.push(lines[i]); 
                
                if (i === result.start) {
                    // --- ìˆ˜ì •ëœ ë¶€ë¶„ ì‹œì‘ ---
                    const originalLine = lines[i];
                    const indentMatch = originalLine.match(/^\s*/); // ê³µë°± ì°¾ê¸°
                    const indent = indentMatch ? indentMatch[0] : "";

                    let matchIdx = 1; 
                    let scanning = i + 1;
                    
                    while(matchIdx < searchLines.length && scanning < lines.length) {
                        if (normalize(lines[scanning]) === normalize(searchLines[matchIdx])) {
                            newLines.push(lines[scanning]); 
                            matchIdx++;
                        } else {
                             newLines.push(lines[scanning]);
                        }
                        scanning++;
                    }
                    
                    const newContentLines = contentVal.split('\n');
                    const indentedNewContent = newContentLines.map(line => indent + line).join('\n');
                    
                    newLines.push(indentedNewContent);
                    // --- ìˆ˜ì •ëœ ë¶€ë¶„ ë ---

                    i = scanning - 1; 
                    showMsg("âœ… ì¶”ê°€ ì™„ë£Œ! (ë“¤ì—¬ì“°ê¸° ì ìš©ë¨)");
                }
            }
            rightArea.value = newLines.join('\n');
        } else {
             showMsg("âš ï¸ ê¸°ì¤€ ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function showMsg(text) {
        msgArea.innerText = text;
        setTimeout(() => { msgArea.innerText = ""; }, 5000);
    }
</script>

</body>
</html>
