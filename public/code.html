<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ë² ì´ìŠ¤ ì½”ë“œ ìˆ˜ì • ë„ìš°ë¯¸ (Ver 3.1 - í•˜ì´ë¼ì´íŠ¸ ìˆ˜ì •íŒ)</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; background-color: #f0f2f5; }
        header { background-color: #333; color: white; padding: 10px 20px; text-align: center; font-weight: bold; }
        
        /* âœ¨ ë“œë˜ê·¸(ì„ íƒ) í–ˆì„ ë•Œ ìƒ‰ìƒì„ í˜•ê´‘ ë…¸ë€ìƒ‰ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ë§ˆë²•ì˜ ì½”ë“œ */
        ::selection { background-color: #ffeb3b; color: #000; }
        ::-moz-selection { background-color: #ffeb3b; color: #000; }

        .container { display: flex; height: calc(100vh - 50px); }
        .panel { flex: 1; padding: 10px; display: flex; flex-direction: column; }
        .panel h3 { text-align: center; margin: 0 0 10px 0; color: #555; }
        
        textarea { flex: 1; padding: 10px; font-family: 'Consolas', monospace; font-size: 13px; border: 1px solid #ccc; border-radius: 5px; resize: none; line-height: 1.5; white-space: pre; overflow-wrap: normal; overflow-x: scroll; background-color: #fff; }
        
        .controls { flex: 0 0 380px; padding: 10px; background-color: #e9ecef; border-left: 2px solid #ddd; border-right: 2px solid #ddd; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .control-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .control-box h4 { margin: 0 0 10px 0; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .control-box.delete { border-top: 5px solid #ff6b6b; }
        .control-box.replace { border-top: 5px solid #4dabf7; }
        .control-box.insert { border-top: 5px solid #51cf66; }

        label { display: block; margin-top: 8px; font-size: 12px; font-weight: bold; color: #666; }
        
        .code-input { 
            width: 100%; height: 80px; 
            padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: 'Consolas', monospace; font-size: 12px;
            resize: vertical; 
        }
        
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        .btn-find { background-color: #fcc419; color: #333; }
        .btn-del { background-color: #fa5252; color: white; }
        .btn-mod { background-color: #228be6; color: white; }
        .btn-add { background-color: #40c057; color: white; }
        
        button:hover { opacity: 0.8; }
        
        #status-msg { text-align: center; color: #d6336c; font-weight: bold; min-height: 20px; margin-top: 5px; font-size: 13px; }
    </style>
</head>
<body>

<header>ğŸ› ï¸ ë…¸ë² ì´ìŠ¤ ì½”ë“œ ìˆ˜ì • ë„ìš°ë¯¸ (Ver 3.1 - í•˜ì´ë¼ì´íŠ¸ ìˆ˜ì •íŒ)</header>

<div class="container">
    <div class="panel">
        <h3>1. ì›ë³¸ ì½”ë“œ (ê¸°ì¤€)</h3>
        <textarea id="leftCode" placeholder="ì—¬ê¸°ì— ì›ë˜ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
    </div>

    <div class="controls">
        <div id="status-msg"></div>

        <div class="control-box delete">
            <h4>ğŸ—‘ï¸ ì½”ë“œ ì‚­ì œ</h4>
            <label>ì§€ìš¸ ì½”ë“œ (ì—¬ëŸ¬ ì¤„ ë³µì‚¬í•´ë„ ë©ë‹ˆë‹¤)</label>
            <textarea id="delTarget" class="code-input" placeholder="function abc() { ... }"></textarea>
            <div class="btn-group">
                <button class="btn-find" onclick="findBlock('delTarget')">ğŸ” ìœ„ì¹˜ í™•ì¸</button>
                <button class="btn-del" onclick="deleteBlock()">âŒ ë©ì–´ë¦¬ ì‚­ì œ</button>
            </div>
        </div>

        <div class="control-box replace">
            <h4>ğŸ”„ ì½”ë“œ ìˆ˜ì • (êµì²´)</h4>
            <label>ìˆ˜ì • ì „ ì½”ë“œ (ì°¾ì„ ë‚´ìš©)</label>
            <textarea id="modBefore" class="code-input" placeholder="ê¸°ì¡´ ì½”ë“œ"></textarea>
            <label>ìˆ˜ì • í›„ ì½”ë“œ (ë°”ê¿€ ë‚´ìš©)</label>
            <textarea id="modAfter" class="code-input" placeholder="ìƒˆë¡œìš´ ì½”ë“œ"></textarea>
            <div class="btn-group">
                <button class="btn-find" onclick="findBlock('modBefore')">ğŸ” ìœ„ì¹˜ í™•ì¸</button>
                <button class="btn-mod" onclick="replaceBlock()">ğŸ”„ ë©ì–´ë¦¬ êµì²´</button>
            </div>
        </div>

        <div class="control-box insert">
            <h4>â• ì½”ë“œ ì¶”ê°€ (ë¼ì›Œë„£ê¸°)</h4>
            <label>ê¸°ì¤€ ì½”ë“œ (ì´ ì½”ë“œ ë°‘ì— ì¶”ê°€ë¨)</label>
            <textarea id="addAnchor" class="code-input" style="height:50px;" placeholder="ì˜ˆ: void setup() {"></textarea>
            <label>ì¶”ê°€í•  ì½”ë“œ</label>
            <textarea id="addContent" class="code-input" placeholder="ìƒˆë¡œìš´ ê¸°ëŠ¥..."></textarea>
            <div class="btn-group">
                <button class="btn-find" onclick="findBlock('addAnchor')">ğŸ” ìœ„ì¹˜ í™•ì¸</button>
                <button class="btn-add" onclick="insertBlock()">â• ì¶”ê°€ ì‹¤í–‰</button>
            </div>
        </div>
    </div>

    <div class="panel">
        <h3>3. ê²°ê³¼ ì½”ë“œ (ì™„ì„±ë³¸)</h3>
        <textarea id="rightCode" placeholder="ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì—¬ê¸°ì— ìˆ˜ì •ëœ ì½”ë“œê°€ ë‚˜ì˜µë‹ˆë‹¤."></textarea>
    </div>
</div>

<script>
    const leftArea = document.getElementById('leftCode');
    const rightArea = document.getElementById('rightCode');
    const msgArea = document.getElementById('status-msg');

    leftArea.addEventListener('input', function() {
        if(rightArea.value.trim() === "") { 
            rightArea.value = leftArea.value;
        }
    });

    function normalize(str) {
        return str.replace(/\s+/g, '');
    }

    // ì¤„ ë²”ìœ„ ì°¾ê¸° í•¨ìˆ˜
    function findLineRange(searchText, sourceCode) {
        if (!searchText.trim()) return null;

        const sourceLines = sourceCode.split('\n');
        const searchLines = searchText.split('\n').filter(line => line.trim() !== ''); 
        
        if (searchLines.length === 0) return null;

        for (let i = 0; i < sourceLines.length; i++) {
            if (normalize(sourceLines[i]) === normalize(searchLines[0])) {
                let isMatch = true;
                for (let j = 1; j < searchLines.length; j++) {
                    if (i + j >= sourceLines.length) { isMatch = false; break; }
                    if (normalize(sourceLines[i + j]) !== normalize(searchLines[j])) {
                        isMatch = false;
                        break;
                    }
                }
                if (isMatch) {
                    return { start: i, count: searchLines.length };
                }
            }
        }
        return null;
    }

    // âœ¨ ìˆ˜ì •ëœ í•µì‹¬ ê¸°ëŠ¥: ì¤„ ë²ˆí˜¸ë¥¼ 'ê¸€ì ìœ„ì¹˜(index)'ë¡œ ë³€í™˜í•˜ì—¬ í•˜ì´ë¼ì´íŠ¸
    function highlightRange(startLineIndex, lineCount) {
        const fullText = leftArea.value;
        const lines = fullText.split('\n');
        
        let startCharIndex = 0;
        let endCharIndex = 0;

        // 1. ì‹œì‘ ìœ„ì¹˜ ê³„ì‚°: ì‹œì‘ ì¤„ ì´ì „ê¹Œì§€ì˜ ëª¨ë“  ê¸€ì ìˆ˜ + ì¤„ë°”ê¿ˆ ë¬¸ì(\n) ê°œìˆ˜ í•©ì‚°
        for (let i = 0; i < startLineIndex; i++) {
            startCharIndex += lines[i].length + 1; // +1ì€ ì¤„ë°”ê¿ˆ ë¬¸ì
        }

        // 2. ë ìœ„ì¹˜ ê³„ì‚°: ì‹œì‘ ìœ„ì¹˜ë¶€í„° ì°¾ì€ ì¤„ ê°œìˆ˜ë§Œí¼ ê¸€ì ìˆ˜ ë”í•˜ê¸°
        // ì£¼ì˜: ì°¾ì€ ëŒ€ìƒì€ ì›ë³¸ ì½”ë“œì—ì„œ ì—°ì†ëœ ì¤„ì´ ì•„ë‹ ìˆ˜ë„ ìˆì§€ë§Œ(ë¹ˆì¤„ ë“±),
        // ì—¬ê¸°ì„œëŠ” í¸ì˜ìƒ í•´ë‹¹ ì¤„ë¶€í„° ì•„ë˜ë¡œ ì­‰ ê¸ì–´ì„œ ì„ íƒí•¨.
        endCharIndex = startCharIndex;
        // ê²€ìƒ‰ëœ ì¤„ì˜ ê°œìˆ˜ê°€ ì•„ë‹ˆë¼, ê²€ìƒ‰ëœ í…ìŠ¤íŠ¸ê°€ ì°¨ì§€í•˜ëŠ” ì‹¤ì œ ì¤„ë§Œí¼ ë”í•´ì•¼ í•¨.
        // í•˜ì§€ë§Œ normalize ë¡œì§ìƒ ì •í™•í•œ ì‹¤ì œ ì¤„ ìˆ˜ë¥¼ ì—­ì‚°í•˜ê¸° ì–´ë ¤ìš°ë¯€ë¡œ,
        // ëŒ€ëµì ìœ¼ë¡œ ì‹œì‘ ì¤„ë¶€í„° ì ë‹¹íˆ ê¸´ ë²”ìœ„ë¥¼ ì¡ê±°ë‚˜,
        // ì—¬ê¸°ì„œëŠ” ì‹¬í”Œí•˜ê²Œ í•´ë‹¹ ì¤„ë¶€í„° ì¼ì • ë²”ìœ„ê¹Œì§€ë§Œ ë³´ì—¬ì¤Œ.
        // (ì •í™•ë„ë¥¼ ìœ„í•´ ê²€ìƒ‰ëœ í…ìŠ¤íŠ¸ ì „ì²´ ê¸¸ì´ë¥¼ ë”í•˜ëŠ” ë°©ì‹ ì‹œë„)
        
        // ê°œì„ : ê·¸ëƒ¥ ì¤„ ë‹¨ìœ„ë¡œ ëª¨ë‘ ë”í•´ë²„ë¦¼
        // í•˜ì§€ë§Œ ì›ë³¸ ì½”ë“œ ì¤‘ê°„ì— ë¹ˆ ì¤„ì´ ë§ìœ¼ë©´ ì˜¤ì°¨ê°€ ìƒê¸¸ ìˆ˜ ìˆìŒ.
        // ì¼ë‹¨ ë°œê²¬ëœ ì¤„ë¶€í„° lineCount ê°œìˆ˜ë§Œí¼ì€ í™•ì‹¤íˆ ì„ íƒ.
        
        // ì‹¤ì œ ì›ë³¸ì—ì„œ ë§¤ì¹­ëœ ë¸”ë¡ì˜ ëì„ ì°¾ì•„ì•¼ í•¨.
        // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ "ì‹œì‘ ì¤„"ë¶€í„° "ê²€ìƒ‰í•œ ì¤„ ê°œìˆ˜" ë§Œí¼ ì„ íƒ.
        // (ë‹¨, ì¤‘ê°„ ë¹ˆ ì¤„ ë•Œë¬¸ì— ì •í™•í•˜ì§€ ì•Šì„ ìˆ˜ ìˆì–´, ë„‰ë„‰í•˜ê²Œ ì¡ëŠ” ë¡œì§ ëŒ€ì‹ 
        //  ì‚¬ìš©ìê°€ ì°¾ê¸° ì‰¬ìš´ 'ì²« ì¤„'ë§Œì´ë¼ë„ í™•ì‹¤íˆ ê°•ì¡°)
        
        // ì„ íƒ ë²”ìœ„ ê³„ì‚° (ì‹œì‘ ì¤„ + ë§¤ì¹­ëœ ì¤„ ìˆ˜)
        // ë§Œì•½ ì›ë³¸ì— ë¹ˆ ì¤„ì´ ì„ì—¬ìˆë‹¤ë©´ ì„ íƒ ë²”ìœ„ê°€ ì§§ì•„ì§ˆ ìˆ˜ ìˆìŒ.
        // ì—¬ê¸°ì„œëŠ” "ì‹œì‘ ì§€ì "ì„ ì •í™•íˆ ë³´ì—¬ì£¼ëŠ” ë° ì§‘ì¤‘.
        
        endCharIndex = startCharIndex + lines[startLineIndex].length; // ì¼ë‹¨ ì²« ì¤„ë§Œ ì„ íƒí•´ë„ ëˆˆì— ë”
        
        // ì—¬ëŸ¬ ì¤„ ì„ íƒ ì‹œë„
        let draggingLine = startLineIndex;
        let linesToSelect = lineCount; 
        
        // ê²€ìƒ‰ì–´ ì¤„ ìˆ˜ ë§Œí¼ ë°˜ë³µí•˜ë©° ê¸¸ì´ ë”í•¨ (ê°„ë‹¨ ë²„ì „)
        for(let k=0; k < lineCount; k++) {
             if(draggingLine < lines.length) {
                 endCharIndex += lines[draggingLine].length; 
                 draggingLine++;
             }
        }
        // ì¤„ë°”ê¿ˆ ë¬¸ì ë³´ì •
        endCharIndex += (lineCount * 1); 

        // 3. ì‹¤ì œ ì„ íƒ(í•˜ì´ë¼ì´íŠ¸) ì‹¤í–‰
        leftArea.focus();
        leftArea.setSelectionRange(startCharIndex, endCharIndex);
        
        // 4. ìŠ¤í¬ë¡¤ ì´ë™ (ì„ íƒëœ ê³³ì´ í™”ë©´ ì¤‘ì•™ì— ì˜¤ë„ë¡)
        const lineHeight = 20; // ëŒ€ëµì ì¸ ì¤„ ë†’ì´ px
        const scrollPos = (startLineIndex * lineHeight) - (leftArea.clientHeight / 2);
        leftArea.scrollTop = scrollPos > 0 ? scrollPos : 0;
    }

    // 1. ì°¾ê¸° ë²„íŠ¼
    function findBlock(inputId) {
        const inputVal = document.getElementById(inputId).value;
        const currentCode = leftArea.value;
        const result = findLineRange(inputVal, currentCode);

        if (result) {
            showMsg(`âœ… ì°¾ì•˜ìŠµë‹ˆë‹¤! (í˜•ê´‘ìƒ‰ ë¶€ë¶„ì„ í™•ì¸í•˜ì„¸ìš”)`);
            // âœ¨ ì—¬ê¸°ì„œ í•˜ì´ë¼ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
            highlightRange(result.start, result.count);
        } else {
            showMsg("âš ï¸ ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    // 2. ì‚­ì œ ì‹¤í–‰
    function deleteBlock() {
        const inputVal = document.getElementById('delTarget').value;
        let currentCode = rightArea.value || leftArea.value; 
        const result = findLineRange(inputVal, currentCode);

        if (result) {
            const lines = currentCode.split('\n');
            let newLines = [];
            const searchLines = inputVal.split('\n').filter(l => l.trim() !== '');

            for (let i = 0; i < lines.length; i++) {
                if (i === result.start) {
                    let matchIdx = 0;
                    let scanning = i;
                    while(matchIdx < searchLines.length && scanning < lines.length) {
                        if (normalize(lines[scanning]) === normalize(searchLines[matchIdx])) {
                            matchIdx++;
                        }
                        scanning++;
                    }
                    i = scanning - 1;
                    showMsg("âœ… ì‚­ì œ ì™„ë£Œ!");
                } else {
                    newLines.push(lines[i]);
                }
            }
            rightArea.value = newLines.join('\n');

        } else {
            showMsg("âš ï¸ ì‚­ì œí•  ì½”ë“œë¥¼ ë³¸ë¬¸ì—ì„œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // 3. ìˆ˜ì • (êµì²´) ì‹¤í–‰
    function replaceBlock() {
        const beforeVal = document.getElementById('modBefore').value;
        const afterVal = document.getElementById('modAfter').value;
        let currentCode = rightArea.value || leftArea.value;
        const result = findLineRange(beforeVal, currentCode);

        if (result) {
            const lines = currentCode.split('\n');
            let newLines = [];
            const searchLines = beforeVal.split('\n').filter(l => l.trim() !== '');

            for (let i = 0; i < lines.length; i++) {
                if (i === result.start) {
                    newLines.push(afterVal);
                    let matchIdx = 0;
                    let scanning = i;
                    while(matchIdx < searchLines.length && scanning < lines.length) {
                        if (normalize(lines[scanning]) === normalize(searchLines[matchIdx])) {
                            matchIdx++;
                        }
                        scanning++;
                    }
                    i = scanning - 1;
                    showMsg("âœ… êµì²´ ì™„ë£Œ!");
                } else {
                    newLines.push(lines[i]);
                }
            }
            rightArea.value = newLines.join('\n');
        } else {
            showMsg("âš ï¸ êµì²´í•  ëŒ€ìƒì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // 4. ì¶”ê°€ ì‹¤í–‰
    function insertBlock() {
        const anchorVal = document.getElementById('addAnchor').value;
        const contentVal = document.getElementById('addContent').value;
        let currentCode = rightArea.value || leftArea.value;
        const result = findLineRange(anchorVal, currentCode);

        if (result) {
             const lines = currentCode.split('\n');
             let newLines = [];
             const searchLines = anchorVal.split('\n').filter(l => l.trim() !== '');
            
            for (let i = 0; i < lines.length; i++) {
                newLines.push(lines[i]); 
                if (i === result.start) {
                    let matchIdx = 1; 
                    let scanning = i + 1;
                    while(matchIdx < searchLines.length && scanning < lines.length) {
                        if (normalize(lines[scanning]) === normalize(searchLines[matchIdx])) {
                            newLines.push(lines[scanning]); 
                            matchIdx++;
                        } else {
                             newLines.push(lines[scanning]);
                        }
                        scanning++;
                    }
                    newLines.push(contentVal);
                    i = scanning - 1; 
                    showMsg("âœ… ì¶”ê°€ ì™„ë£Œ!");
                }
            }
            rightArea.value = newLines.join('\n');
        } else {
             showMsg("âš ï¸ ê¸°ì¤€ ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function showMsg(text) {
        msgArea.innerText = text;
        setTimeout(() => { msgArea.innerText = ""; }, 5000);
    }
</script>

</body>
</html>
