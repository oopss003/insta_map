<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ì „ì²´ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f5f5f5; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 12px; vertical-align: top; }
    th { background: #eee; position: sticky; top: 0; z-index: 1; }
    tr:hover { background: #f0f0f0; }
    select.time-select { width: 80px; font-size: 12px; }
    #storeCount { margin-top: 10px; font-weight: bold; }
    .pagination { margin-top: 20px; text-align: center; }
    .pagination button { margin: 0 4px; padding: 4px 10px; }
  </style>
</head>
<body>
  <h2>ì „ì²´ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ (ê´€ë¦¬ììš©)</h2>
  <div id="storeCount">ë“±ë¡ëœ ë§¤ì¥ ìˆ˜: 0</div>
  <table id="storeTable">
    <thead>
      <tr>
        <th>#</th>
        <th>ë§¤ì¥ì´ë¦„</th>
        <th>ì „í™”</th>
        <th>ìœ„ë„</th>
        <th>ê²½ë„</th>
        <th>ì§€ë„ë…¸ì¶œ</th>
        <th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="pagination" id="pagination"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCVV1XUfsREQYnah3tbEKBTprgq9wRgiic",
      authDomain: "instamap-9b595.firebaseapp.com",
      projectId: "instamap-9b595",
      storageBucket: "instamap-9b595.firebasestorage.app",
      messagingSenderId: "280950399393",
      appId: "1:280950399393:web:8282e0d352e50c8bcd2be0"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const days = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];
    // Firestoreì˜ ì˜ë¬¸ ìš”ì¼ ì•½ì–´ì™€ ë§¤í•‘
    const dayMap = { 'ì›”': 'mon', 'í™”': 'tue', 'ìˆ˜': 'wed', 'ëª©': 'thu', 'ê¸ˆ': 'fri', 'í† ': 'sat', 'ì¼': 'sun' };
    const USER_EMAIL = "jhpark8271@gmail.com";
    const PAGE_SIZE = 30;
    let storeDocs = [];
    let currentPage = 1;

    // Firestore ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    async function updateStoreHours(event) {
      const select = event.target;
      const docId = select.dataset.doc;
      const dayKorean = select.dataset.day;
      const field = select.dataset.field;
      const value = select.value;

      // í•œê¸€ ìš”ì¼ì„ ì˜ë¬¸ ì•½ì–´ë¡œ ë³€í™˜
      const dayEnglish = dayMap[dayKorean];
      if (!dayEnglish) {
        console.error("Invalid day:", dayKorean);
        return;
      }

      // Firestore ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ í•„ë“œ ê²½ë¡œ ìƒì„±
      let fieldPath;
      if (field === 'start' || field === 'end') {
        fieldPath = `hours.${dayEnglish}.time.${field}`;
      } else if (field === 'break_start' || field === 'break_end') {
        const breakField = field.split('_')[1]; // "start" or "end"
        fieldPath = `hours.${dayEnglish}.break.${breakField}`;
      } else if (field === 'lastOrder') {
        fieldPath = `hours.${dayEnglish}.lastOrder.time`;
      }

      if (!fieldPath) {
        console.error("Invalid field:", field);
        return;
      }

      try {
        await db.collection("stores").doc(docId).update({
          [fieldPath]: value
        });
        console.log(`Successfully updated ${docId} - ${fieldPath}: ${value}`);
        select.style.backgroundColor = '#d4edda'; // ì„±ê³µ ì‹œ ì´ˆë¡ìƒ‰ìœ¼ë¡œ í‘œì‹œ
        setTimeout(() => { select.style.backgroundColor = ''; }, 1000);
      } catch (error) {
        console.error("Error updating document: ", error);
        select.style.backgroundColor = '#f8d7da'; // ì‹¤íŒ¨ ì‹œ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ
        setTimeout(() => { select.style.backgroundColor = ''; }, 2000);
      }
    }

    function generateTimeOptions(selected) {
      let options = '<option value="">-</option>';
      for (let h = 0; h < 24; h++) { // 24ì‹œê¹Œì§€ë§Œ ìƒì„±
        for (let m of ["00", "30"]) {
          const hour = h.toString().padStart(2, '0');
          const value = `${hour}:${m}`;
          const label = `${hour}:${m}`;
          options += `<option value="${value}" ${selected === value ? 'selected' : ''}>${label}</option>`;
        }
      }
      return options;
    }

    function createTimeCell(day, h, docId) {
      return `
        <div>
          â° <select class="time-select" data-doc="${docId}" data-day="${day}" data-field="start">${generateTimeOptions(h.time?.start)}</select>
             ~
             <select class="time-select" data-doc="${docId}" data-day="${day}" data-field="end">${generateTimeOptions(h.time?.end)}</select>
        </div>
        <div>
          â˜• <select class="time-select" data-doc="${docId}" data-day="${day}" data-field="break_start">${generateTimeOptions(h.break?.start)}</select>
             ~
             <select class="time-select" data-doc="${docId}" data-day="${day}" data-field="break_end">${generateTimeOptions(h.break?.end)}</select>
        </div>
        <div>
          ğŸ•˜ <select class="time-select" data-doc="${docId}" data-day="${day}" data-field="lastOrder">${generateTimeOptions(h.lastOrder?.time)}</select>
        </div>
      `;
    }

    function renderTable(page) {
      const tbody = document.querySelector("#storeTable tbody");
      tbody.innerHTML = "";
      const start = (page - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const items = storeDocs.slice(start, end);

      items.forEach((doc, index) => {
        const d = doc.data();
        const tr = document.createElement("tr");
        const display = (d.lat && d.lng) ? "O" : "X";
        
        // Firestoreì˜ ì˜ë¬¸ ì•½ì–´ í‚¤ë¡œ ë°ì´í„° ì ‘ê·¼
        const hoursCells = days.map(day => {
          const dayKey = dayMap[day]; // 'ì›”' -> 'mon'
          const h = d.hours?.[dayKey] || { time:{}, break:{}, lastOrder:{} };
          return `<td>${createTimeCell(day, h, doc.id)}</td>`;
        }).join("");

        tr.innerHTML = `
          <td>${start + index + 1}</td>
          <td>${d.name || ''}</td>
          <td>${d.phone || ''}</td>
          <td>${d.lat || ''}</td>
          <td>${d.lng || ''}</td>
          <td>${display}</td>
          ${hoursCells}
        `;
        tbody.appendChild(tr);
      });
      renderPagination();
    }

    function renderPagination() {
      const totalPages = Math.ceil(storeDocs.length / PAGE_SIZE);
      const container = document.getElementById("pagination");
      container.innerHTML = "";

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === currentPage) btn.disabled = true;
        btn.addEventListener("click", () => {
          currentPage = i;
          renderTable(currentPage);
        });
        container.appendChild(btn);
      }
    }

    async function loadStores() {
      const snapshot = await db.collection("stores").get();
      storeDocs = snapshot.docs;
      document.getElementById("storeCount").textContent = `ë“±ë¡ëœ ë§¤ì¥ ìˆ˜: ${storeDocs.length}`;
      renderTable(currentPage);
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (USER_EMAIL === "jhpark8271@gmail.com") {
        loadStores();
        
        // ì´ë²¤íŠ¸ ìœ„ì„ì„ ì‚¬ìš©í•˜ì—¬ í…Œì´ë¸”ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.getElementById('storeTable').addEventListener('change', (event) => {
          if (event.target.classList.contains('time-select')) {
            updateStoreHours(event);
          }
        });

      } else {
        document.body.innerHTML = '<h3>ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</h3>';
      }
    });
  </script>
</body>
</html>
