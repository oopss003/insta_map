<!DOCTYPE html>
<html lang="ko">
<head><meta charset="UTF-8"><title>구글 로그인 중...</title></head>
<body>
  <p>로그인 처리 중입니다...</p>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCVYV1UxfSREQYnah3tBEKBTprgq9wRgii",
      authDomain: "instamap-9b595.firebaseapp.com",
      projectId: "instamap-9b595",
      storageBucket: "instamap-9b595.firebasestorage.app",
      messagingSenderId: "280950399933",
      appId: "1:280950399933:web:8282e0d352e50c8bcd2be0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // URL에서 access_token 및 id_token 추출
    const params = new URLSearchParams(window.location.hash.substring(1));
    const idToken = params.get("id_token");

    if (!idToken) {
      alert("로그인에 실패했습니다.");
    } else {
      const decoded = jwt_decode(idToken);
      const email = decoded.email;
      const name = decoded.name;

      const docRef = db.collection("users").doc(email.toLowerCase());

      docRef.get({ source: 'server' }).then(doc => {
        const agreed = doc.exists && doc.data()?.agreedToTerms === true;

        db.collection("users").doc(email.toLowerCase()).set({
          nickname: name,
          email: email.toLowerCase(),
          provider: 'google',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }).then(() => {
          if (agreed) {
            location.href = "/mypage.html";
          } else {
            location.href = "/terms.html";  // 약관 동의 페이지로 이동
          }
        });
      });
    }
  </script>
</body>
</html>

