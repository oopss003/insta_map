<!DOCTYPE html>
<html lang="ko">
<head>
Â  <meta charset="UTF-8" />
Â  <title>êµ¬ê¸€ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...</title>

Â  <!-- Firebase SDK -->
Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

Â  <!-- JWT ë””ì½”ë” -->
Â  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>

Â  <!-- ë””ìì¸ìš© CSS (ë³€ê²½ ê¸ˆì§€) -->
Â  <style>
    html, body {
      /* bodyê°€ í™”ë©´ ì „ì²´ ë†’ì´ë¥¼ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
      height: 100%;
      margin: 0;
      padding: 0;
    }
          
    body {
      Â background-color: #f5f6fb;
       /* 1. bodyë¥¼ flex ì»¨í…Œì´ë„ˆë¡œ ë§Œë“­ë‹ˆë‹¤. */
       display: flex;
       /* 2. ê°€ë¡œ ë°©í–¥ ì¤‘ì•™ ì •ë ¬ */
      Â justify-content: center;
       /* 3. ì„¸ë¡œ ë°©í–¥ ì¤‘ì•™ ì •ë ¬ */
      Â align-items: center;
    }

Â  Â  .loading-gif {
Â  Â  Â  width: 100px;
Â  Â  Â  height: 100px;
Â  Â  Â  object-fit: contain;
Â  Â  }
Â  </style>
</head>
<body>
Â  <img src="images/duck.gif" alt="ë¡œë”© ì¤‘..." class="loading-gif" />

Â  <script>
Â  Â  console.log("ğŸ§­ User Agent:", navigator.userAgent);

Â  Â  // âœ… ê¸°ëŠ¥: ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ â€” Firebase ì´ˆê¸°í™”
Â  Â  const firebaseConfig = {
      apiKey: "AIzaSyDjxFnP5wEE6ivH6VSUHsu8nR_X8GkARB0",
      authDomain: "twopage-ea909.firebaseapp.com",
      projectId: "twopage-ea909",
      storageBucket: "twopage-ea909.firebasestorage.app",
      messagingSenderId: "398686352913",
      appId: "1:398686352913:web:0bb872aa1e71c62ad863b0",
      measurementId: "G-3F5QFJ0D2H"
Â  Â  };
Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.firestore();
Â  Â  const auth = firebase.auth();

Â  Â  // URL í•´ì‹œì—ì„œ id_token ì¶”ì¶œ (ë³€ê²½ ê¸ˆì§€)
Â  Â  const hash = window.location.hash.substring(1);
Â  Â  const params = new URLSearchParams(hash);
Â  Â  const id_token = params.get("id_token");

Â  Â  if (!id_token) {
Â  Â  Â  alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: í† í°ì´ ì—†ìŠµë‹ˆë‹¤.");
Â  Â  Â  location.href = "/login.html";
Â  Â  }

Â  Â  // JWT ë””ì½”ë”© í›„ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ (ë³€ê²½ ê¸ˆì§€)
Â  Â  const decoded = jwt_decode(id_token);
Â  Â  const email = decoded.email;
Â  Â  const nickname = decoded.name;

Â  Â  if (!email) {
Â  Â  Â  alert("ì´ë©”ì¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
Â  Â  Â  location.href = "/login.html";
Â  Â  }

Â  Â  // Firebase ìê²© ì¦ëª… ìƒì„± ë° ë¡œê·¸ì¸ (ë³€ê²½ ê¸ˆì§€)
Â  Â  const credential = firebase.auth.GoogleAuthProvider.credential(id_token);
Â  Â  auth.signInWithCredential(credential)
Â  Â  Â  .then(() => {
Â  Â  Â  Â  // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì´ë©”ì¼ ì €ì¥ (ë³€ê²½ ê¸ˆì§€)
Â  Â  Â  Â  localStorage.setItem("userEmail", email);
Â  Â  Â  Â  const normalizedEmail = email.toLowerCase();

Â  Â  Â  Â  // ì‚¬ìš©ì ì •ë³´ Firestoreì— ì €ì¥ (merge: ì—…ë°ì´íŠ¸ ì ìš©, ë³€ê²½ ê¸ˆì§€)
Â  Â  Â  Â  return db.collection("users").doc(normalizedEmail).set({
Â  Â  Â  Â  Â  email,
Â  Â  Â  Â  Â  nickname,
Â  Â  Â  Â  Â  provider: "google",
Â  Â  Â  Â  Â  createdAt: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  Â  }, { merge: true });
Â  Â  Â  })
Â  Â  Â  .then(() => {
Â  Â  Â  Â  const normalizedEmail = email.toLowerCase();
Â  Â  Â  Â  return db.collection("users").doc(normalizedEmail).get();
Â  Â  Â  })
Â  Â  Â  .then(doc => {
Â  Â  Â  Â  // ì•½ê´€ ë™ì˜ ì—¬ë¶€ í™•ì¸ (ë³€ê²½ ê¸ˆì§€)
Â  Â  Â  Â  const agreed = doc.exists && doc.data().agreedToTerms === true;

Â  Â  Â  Â  // --- âœ… ìˆ˜ì •ëœ ë¶€ë¶„: ì•±(ì›¹ë·°) í™˜ê²½ì´ ì•„ë‹ ê²½ìš°ì—ë§Œ í˜ì´ì§€ ì´ë™ ---
Â  Â  Â  Â  if (!window.ReactNativeWebView) {
Â  Â  Â  Â  Â  if (agreed) {
Â  Â  Â  Â  Â  Â  location.href = "/view_stores.html";
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  location.href = "/terms.html";
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  // ì•± ì•ˆì—ì„œëŠ” í˜ì´ì§€ ì´ë™ì„ í•˜ì§€ ì•Šê³ , ì•„ë˜ ë¦¬ìŠ¤ë„ˆê°€ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
Â  Â  Â  })
Â  Â  Â  .catch(err => {
Â  Â  Â  Â  console.error("âŒ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err.message);
Â  Â  Â  Â  console.error("ğŸ“¦ ì „ì²´ ì—ëŸ¬ ê°ì²´:", err);
Â  Â  Â  Â  alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + err.message);
Â  Â  Â  Â  location.href = "/login.html";
Â  Â  Â  });

Â  Â  // ==============================================
Â  Â  // React Native ì›¹ë·°ë¡œ ë¡œê·¸ì¸ ìƒíƒœ ì „ë‹¬ìš© ì½”ë“œ (ë³€ê²½ ê¸ˆì§€)
Â  Â  firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ëœ ìƒíƒœ â†’ ID í† í° ë°œê¸‰
        user.getIdToken().then(function(idToken) {
          const message = {
            type: 'USER_LOGGED_IN',      // ë©”ì‹œì§€ íƒ€ì…
            token: idToken               // React Native ì¸¡ì— ì „ë‹¬í•  í† í°
          };

          // --- ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„ ì‹œì‘ ğŸ’¡ ---
          console.log("âœ… [ì›¹] ì•±ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ì¤€ë¹„ ì™„ë£Œ");
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify(message));
            console.log("âœ… [ì›¹] ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ!");
          } else {
            console.log("âŒ [ì›¹] ReactNativeWebView í™˜ê²½ì´ ì•„ë‹ˆë¼ì„œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }
          // --- ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„ ë ğŸ’¡ ---
        });
      }
    });
    // ==============================================
  </script>
</body>
</html>
