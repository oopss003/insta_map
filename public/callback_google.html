<!DOCTYPE html>
<html lang="ko">
<head>
Â  <meta charset="UTF-8" />
Â  <title>êµ¬ê¸€ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...</title>

Â  Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

Â  Â  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>

Â  Â  <style>
Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  background-color: #f5f6fb;
Â  Â  Â  height: 100vh;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  }

Â  Â  .loading-gif {
Â  Â  Â  width: 100px;
Â  Â  Â  height: 100px;
Â  Â  Â  object-fit: contain;
Â  Â  }
Â  </style>
</head>
<body>
Â  Â  <img src="images/duck.gif" alt="ë¡œë”© ì¤‘..." class="loading-gif" />

Â  <script>
Â  Â  console.log("ğŸ§­ User Agent:", navigator.userAgent);

Â  Â  // âœ… ê¸°ëŠ¥: ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ â€” Firebase ì´ˆê¸°í™”
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyCVV1XUfsREQYnah3tbEKBTprgq9wRgiic",
Â  Â  Â  authDomain: "instamap-9b595.firebaseapp.com",
Â  Â  Â  projectId: "instamap-9b595",
Â  Â  Â  storageBucket: "instamap-9b595.firebasestorage.app",
Â  Â  Â  messagingSenderId: "280950399393",
Â  Â  Â  appId: "1:280950399393:web:8282e0d352e50c8bcd2be0"
Â  Â  };
Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.firestore();
Â  Â  const auth = firebase.auth();

Â  Â  // URL í•´ì‹œì—ì„œ id_token ì¶”ì¶œ
Â  Â  const hash = window.location.hash.substring(1);
Â  Â  const params = new URLSearchParams(hash);
Â  Â  const id_token = params.get("id_token");

Â  Â  if (!id_token) {
Â  Â  Â  alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: í† í°ì´ ì—†ìŠµë‹ˆë‹¤.");
Â  Â  Â  location.href = "/login.html";
Â  Â  }

Â  Â  // JWT ë””ì½”ë”© í›„ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
Â  Â  const decoded = jwt_decode(id_token);
Â  Â  const email = decoded.email;
Â  Â  const nickname = decoded.name;

Â  Â  if (!email) {
Â  Â  Â  alert("ì´ë©”ì¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
Â  Â  Â  location.href = "/login.html";
Â  Â  }

Â  Â  // Firebase ìê²© ì¦ëª… ìƒì„± ë° ë¡œê·¸ì¸
Â  Â  const credential = firebase.auth.GoogleAuthProvider.credential(id_token);
Â  Â  auth.signInWithCredential(credential)
Â  Â  Â  .then(() => {
Â  Â  Â  Â  // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì´ë©”ì¼ ì €ì¥
Â  Â  Â  Â  localStorage.setItem("userEmail", email);
Â  Â  Â  Â  const normalizedEmail = email.toLowerCase();

Â  Â  Â  Â  // ì‚¬ìš©ì ì •ë³´ Firestoreì— ì €ì¥ (merge: ì—…ë°ì´íŠ¸ ì ìš©)
Â  Â  Â  Â  return db.collection("users").doc(normalizedEmail).set({
Â  Â  Â  Â  Â  email,
Â  Â  Â  Â  Â  nickname,
Â  Â  Â  Â  Â  provider: "google",
Â  Â  Â  Â  Â  createdAt: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  Â  }, { merge: true });
Â  Â  Â  })
Â  Â  Â  .then(() => {
Â  Â  Â  Â  const normalizedEmail = email.toLowerCase();
Â  Â  Â  Â  return db.collection("users").doc(normalizedEmail).get();
Â  Â  Â  })
Â  Â  Â  .then(doc => {
Â  Â  Â  Â  // ì•½ê´€ ë™ì˜ ì—¬ë¶€ í™•ì¸
Â  Â  Â  Â  const agreed = doc.exists && doc.data().agreedToTerms === true;
        
        // --- âœ… ìˆ˜ì •ëœ ë¶€ë¶„ ---
        // ì•±(ì›¹ë·°) í™˜ê²½ì´ ì•„ë‹ ê²½ìš°ì—ë§Œ, ê¸°ì¡´ì²˜ëŸ¼ í˜ì´ì§€ë¥¼ ì´ë™ì‹œí‚µë‹ˆë‹¤.
Â  Â  Â  Â  if (!window.ReactNativeWebView) {
Â  Â  Â  Â  Â  if (agreed) {
Â  Â  Â  Â  Â  Â  location.href = "/view_stores_test.html";
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  location.href = "/terms.html";
Â  Â  Â  Â  Â  }
        }
        // ì•± ì•ˆì—ì„œëŠ” í˜ì´ì§€ ì´ë™ì„ í•˜ì§€ ì•Šê³ , ì•„ë˜ ë¦¬ìŠ¤ë„ˆê°€ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
Â  Â  Â  })
Â  Â  Â  .catch(err => {
Â  Â  Â  Â  console.error("âŒ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err.message);
Â  Â  Â  Â  console.error("ğŸ“¦ ì „ì²´ ì—ëŸ¬ ê°ì²´:", err);
Â  Â  Â  Â  alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + err.message);
Â  Â  Â  Â  location.href = "/login.html";
Â  Â  Â  });

Â  Â  // ==============================================
Â  Â  // React Native ì›¹ë·°ë¡œ ë¡œê·¸ì¸ ìƒíƒœ ì „ë‹¬ìš© ì½”ë“œ (ì´ ë¶€ë¶„ì€ ìˆ˜ì • ì—†ìŒ)
Â  Â  // Firebase Auth ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
Â  Â  firebase.auth().onAuthStateChanged(function(user) {
Â  Â  Â  if (user) {
Â  Â  Â  Â  // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ëœ ìƒíƒœ â†’ ID í† í° ë°œê¸‰
Â  Â  Â  Â  user.getIdToken().then(function(idToken) {
Â  Â  Â  Â  Â  const message = {
Â  Â  Â  Â  Â  Â  type: 'USER_LOGGED_IN',Â  Â  Â  // ë©”ì‹œì§€ íƒ€ì…
Â  Â  Â  Â  Â  Â  token: idTokenÂ  Â  Â  Â  Â  Â  Â  Â // React Native ì¸¡ì— ì „ë‹¬í•  í† í°
Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  // WebView í™˜ê²½ì¸ì§€ í™•ì¸ í›„ ë©”ì‹œì§€ ì „ì†¡
Â  Â  Â  Â  Â  if (window.ReactNativeWebView) {
Â  Â  Â  Â  Â  Â  window.ReactNativeWebView.postMessage(JSON.stringify(message));
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  });
Â  Â  // ==============================================

Â  </script>
</body>
</html>
