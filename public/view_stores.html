<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>저장된 매장 목록</title>

  <!-- Naver Maps SDK -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=qpbrmxiff4"></script>

  <!-- Firebase SDK (compat 모드) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    /* 기본 레이아웃 */
    html,body{width:100%;height:100%;margin:0;font-family:sans-serif;overflow:hidden}
    #map{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1}

    /* 버튼 */
    #locBtn,#toggleBtn{position:fixed;z-index:1002;padding:8px 12px;border:none;border-radius:4px;color:#fff;font-size:13px;cursor:pointer}
    #locBtn{top:10px;left:10px;background:#007bff}
    #toggleBtn{top:10px;right:10px;background:#28a745}

    /* 리스트 패널 (하단 슬라이드) */
    #panel{position:fixed;left:0;right:0;bottom:-65%;height:65%;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -2px 8px rgba(0,0,0,.15);z-index:1000;padding:14px 12px 8px;overflow-y:auto;transition:bottom .3s ease}
    #panel.open{bottom:0}
    .store{padding:6px;border-bottom:1px solid #ddd;cursor:pointer}
    .store:hover{background:#f0f4ff}
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="locBtn">내 위치로 이동</button>
  <button id="toggleBtn">매장 리스트 보기</button>

  <div id="panel">
    <h3 style="margin:0 0 8px 0">매장 리스트</h3>
    <div id="list"></div>
  </div>

<script>
/* ───────── Firebase 초기화 ───────── */
firebase.initializeApp({
  apiKey:"AIzaSyCVYV1UxfSREQYnah3tBEKBTprgq9wRgii",
  authDomain:"instamap-9b595.firebaseapp.com",
  projectId:"instamap-9b595",
  storageBucket:"instamap-9b595.appspot.com",
  messagingSenderId:"280950399933",
  appId:"1:280950399933:web:8282e0d352e50c8bcd2be0"
});
const db=firebase.firestore();

/* ───────── 지도 ───────── */
const map=new naver.maps.Map('map',{center:new naver.maps.LatLng(37.5665,126.9780),zoom:12});

/* ───────── 매장 렌더링 ───────── */
let markers=[];
const listDiv=document.getElementById('list');
async function renderStores(){
  markers.forEach(m=>m.setMap(null));markers=[];listDiv.innerHTML='';
  const snap=await db.collection('stores').orderBy('created','desc').get();
  snap.forEach(doc=>{
    const d=doc.data();
    const lat=parseFloat(d.lat),lng=parseFloat(d.lng);
    if(isNaN(lat)||isNaN(lng))return;
    const marker=new naver.maps.Marker({
      position:new naver.maps.LatLng(lat,lng),
      map,
      icon:{url:'/image/beer-marker.png',size:new naver.maps.Size(32,32),anchor:new naver.maps.Point(16,32)}
    });
    markers.push(marker);
    const info=new naver.maps.InfoWindow({content:`<div style='min-width:180px;padding:6px'><strong>${d.name}</strong><br><a href='https://instagram.com/${d.insta}' target='_blank'>@${d.insta}</a><br>${d.desc||''}</div>`});
    naver.maps.Event.addListener(marker,'click',()=>{info.open(map,marker);});
    const div=document.createElement('div');
    div.className='store';
    div.innerHTML=`<strong>${d.name}</strong><br>@${d.insta}`;
    div.onclick=()=>{map.setCenter(marker.getPosition());map.setZoom(15);info.open(map,marker);};
    listDiv.appendChild(div);
  });
}
renderStores();

/* ───────── 버튼 기능 ───────── */
// 위치 이동
locBtn.addEventListener('click',()=>{
  if(!navigator.geolocation)return alert('GeoLocation 미지원 브라우저');
  navigator.geolocation.getCurrentPosition(p=>{
    const {latitude,longitude}=p.coords;
    map.setCenter(new naver.maps.LatLng(latitude,longitude));
    map.setZoom(15);
    new naver.maps.Marker({position:new naver.maps.LatLng(latitude,longitude),map});
  },()=>alert('위치 권한 필요'));
});
// 리스트 토글
const panel=document.getElementById('panel');
const toggleBtn=document.getElementById('toggleBtn');
let open=false;
function togglePanel(){
  open=!open;
  panel.classList.toggle('open',open);
  toggleBtn.textContent=open?'리스트 숨기기':'매장 리스트 보기';
}

toggleBtn.addEventListener('click',togglePanel);
</script>
</body>
</html>
