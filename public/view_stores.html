<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>저장된 매장 목록</title>

  <!-- Naver Maps SDK -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=qpbrmxiff4"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    /* 전체 및 지도 설정 */
    html, body { height: 100%; margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; }
    #map { position: absolute; top:0; left:0; right:0; bottom:0; z-index: 1; }

    /* 내 위치 버튼 */
    #locBtn {
      position: fixed; top: 10px; left: 10px; z-index: 1002;
      background: #28a745; color: #fff; border: none; padding: 8px 12px;
      border-radius: 4px; cursor: pointer;
    }

    /* 리스트 패널 */
    #listPanel {
      position: fixed; bottom: 0; left: 0; right: 0;
      max-height: 60%; background: #fff;
      border-top: 1px solid #ccc; overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 1000; padding: 10px;
    }
    #listPanel.open { transform: translateY(0); }

    /* 스토어 항목 */
    .store { padding: 6px; border-bottom: 1px solid #ddd; cursor: pointer; }
    .store:hover { background: #f0f4ff; }

    /* 핸들 아이콘 */
    #handle {
      position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
      width: 32px; height: 32px;
      background: url('/image/beer-marker.png') no-repeat center center;
      background-size: 32px 32px;
      cursor: pointer; z-index: 1002;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="locBtn">내 위치로 이동</button>
  <div id="handle" title="매장 리스트 열기"></div>
  <div id="listPanel">
    <h3>매장 리스트</h3>
    <div id="list"></div>
  </div>

  <script>
  // Firebase 초기화
  const firebaseConfig = {
    apiKey: "AIzaSyCVYV1UxfSREQYnah3tBEKBTprgq9wRgii",
    authDomain: "instamap-9b595.firebaseapp.com",
    projectId: "instamap-9b595",
    storageBucket: "instamap-9b595.appspot.com",
    messagingSenderId: "280950399933",
    appId: "1:280950399933:web:8282e0d352e50c8bcd2be0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // 지도 초기화
  const map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(37.5665, 126.9780),
    zoom: 12
  });

  let markers = [];
  const listDiv = document.getElementById('list');

  async function renderStores() {
    // 클리어
    markers.forEach(m => m.setMap(null));
    markers = [];
    listDiv.innerHTML = '';

    const snapshot = await db.collection('stores').orderBy('created','desc').get();
    snapshot.forEach(doc => {
      const s = doc.data();
      const lat = parseFloat(s.lat), lng = parseFloat(s.lng);
      if (isNaN(lat) || isNaN(lng)) return;

      // 마커 32x32
      const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(lat, lng), map: map,
        icon: {
          url: '/image/beer-marker.png',
          size: new naver.maps.Size(32,32),
          anchor: new naver.maps.Point(16,32)
        }
      });
      markers.push(marker);

      const info = new naver.maps.InfoWindow({
        content: `<div><strong>${s.name}</strong><br>@${s.insta}<br>${s.desc||''}</div>`
      });
      naver.maps.Event.addListener(marker,'click',()=> info.open(map, marker));

      // 리스트 항목
      const div = document.createElement('div');
      div.className = 'store';
      div.innerHTML = `<strong>${s.name}</strong><br>@${s.insta}`;
      div.onclick = ()=>{
        map.setCenter(marker.getPosition()); map.setZoom(15); info.open(map, marker);
      };
      listDiv.appendChild(div);
    });
  }

  renderStores();

  // 내 위치 버튼
  document.getElementById('locBtn').addEventListener('click', ()=>{
    if (!navigator.geolocation) return alert('GeoLocation 지원 안됨');
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude:lat,longitude:lng} = pos.coords;
      map.setCenter(new naver.maps.LatLng(lat,lng)); map.setZoom(15);
      new naver.maps.Marker({position:new naver.maps.LatLng(lat,lng), map});
    },()=>alert('위치 권한 필요'));
  });

  // 핸들 클릭 토글
  document.getElementById('handle').addEventListener('click', ()=>{
    document.getElementById('listPanel').classList.toggle('open');
  });
  </script>
</body>
</html>
