<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>저장된 매장 목록</title>

  <!-- Naver Maps SDK -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=qpbrmxiff4"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    /* 전체 레이아웃 */
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

    /* 내 위치/리스트 토글 버튼 */
    #locBtn, #toggleListBtn {
      position: fixed; top: 10px;
      padding: 8px 12px; font-size: 14px;
      border: none; border-radius: 4px;
      color: #fff; cursor: pointer; z-index: 1001;
    }
    #locBtn { left: 10px; background: #28a745; }
    #toggleListBtn { right: 10px; background: #007bff; }

    /* 리스트 패널 */
    #listPanel {
      position: absolute; bottom: 0; left: 0; width: 100%;
      height: 60%; background: #fff;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 1000; overflow-y: auto;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.15);
    }
    #listPanel.open { transform: translateY(0); }
    #listPanel h3 { margin: 16px; }
    .store { padding: 8px 16px; border-bottom: 1px solid #ddd; cursor: pointer; }
    .store:hover { background: #f0f4ff; }

    /* 말풍선(버블) 스타일 */
    .bubble {
      position: relative;
      padding: 8px 12px;
      background: #fff;
      border: 1px solid #000;
      border-radius: 4px;
      min-width: 180px;
      font-size: 14px;
      color: #333;
    }
    .bubble::after {
      content: '';
      position: absolute;
      left: 50%; bottom: -8px;
      margin-left: -8px;
      border-width: 8px 8px 0;
      border-style: solid;
      border-color: #000 transparent transparent transparent;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="locBtn">내 위치로 이동</button>
  <button id="toggleListBtn">매장 리스트 보기</button>
  <div id="listPanel">
    <h3>매장 리스트</h3>
    <div id="list"></div>
  </div>

  <script>
  // Firebase 초기화
  firebase.initializeApp({
    apiKey: "AIzaSyCVYV1UxfSREQYnah3tBEKBTprgq9wRgii",
    authDomain: "instamap-9b595.firebaseapp.com",
    projectId: "instamap-9b595",
    storageBucket: "instamap-9b595.appspot.com",
    messagingSenderId: "280950399933",
    appId: "1:280950399933:web:8282e0d352e50c8bcd2be0"
  });
  const db = firebase.firestore();

  // 지도 초기화
  const map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(37.5665, 126.9780), zoom: 12
  });
  let markers = [];
  const listDiv = document.getElementById('list');

  // 매장 렌더
  async function renderStores() {
    markers.forEach(m => m.setMap(null)); markers = [];
    listDiv.innerHTML = '';
    const snapshot = await db.collection('stores').orderBy('created','desc').get();
    snapshot.forEach(doc => {
      const s = doc.data();
      const lat = parseFloat(s.lat), lng = parseFloat(s.lng);
      if (isNaN(lat)||isNaN(lng)) return;
      // 마커 생성
      const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(lat, lng), map: map,
        icon: { url: 'https://insta-map-three.vercel.app/image/beer-marker.png', size: new naver.maps.Size(32,32), anchor: new naver.maps.Point(16,32) }
      });
      markers.push(marker);
      // InfoWindow (default border 제거)
      const info = new naver.maps.InfoWindow({
        content: `<div class="bubble"><strong>${s.name}</strong><br><a href="https://instagram.com/${s.insta}" target="_blank">@${s.insta}</a><br>${s.desc||''}</div>`,
        borderWidth: 0, backgroundColor: 'transparent', anchorSize: new naver.maps.Size(0,0)
      });
      naver.maps.Event.addListener(marker,'click',()=> info.open(map,marker));
      // 사이드 리스트 추가
      const div = document.createElement('div'); div.className='store'; div.innerHTML=`<strong>${s.name}</strong><br>@${s.insta}`;
      div.onclick=()=>{ map.setCenter(marker.getPosition()); map.setZoom(15); info.open(map,marker); };
      listDiv.appendChild(div);
    });
  }
  renderStores();

  // 버튼 이벤트
  document.getElementById('locBtn').addEventListener('click', ()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude, lng=pos.coords.longitude;
      map.setCenter(new naver.maps.LatLng(lat,lng)); map.setZoom(15);
      new naver.maps.Marker({position:new naver.maps.LatLng(lat,lng),map});
    },()=>alert('위치 권한 필요'));
  });
  document.getElementById('toggleListBtn').addEventListener('click',()=>{
    document.getElementById('listPanel').classList.toggle('open');
  });
  </script>
</body>
</html>
