<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>가게 등록</title>

  <!-- 네이버 지도 -->
  <script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=qpbrmxiff4""></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    body{font-family:sans-serif;max-width:640px;margin:24px auto;padding:0 12px}
    #map{width:100%;height:320px;border:1px solid #ccc;border-radius:6px;margin-bottom:16px}
    label{display:block;margin-top:12px;font-weight:700}
    input,textarea{width:100%;padding:8px;margin-top:4px;border:1px solid #bbb;border-radius:4px;font-size:14px}
    button{margin-top:14px;padding:10px 18px;font-size:15px;border:none;border-radius:4px;cursor:pointer}
    #getLocBtn{background:#28a745;color:#fff}
    #saveBtn{background:#2d8cff;color:#fff}
  </style>
</head>
<body>
  <h2>📍 가게 등록</h2>
  <div id="map"></div>

  <button id="getLocBtn">현재 위치 가져오기</button>

  <form id="storeForm" onsubmit="return false;">
    <label>가게 이름</label>
    <input name="name" required />

    <label>인스타그램 ID (@ 제외)</label>
    <input name="insta_id" required />

    <label>가게 설명</label>
    <textarea name="desc" rows="4"></textarea>

    <label>위도</label>
    <input id="lat" readonly required />

    <label>경도</label>
    <input id="lng" readonly required />

    <button id="saveBtn" type="submit">저장</button>
  </form>

<script>
  // 1) Firebase 초기화
  const firebaseConfig = {
    apiKey: "AIzaSyCVYV1UxfSREQYnah3tBEKBTprgq9wRgii",
    authDomain: "instamap-9b595.firebaseapp.com",
    projectId: "instamap-9b595",
    storageBucket: "instamap-9b595.appspot.com",
    messagingSenderId: "280950399933",
    appId: "1:280950399933:web:8282e0d352e50c8bcd2be0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // 2) 네이버 지도 초기화
  const map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(37.5665, 126.9780),
    zoom: 15
  });
  let marker = null;
  let infoWindow = null;

  // 3) 프로필 아바타 URL 가져오기
  async function fetchAvatar(id) {
    if (!id) return '';
    try {
      const res = await fetch(`https://unavatar.io/instagram/${id}?json`);
      if (!res.ok) return '';
      const { url } = await res.json();
      return url || '';
    } catch {
      return '';
    }
  }

  // 4) 말풍선(InfoWindow) 내용 갱신
  async function refreshInfo() {
    if (!marker) return;
    const name = document.querySelector('[name=name]').value.trim();
    const insta = document.querySelector('[name=insta_id]').value.trim();
    const desc = document.querySelector('[name=desc]').value.trim();
    const avatarUrl = await fetchAvatar(insta);

    const html = `
      <div style="display:flex;align-items:flex-start;gap:8px;min-width:180px">
        <div style="flex:1;max-width:120px">
          <strong>${name}</strong><br>
          ${insta ? `<a href=\"https://instagram.com/${insta}\" target=\"_blank\">@${insta}</a><br>` : ''}
          ${desc}
        </div>
        <img src="${avatarUrl}" style="width:60px;height:60px;border-radius:50%;object-fit:cover" onerror="this.style.display='none'">
      </div>`;

    if (!infoWindow) {
      infoWindow = new naver.maps.InfoWindow({
        pixelOffset: new naver.maps.Point(0, -40)
      });
    }
    infoWindow.setContent(html);
    infoWindow.open(map, marker);
  }

  // 5) 기존 저장된 가게 불러오기
  db.collection('stores').get().then(snapshot => {
    snapshot.forEach(doc => {
      const d = doc.data();
      const savedMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(d.lat, d.lng),
        map: map,
        icon: {
          url: 'https://insta-map-three.vercel.app/image/beer-marker.png',
          size: new naver.maps.Size(32, 32),
          anchor: new naver.maps.Point(16, 32)
        }
      });
      naver.maps.Event.addListener(savedMarker, 'click', async () => {
        const avatarUrl = await fetchAvatar(d.insta);
        const html = `
          <div style="display:flex;align-items:flex-start;gap:8px;min-width:180px">
            <div style="flex:1;max-width:120px">
              <strong>${d.name}</strong><br>
              <a href=\"https://instagram.com/${d.insta}\" target=\"_blank\">@${d.insta}</a><br>
              ${d.desc}
            </div>
            <img src="${avatarUrl}" style="width:60px;height:60px;border-radius:50%;object-fit:cover" onerror="this.style.display='none'">
          </div>`;
        if (!infoWindow) {
          infoWindow = new naver.maps.InfoWindow({ pixelOffset: new naver.maps.Point(0, -40) });
        }
        infoWindow.setContent(html);
        infoWindow.open(map, savedMarker);
      });
    });
  });

  // 6) 위치 설정 함수 (새 마커 찍기 + 말풍선)
  function setLatLng(lat, lng) {
    document.getElementById('lat').value = lat;
    document.getElementById('lng').value = lng;
    if (marker) marker.setMap(null);
    marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(lat, lng),
      map: map,
      icon: {
        url: 'https://insta-map-three.vercel.app/image/beer-marker.png',
        size: new naver.maps.Size(32, 32),
        anchor: new naver.maps.Point(16, 32)
      }
    });
  }
  // 마커 찍을 때마다 말풍선 열기
  const _oldSetLatLng = setLatLng;
  setLatLng = function(lat, lng) {
    _oldSetLatLng(lat, lng);
    refreshInfo();
  };

  // 7) 지도 클릭 이벤트
  naver.maps.Event.addListener(map, 'click', e => {
    setLatLng(e.coord.lat(), e.coord.lng());
  });

  // 8) 현재 위치 버튼
  document.getElementById('getLocBtn').onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
      setLatLng(pos.coords.latitude, pos.coords.longitude);
      map.setCenter(new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
    }, () => alert('위치 권한을 허용해주세요.'));
  };

  // 9) Firestore 저장
  document.getElementById('storeForm').addEventListener('submit', async () => {
    const store = {
      name: document.querySelector('[name=name]').value.trim(),
      insta: document.querySelector('[name=insta_id]').value.trim(),
      desc: document.querySelector('[name=desc]').value.trim(),
      lat: parseFloat(document.getElementById('lat').value),
      lng: parseFloat(document.getElementById('lng').value),
      created: firebase.firestore.FieldValue.serverTimestamp()
    };
    if (!store.name || !store.insta || isNaN(store.lat) || isNaN(store.lng)) {
      return alert('필수 항목을 모두 입력해주세요.');
