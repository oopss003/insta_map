<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>가게 등록</title>
  <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
  <script>
    Kakao.init('4e1dd9cccad37f9748bb3a3254b88491');
    console.log('Kakao SDK Initialized:', Kakao.isInitialized());
  </script>
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=qpbrmxiff4"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    body{font-family:sans-serif;max-width:640px;margin:24px auto;padding:0 12px}
    #map{width:100%;height:320px;border:1px solid #ccc;border-radius:6px;margin-bottom:16px}
    label{display:block;margin-top:12px;font-weight:700}
    input,textarea,select{width:100%;padding:8px;margin-top:4px;border:1px solid #bbb;border-radius:4px;font-size:14px}
    button{margin-top:14px;padding:10px 18px;font-size:15px;border:none;border-radius:4px;cursor:pointer}
    #getLocBtn{background:#28a745;color:#fff}
    #saveBtn{background:#2d8cff;color:#fff}
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    #authButtons button {
      background: #FEE500;
      border: none;
      border-radius: 8px;
      padding: 8px 10px;
      margin-left: 6px;
      cursor: pointer;
      font-weight: bold;
     display: flex;
    align-items: center;
  }

  #authButtons button img {
    height: 20px;
    margin-right: 6px;
  }

  #kakaoLogoutBtn {
    background: #ddd;
  }
  </style>
</head>
<body>
<div id="header">
  <h2>📍 가게 등록</h2>
  <div id="authButtons">
    <button id="kakaoLoginBtn">
      <img src="https://developers.kakao.com/assets/img/about/logos/kakaologin/logo_kakaoLogin_small.png" alt="카카오 로그인">
      <span>카카오로 로그인</span>
    </button>
    <button id="kakaoLogoutBtn" style="display:none;">로그아웃</button>
  </div>
</div>

<div id="map"></div>
<button id="getLocBtn">현재 위치 가져오기</button>

  <form id="storeForm" onsubmit="return false;">
    <label>가게 이름</label>
    <input name="name" required />
    <label>인스타그램 ID (@ 제외)</label>
    <input name="insta_id" required />
    <label>가게 설명</label>
    <textarea name="desc" rows="4"></textarea>
    <label>위도</label>
    <input id="lat" readonly required />
    <label>경도</label>
    <input id="lng" readonly required />
    <button id="saveBtn" type="submit">저장</button>
  </form>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCVYV1UxfSREQYnah3tBEKBTprgq9wRgii",
  authDomain: "instamap-9b595.firebaseapp.com",
  projectId: "instamap-9b595",
  storageBucket: "instamap-9b595.appspot.com",
  messagingSenderId: "280950399933",
  appId: "1:280950399933:web:8282e0d352e50c8bcd2be0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let isLoggedIn = false;

const map = new naver.maps.Map('map',{
  center: new naver.maps.LatLng(37.5665,126.9780),
  zoom: 15
});
let marker = null;

function setLatLng(lat, lng){
  document.getElementById('lat').value = lat;
  document.getElementById('lng').value = lng;
  if(marker) marker.setMap(null);
  marker = new naver.maps.Marker({
    position: new naver.maps.LatLng(lat, lng),
    map: map,
    icon: {
      url: 'https://insta-map-three.vercel.app/image/beer-marker.png',
      size: new naver.maps.Size(32, 32),
      anchor: new naver.maps.Point(16, 32)
    }
  });
}

naver.maps.Event.addListener(map, 'click', e => {
  setLatLng(e.coord.lat(), e.coord.lng());
});

document.getElementById('getLocBtn').onclick = () => {
  navigator.geolocation?.getCurrentPosition(pos => {
    const {latitude, longitude} = pos.coords;
    setLatLng(latitude, longitude);
    map.setCenter(new naver.maps.LatLng(latitude, longitude));
  }, ()=>alert('위치 권한을 허용해주세요.'));
};

document.getElementById('kakaoLoginBtn').addEventListener('click', () => {
  Kakao.Auth.login({
    scope: 'profile_nickname, account_email',
    success: function(authObj) {
      console.log('✅ 로그인 성공', authObj);
      Kakao.API.request({
        url: '/v2/user/me',
        success: function(res) {
          const kakaoAccount = res.kakao_account;
          const nickname = kakaoAccount.profile.nickname;
          alert(`안녕하세요, ${nickname}님!`);
          isLoggedIn = true;
          document.getElementById('kakaoLoginBtn').style.display = 'none';
          document.getElementById('kakaoLogoutBtn').style.display = 'inline-block';
        },
        fail: function(error) {
          console.error('❌ 사용자 정보 요청 실패:', error);
        }
      });
    },
    fail: function(err) {
      console.error('❌ 로그인 실패:', err);
    }
  });
});

document.getElementById('kakaoLogoutBtn').addEventListener('click', () => {
  Kakao.Auth.logout(() => {
    alert('로그아웃 되었습니다.');
    isLoggedIn = false;
    document.getElementById('kakaoLoginBtn').style.display = 'inline-block';
    document.getElementById('kakaoLogoutBtn').style.display = 'none';
  });
});

document.getElementById('storeForm').addEventListener('submit', async () => {
  if (!isLoggedIn) {
    alert('로그인 후 등록이 가능합니다.');
    return;
  }
  const store = {
    name    : document.querySelector('[name=name]').value.trim(),
    insta   : document.querySelector('[name=insta_id]').value.trim(),
    desc    : document.querySelector('[name=desc]').value.trim(),
    lat     : parseFloat(document.getElementById('lat').value),
    lng     : parseFloat(document.getElementById('lng').value),
    created : firebase.firestore.FieldValue.serverTimestamp()
  };
  if (!store.name || !store.insta || isNaN(store.lat) || isNaN(store.lng)) {
    alert('필수 항목을 모두 입력해주세요.');
    return;
  }
  try {
    await db.collection('stores').add(store);
    alert('Firebase에 저장되었습니다!');
    document.getElementById('storeForm').reset();
    if(marker) marker.setMap(null);
  } catch(err) {
    console.error(err);
    alert('저장 중 오류가 발생했습니다.');
  }
});
</script>
</body>
</html>
