<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ê°€ê²Œ ë“±ë¡</title>

  <!-- ë„¤ì´ë²„ ì§€ë„ -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=qpbrmxiff4"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    body{font-family:sans-serif;max-width:640px;margin:24px auto;padding:0 12px}
    #map{width:100%;height:320px;border:1px solid #ccc;border-radius:6px;margin-bottom:16px}
    label{display:block;margin-top:12px;font-weight:700}
    input,textarea,select{width:100%;padding:8px;margin-top:4px;border:1px solid #bbb;border-radius:4px;font-size:14px}
    button{margin-top:14px;padding:10px 18px;font-size:15px;border:none;border-radius:4px;cursor:pointer}
    #getLocBtn{background:#28a745;color:#fff}
    #saveBtn{background:#2d8cff;color:#fff}
    /* ë””ë²„ê·¸ìš© ì´ë¯¸ì§€ ìˆ¨ê¸°ë ¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ */
    /* #avatarDebug { display: none; } */
  </style>
</head>
<body>
  <h2>ğŸ“ ê°€ê²Œ ë“±ë¡</h2>
  <div id="map"></div>
  <button id="getLocBtn">í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°</button>

  <form id="storeForm" onsubmit="return false;">
    <label>ê°€ê²Œ ì´ë¦„</label>
    <input name="name" required />

    <label>ì¸ìŠ¤íƒ€ê·¸ë¨ ID (@ ì œì™¸)</label>
    <input name="insta_id" required />

    <label>ê°€ê²Œ ì„¤ëª…</label>
    <textarea name="desc" rows="4"></textarea>

    <label>ìœ„ë„</label>
    <input id="lat" readonly required />

    <label>ê²½ë„</label>
    <input id="lng" readonly required />

    <button id="saveBtn" type="submit">ì €ì¥</button>
  </form>

  <!-- â–¼ ë””ë²„ê·¸ìš© í”„ë¡œí•„ ë¯¸ë¦¬ë³´ê¸° (í•„ìš” ì—†ìœ¼ë©´ CSS ì£¼ì„ ì²˜ë¦¬) -->
  <img id="avatarDebug"
       style="display:block;width:60px;height:60px;border:1px solid #ccc;border-radius:50%;margin:12px auto;"
       alt="ì•„ë°”íƒ€ ë””ë²„ê·¸">

<script>
  ////////////////////////
  // 1) Firebase ì´ˆê¸°í™” //
  ////////////////////////
  const firebaseConfig = {
    apiKey: "AIzaSyCVYV1UxfSREQYnah3tBEKBTprgq9wRgii",
    authDomain: "instamap-9b595.firebaseapp.com",
    projectId: "instamap-9b595",
    storageBucket: "instamap-9b595.appspot.com",
    messagingSenderId: "280950399933",
    appId: "1:280950399933:web:8282e0d352e50c8bcd2be0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  ////////////////////////////////
  // 2) ë„¤ì´ë²„ ì§€ë„ & ë§ˆì»¤ ë¡œì§ //
  ////////////////////////////////
  const map = new naver.maps.Map('map',{
    center: new naver.maps.LatLng(37.5665,126.9780),
    zoom: 15
  });
  let marker = null;

  function setLatLng(lat, lng){
    document.getElementById('lat').value = lat;
    document.getElementById('lng').value = lng;
    if(marker) marker.setMap(null);

    marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(lat, lng),
      map: map,
      icon: {
        url: 'https://insta-map-three.vercel.app/image/beer-marker.png',
        size: new naver.maps.Size(32, 32),
        anchor: new naver.maps.Point(16, 32)
      }
    });
  }

  naver.maps.Event.addListener(map, 'click', e => {
    setLatLng(e.coord.lat(), e.coord.lng());
  });
  document.getElementById('getLocBtn').onclick = () => {
    navigator.geolocation?.getCurrentPosition(pos => {
      setLatLng(pos.coords.latitude, pos.coords.longitude);
      map.setCenter(new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
    }, ()=>alert('ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.'));
  };

  //////////////////////////////////////////
  // 3) ì¸ìŠ¤íƒ€ í”„ë¡œí•„ ì›í˜• ì´ë¯¸ì§€ í•¨ìˆ˜ë“¤ //
  //////////////////////////////////////////
  // 3-1) ì•„ë°”íƒ€ URL ê°€ì ¸ì˜¤ê¸°
  async function fetchAvatar(id){
    if(!id) return '';
    try {
      const r = await fetch(`https://unavatar.io/instagram/${id}?json`);
      if(!r.ok) return '';
      const {url} = await r.json();
      return url || '';
    } catch {
      return '';
    }
  }

  let infoWindow = null;

  // 3-2) ë§í’ì„  ë‚´ìš© ê°±ì‹  (ì´ë¯¸ì§€ í¬í•¨)
  async function refreshInfo(){
    if(!marker) return;

    const name  = document.querySelector('[name=name]').value.trim();
    const insta = document.querySelector('[name=insta_id]').value.trim();
    const desc  = document.querySelector('[name=desc]').value.trim();
    const avatarUrl = await fetchAvatar(insta);

    // â†’ ë””ë²„ê·¸ìš© ì´ë¯¸ì§€ì— URL ì„¸íŒ…
    const dbg = document.getElementById('avatarDebug');
    dbg.src = avatarUrl;
    dbg.alt = avatarUrl ? 'Avatar loaded' : 'No avatar';

    // â†’ InfoWindow HTML
    const html = `
      <div style="display:flex;align-items:flex-start;gap:8px;min-width:180px">
        <div style="flex:1;max-width:120px">
          <strong>${name}</strong><br>
          ${insta ? `<a href="https://instagram.com/${insta}" target="_blank">@${insta}</a><br>` : ''}
          ${desc}
        </div>
        <img src="${avatarUrl}" 
             style="width:60px;height:60px;border-radius:50%;object-fit:cover"
             onerror="this.style.display='none'">
      </div>`;

    if(!infoWindow){
      infoWindow = new naver.maps.InfoWindow({
        pixelOffset: new naver.maps.Point(0, -40)
      });
    }
    infoWindow.setContent(html);
    infoWindow.open(map, marker);
  }

  // 3-3) ì…ë ¥ê°’ ë°”ë€” ë•Œë§ˆë‹¤ ë§í’ì„  ê°±ì‹ 
  ['name','insta_id','desc'].forEach(field=>{
    document.querySelector(`[name=${field}]`)
            .addEventListener('input', refreshInfo);
  });

  // 3-4) ë§ˆì»¤ ì°ì„ ë•Œë„ ë§í’ì„  ê°±ì‹ 
  const _oldSetLatLng = setLatLng;
  setLatLng = function(lat, lng){
    _oldSetLatLng(lat, lng);
    refreshInfo();
  };

  ///////////////////////////
  // 4) Firestore ì €ì¥ ë¡œì§ //
  ///////////////////////////
  document.getElementById('storeForm').addEventListener('submit', async () => {
    const store = {
      name  : document.querySelector('[name=name]').value.trim(),
      insta : document.querySelector('[name=insta_id]').value.trim(),
      desc  : document.querySelector('[name=desc]').value.trim(),
      lat   : parseFloat(document.getElementById('lat').value),
      lng   : parseFloat(document.getElementById('lng').value),
      created: firebase.firestore.FieldValue.serverTimestamp()
    };
    if(!store.name||!store.insta||isNaN(store.lat)||isNaN(store.lng)){
      return alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    }
    try {
      await db.collection('stores').add(store);
      alert('Firebaseì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      document.getElementById('storeForm').reset();
      if(marker) marker.setMap(null);
    } catch(err){
      console.error(err);
      alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  });
</script>
</body>
</html>
