<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>ê°€ê²Œ ë“±ë¡</title>

  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=qpbrmxiff4"></script>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <style>
  body {
    font-family: 'Pretendard', sans-serif;
    background: #f5f6fb;
    margin: 0 auto;
    padding: 0;
    max-width: 480px;
  }

  #header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    box-sizing: border-box;
  }

  .back-button {
    width: 77px;
    height: 77px;
    border-radius: 16px;
    background: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 28px;
    text-decoration: none;
    color: #000;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
  }

  .store-button {
    width: 255px;
    height: 77px;
    border-radius: 16px;
    background: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 16px;
    font-weight: 600;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
  }

  #header h2 {
    font-size: 18px;
    margin: 0;
  }

  #map {
    width: 344px;
    height: 344px;
    margin: 0 auto 16px;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
  }

  .btn-group {
    width: 344px;
    margin: 0 auto 16px;
    display: flex;
    justify-content: space-between;
    gap: 8px;
  }

  .main-btn {
    height: 35px;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 600;
    padding: 0 16px;
    border: none;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    flex: 1;
  }

  #getLocBtn {
    background: #0F9ED5;
    color: white;
  }

  #helpVideoBtn {
    background: #999;
    color: white;
  }

  form#storeForm {
    width: 100%;
    max-width: 344px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center; /* ğŸ”¥ ì¤‘ì•™ ì •ë ¬ í•µì‹¬ */
    gap: 12px;
  }

  form#storeForm label {
    font-weight: 700;
    margin-top: 12px;
  }

  input,
  textarea,
  select {
    width: 100%;
    padding: 14px;
    border-radius: 16px;
    border: 1px solid #ddd;
    font-size: 15px;
    background: #fff;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
  }

  textarea {
    resize: none;
  }

  .off-days {
    display: grid;
    grid-template-columns: repeat(4, 77px);
    gap: 12px;
    justify-content: center;
    margin-top: 8px;
    margin-bottom: 20px;
  }

  .off-days label {
    width: 77px;
    height: 77px;
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    font-weight: 600;
    font-size: 16px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease
  }

  .off-days input[type="checkbox"] {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 16px;
    height: 16px;
  }
    
  #saveBtn {
    width: 100%;
    background: #2d8cff;
    color: #fff;
    margin-top: 24px;
    padding: 16px;
    font-size: 16px;
    border-radius: 16px;
    border: none;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
  }
  .custom-field-box {
    width: 344px;
    height: 77px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    padding: 8px 12px;
    box-sizing: border-box;
    margin-bottom: 12px; /
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    gap: 4px;
  }

  .custom-field-box label {
    font-size: 13px;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  .custom-field-box input,
  .custom-field-box textarea,
  .custom-field-box select {
    border: none;
    outline: none;
    font-size: 15px;
    padding: 4px 0;
    background: none;
    resize: none;
  }

  .custom-field-box select {
    width: 100%;
    height: 36px;
    padding: 4px 8px;
    border: none;
    background: transparent;
    font-size: 15px;
    color: #000;
    appearance: none; /* ê¸°ë³¸ ì…€ë ‰íŠ¸ í™”ì‚´í‘œ ì œê±° */
    -webkit-appearance: none;
    -moz-appearance: none;
  }
  .off-days {
    display: grid;
    grid-template-columns: repeat(4, 77px);
    gap: 12px;
    justify-content: center;
    margin-bottom: 12px;
  }

  .off-days label {
    width: 77px;
    height: 77px;
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    font-weight: 600;
    font-size: 16px;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    text-align: center;
  }
  .custom-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 344px;
    height: 77px;
    margin: 0 auto 16px;
    gap: 12px;
   }

  .back-button {
    width: 77px;
    height: 77px;
    border-radius: 20px;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    font-size: 24px;
  }

  .greeting-box {
    flex: 1;
    height: 77px;
    background: #fff;
    border-radius: 20px;
    padding: 12px 16px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    display: flex;
    flex-direction: column;
    justify-content: center;
    box-sizing: border-box;
  }

  .greeting-title {
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 4px;
  }

  .greeting-sub {
    font-size: 14px;
    color: #888;
    line-height: 1.4;
  }

  </style>

</head>
<body>
    <div id="loadingOverlay" style="display:none;">
    <div class="spinner"></div>
  </div>
  <div id="header" class="custom-header">
    <a href="https://inwave.ai.kr/view_stores.html" class="back-button" aria-label="ë’¤ë¡œê°€ê¸°">
      <span>&lt;</span>
    </a>
    
    <div class="greeting-box">
      <div class="greeting-title">ë§¤ì¥ ë“±ë¡</div>
      <div class="greeting-sub">í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
    </div>
  </div>

  <div id="map"></div>
  
<div class="btn-group">
  <button type="button" id="getLocBtn" class="main-btn">í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°</button>
  <button type="button" id="helpVideoBtn" class="main-btn">ì°¸ê³  ì˜ìƒ</button>
</div>

  <form id="storeForm">
    <div class="custom-field-box">
      <label for="hashtags">í•´ì‹œíƒœê·¸ (ê³ ê°ì—ê²Œ ë…¸ì¶œë˜ëŠ” ë¬¸êµ¬)</label>
      <input name="hashtags" id="hashtags" placeholder="#ì§ê´€ì ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆëŠ” ì´ë¦„ìœ¼ë¡œ 5ê¸€ì ë¯¸ë§Œ" />
    </div>
    
    <div class="custom-field-box">
      <label for="name">ê°€ê²Œ ì´ë¦„</label>
      <input name="name" id="name" required />
    </div>

    <div class="custom-field-box">
      <label for="insta_id">ì¸ìŠ¤íƒ€ê·¸ë¨ ID (@ ì œì™¸)</label>
      <input name="insta_id" id="insta_id" required />
    </div>

    <div class="custom-field-box" style="height: auto; min-height: 120px;">
      <label for="desc">ê°€ê²Œ ì„¤ëª…</label>
      <textarea name="desc" id="desc" rows="4"></textarea>
    </div>

    <div class="custom-field-box">
      <label for="phone">ì „í™”ë²ˆí˜¸</label>
      <input name="phone" id="phone" type="tel" placeholder="ì˜ˆ: 010-1234-5678" />
    </div>
    
    <!-- ê°€ê²Œ ì‚¬ì§„ -->
    <div class="custom-field-box" style="height: auto;">
      <label for="photo">ê°€ê²Œ ì‚¬ì§„ (ì„ íƒ) <small style="font-weight:400">(ë©”ì¸ì´ë¯¸ì§€ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.)</small></label>
      <input type="file" id="photo" accept="image/*" />
    </div>

    <!-- Vimeo ë™ì˜ìƒ -->
    <div class="custom-field-box">
      <label for="vimeo">Vimeo ë™ì˜ìƒ</label>
      <input name="vimeo" id="vimeo" type="text" placeholder="ë™ì˜ìƒì€ ê²€ìˆ˜ë¥¼ í†µí•´ ì—…ë¡œë“œ ë©ë‹ˆë‹¤." />
    </div>

    <div class="custom-field-box">
      <label for="openTime">ì˜¤í”ˆ ì‹œê°„ (24ì‹œê°„ ê¸°ì¤€, 30ë¶„ ë‹¨ìœ„)</label>
      <select name="openTime" id="openTime">
        <option value="3:00">3:00</option>
        <option value="3:30">3:30</option>
        <option value="4:00">4:00</option>
        <option value="4:30">4:30</option>
        <option value="5:00">5:00</option>
        <option value="5:30">5:30</option>
        <option value="6:00">6:00</option>
        <option value="6:30">6:30</option>
        <option value="7:00">7:00</option>
        <option value="7:30">7:30</option>
        <option value="8:00">8:00</option>
        <option value="8:30">8:30</option>
        <option value="9:00">9:00</option>
        <option value="9:30">9:30</option>
        <option value="10:00">10:00</option>
        <option value="10:30">10:30</option>
        <option value="11:00">11:00</option>
        <option value="11:30">11:30</option>
        <option value="12:00">12:00</option>
        <option value="12:30">12:30</option>
        <option value="13:00">13:00</option>
        <option value="13:30">13:30</option>
        <option value="14:00">14:00</option>
        <option value="14:30">14:30</option>
        <option value="15:00">15:00</option>
        <option value="15:30">15:30</option>
        <option value="16:00">16:00</option>
        <option value="16:30">16:30</option>
        <option value="17:00">17:00</option>
        <option value="17:30">17:30</option>
        <option value="18:00">18:00</option>
        <option value="18:30">18:30</option>
        <option value="19:00">19:00</option>
        <option value="19:30">19:30</option>
        <option value="20:00">20:00</option>
        <option value="20:30">20:30</option>
        <option value="21:00">21:00</option>
        <option value="21:30">21:30</option>
        <option value="22:00">22:00</option>
        <option value="22:30">22:30</option>
        <option value="23:00">23:00</option>
        <option value="23:30">23:30</option>
      </select>
    </div>
    <div class="custom-field-box">
      <label for="closeTime">ë§ˆê° ì‹œê°„ (24ì‹œê°„ ê¸°ì¤€, 30ë¶„ ë‹¨ìœ„)</label>
      <select name="closeTime" id="closeTime">
        <option value="3:00">3:00</option>
        <option value="3:30">3:30</option>
        <option value="4:00">4:00</option>
        <option value="4:30">4:30</option>
        <option value="5:00">5:00</option>
        <option value="5:30">5:30</option>
        <option value="6:00">6:00</option>
        <option value="6:30">6:30</option>
        <option value="7:00">7:00</option>
        <option value="7:30">7:30</option>
        <option value="8:00">8:00</option>
        <option value="8:30">8:30</option>
        <option value="9:00">9:00</option>
        <option value="9:30">9:30</option>
        <option value="10:00">10:00</option>
        <option value="10:30">10:30</option>
        <option value="11:00">11:00</option>
        <option value="11:30">11:30</option>
        <option value="12:00">12:00</option>
        <option value="12:30">12:30</option>
        <option value="13:00">13:00</option>
        <option value="13:30">13:30</option>
        <option value="14:00">14:00</option>
        <option value="14:30">14:30</option>
        <option value="15:00">15:00</option>
        <option value="15:30">15:30</option>
        <option value="16:00">16:00</option>
        <option value="16:30">16:30</option>
        <option value="17:00">17:00</option>
        <option value="17:30">17:30</option>
        <option value="18:00">18:00</option>
        <option value="18:30">18:30</option>
        <option value="19:00">19:00</option>
        <option value="19:30">19:30</option>
        <option value="20:00">20:00</option>
        <option value="20:30">20:30</option>
        <option value="21:00">21:00</option>
        <option value="21:30">21:30</option>
        <option value="22:00">22:00</option>
        <option value="22:30">22:30</option>
        <option value="23:00">23:00</option>
        <option value="23:30">23:30</option>
        <option value="24:00">24:00 (ë‹¤ìŒë‚  0:00)</option>
        <option value="24:30">24:30 (ë‹¤ìŒë‚  0:30)</option>
        <option value="25:00">25:00 (ë‹¤ìŒë‚  1:00)</option>
        <option value="25:30">25:30 (ë‹¤ìŒë‚  1:30)</option>
        <option value="26:00">26:00 (ë‹¤ìŒë‚  2:00)</option>
        <option value="26:30">26:30 (ë‹¤ìŒë‚  2:30)</option>
        <option value="27:00">27:00 (ë‹¤ìŒë‚  3:00)</option>
      </select>
    </div>
    
    <div class="custom-field-box">
      <label for="breakStart">ë¸Œë ˆì´í¬ íƒ€ì„ ì‹œì‘ (24ì‹œê°„ ê¸°ì¤€, 30ë¶„ ë‹¨ìœ„)</label>
      <select name="breakStart" id="breakStart">
        <option value="">ì„ íƒ ì•ˆí•¨</option>
        <option value="00:00">00:00</option>
        <option value="0:30">0:30</option>
        <option value="1:00">1:00</option>
        <option value="1:30">1:30</option>
        <option value="2:00">2:00</option>
        <option value="2:30">2:30</option>
        <option value="3:00">3:00</option>
        <option value="3:30">3:30</option>
        <option value="4:00">4:00</option>
        <option value="4:30">4:30</option>
        <option value="5:00">5:00</option>
        <option value="5:30">5:30</option>
        <option value="6:00">6:00</option>
        <option value="6:30">6:30</option>
        <option value="7:00">7:00</option>
        <option value="7:30">7:30</option>
        <option value="8:00">8:00</option>
        <option value="8:30">8:30</option>
        <option value="9:00">9:00</option>
        <option value="9:30">9:30</option>
        <option value="10:00">10:00</option>
        <option value="10:30">10:30</option>
        <option value="11:00">11:00</option>
        <option value="11:30">11:30</option>
        <option value="12:00">12:00</option>
        <option value="12:30">12:30</option>
        <option value="13:00">13:00</option>
        <option value="13:30">13:30</option>
        <option value="14:00">14:00</option>
        <option value="14:30">14:30</option>
        <option value="15:00">15:00</option>
        <option value="15:30">15:30</option>
        <option value="16:00">16:00</option>
        <option value="16:30">16:30</option>
        <option value="17:00">17:00</option>
        <option value="17:30">17:30</option>
        <option value="18:00">18:00</option>
        <option value="18:30">18:30</option>
        <option value="19:00">19:00</option>
        <option value="19:30">19:30</option>
        <option value="20:00">20:00</option>
        <option value="20:30">20:30</option>
        <option value="21:00">21:00</option>
        <option value="21:30">21:30</option>
        <option value="22:00">22:00</option>
        <option value="22:30">22:30</option>
        <option value="23:00">23:00</option>
        <option value="23:30">23:30</option>
      </select>
    </div>
    <div class="custom-field-box">
      <label for="breakEnd">ë¸Œë ˆì´í¬ íƒ€ì„ ì¢…ë£Œ (24ì‹œê°„ ê¸°ì¤€, 30ë¶„ ë‹¨ìœ„)</label>
      <select name="breakEnd" id="breakEnd">
        <option value="">ì„ íƒ ì•ˆí•¨</option>
        <option value="00:00">00:00</option>
        <option value="0:30">0:30</option>
        <option value="1:00">1:00</option>
        <option value="1:30">1:30</option>
        <option value="2:00">2:00</option>
        <option value="2:30">2:30</option>
        <option value="3:00">3:00</option>
        <option value="3:30">3:30</option>
        <option value="4:00">4:00</option>
        <option value="4:30">4:30</option>
        <option value="5:00">5:00</option>
        <option value="5:30">5:30</option>
        <option value="6:00">6:00</option>
        <option value="6:30">6:30</option>
        <option value="7:00">7:00</option>
        <option value="7:30">7:30</option>
        <option value="8:00">8:00</option>
        <option value="8:30">8:30</option>
        <option value="9:00">9:00</option>
        <option value="9:30">9:30</option>
        <option value="10:00">10:00</option>
        <option value="10:30">10:30</option>
        <option value="11:00">11:00</option>
        <option value="11:30">11:30</option>
        <option value="12:00">12:00</option>
        <option value="12:30">12:30</option>
        <option value="13:00">13:00</option>
        <option value="13:30">13:30</option>
        <option value="14:00">14:00</option>
        <option value="14:30">14:30</option>
        <option value="15:00">15:00</option>
        <option value="15:30">15:30</option>
        <option value="16:00">16:00</option>
        <option value="16:30">16:30</option>
        <option value="17:00">17:00</option>
        <option value="17:30">17:30</option>
        <option value="18:00">18:00</option>
        <option value="18:30">18:30</option>
        <option value="19:00">19:00</option>
        <option value="19:30">19:30</option>
        <option value="20:00">20:00</option>
        <option value="20:30">20:30</option>
        <option value="21:00">21:00</option>
        <option value="21:30">21:30</option>
        <option value="22:00">22:00</option>
        <option value="22:30">22:30</option>
        <option value="23:00">23:00</option>
        <option value="23:30">23:30</option>
      </select>
      </div>
    
    <label style="font-weight:700; margin-top: 16px;">ì‰¬ëŠ” ë‚ </label>
    <div class="off-days">
      <label><input type="checkbox" name="offDays[]" value="ì›”">ì›”</label>
      <label><input type="checkbox" name="offDays[]" value="í™”">í™”</label>
      <label><input type="checkbox" name="offDays[]" value="ìˆ˜">ìˆ˜</label>
      <label><input type="checkbox" name="offDays[]" value="ëª©">ëª©</label>
      <label><input type="checkbox" name="offDays[]" value="ê¸ˆ">ê¸ˆ</label>
      <label><input type="checkbox" name="offDays[]" value="í† ">í† </label>
      <label><input type="checkbox" name="offDays[]" value="ì¼">ì¼</label>
      <div></div> <!-- ë¹ˆì¹¸ (ë§ˆì§€ë§‰ ì¹¸ ì±„ìš°ê¸° ìš©ë„) -->
    </div>

    
    <label>ìœ„ë„</label>
    <input id="lat" readonly required />
    <label>ê²½ë„</label>
    <input id="lng" readonly required />

    <button id="saveBtn" type="button">ì €ì¥</button>

  </form>

  <script>
    const overlay = document.getElementById('loadingOverlay');
    const saveBtn = document.getElementById('saveBtn');
    let editingId = "";

    // Firebase ì´ˆê¸°í™”ëŠ” í•œ ë²ˆë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    const firebaseConfig = {
      apiKey: "AIzaSyCVV1XUfsREQYnah3tbEKBTprgq9wRgiic",
      authDomain: "instamap-9b595.firebaseapp.com",
      projectId: "instamap-9b595",
      storageBucket: "instamap-9b595.firebasestorage.app",
      messagingSenderId: "280950399393",
      appId: "1:280950399393:web:8282e0d352e50c8bcd2be0"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const auth = firebase.auth();

    // currentUser ì„ ì–¸ì„ ì „ì—­ ìŠ¤ì½”í”„ì—ì„œ í•œ ë²ˆë§Œ í•©ë‹ˆë‹¤.
    let currentUser = null; // ì´ ì¤„ì„ ê¸°ì¡´ì˜ ì¤‘ë³µ ì„ ì–¸ë“¤ì„ ì œê±°í•˜ê³  í•œ ê³³ì—ë§Œ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤.

    // onAuthStateChanged ë¦¬ìŠ¤ë„ˆë¥¼ í•˜ë‚˜ë§Œ ìœ ì§€í•©ë‹ˆë‹¤.
    auth.onAuthStateChanged(async user => {
      if (!user) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "/login.html";
        return;
      }

      currentUser = user;
      const email = user.email.toLowerCase();
      localStorage.setItem("userEmail", email);

      try {
        const userDoc = await db.collection("users").doc(email).get();
        if (!userDoc.exists || userDoc.data().agreedToTerms !== true) {
          alert("ì•½ê´€ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
          window.location.href = "/terms.html";
          return;
        }

        const storeDoc = await db.collection("stores").doc(email).get(); // user.email ëŒ€ì‹  email ë³€ìˆ˜ ì‚¬ìš©
        if (storeDoc.exists) {
          loadStoreToForm({ id: email, data: () => storeDoc.data() }); // user.email ëŒ€ì‹  email ë³€ìˆ˜ ì‚¬ìš©
        }
      } catch (err) {
        console.error("\u2757 Firestore ì˜¤ë¥˜:", err);
        alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ.");
      }
    });

    const map = new naver.maps.Map('map', {
      center: new naver.maps.LatLng(37.5665, 126.9780),
      zoom: 15
    });
    let marker = null;

    function setLatLng(lat, lng) {
      document.getElementById('lat').value = lat;
      document.getElementById('lng').value = lng;
      if (marker) marker.setMap(null);
      marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(lat, lng),
        map: map
      });
    }

    naver.maps.Event.addListener(map, 'click', e => setLatLng(e.coord.lat(), e.coord.lng()));
    document.getElementById('getLocBtn').onclick = () => {
      navigator.geolocation?.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        setLatLng(latitude, longitude);
        map.setCenter(new naver.maps.LatLng(latitude, longitude));
        map.setZoom(18);
      }, () => alert('ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.'));
    };

    function compressImage(file, maxBytes = 1000000) {
      return new Promise(resolve => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = e => {
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const maxW = 500;
            const scale = Math.min(1, maxW / img.width);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            let quality = 0.8;
            function exportBlob() {
              canvas.toBlob(blob => {
                if (blob.size <= maxBytes || quality < 0.4) {
                  resolve(blob);
                } else {
                  quality -= 0.1;
                  exportBlob();
                }
              }, 'image/jpeg', quality);
            }
            exportBlob();
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function parseVimeoInput(input) {
      input = input.replace(/<script[\s\S]*?<\/script>/gi, "");
      const iframeMatch = input.match(/<iframe[^>]+src=["']([^"']+)["']/i);
      if (iframeMatch) return iframeMatch[1];
      const embedMatch = input.match(/^(https?:\/\/player\.vimeo\.com\/video\/\d+(?:\?.*)?)/i);
      if (embedMatch) return embedMatch[1];
      const shareMatch = input.match(/^https?:\/\/vimeo\.com\/(\d+)/i);
      if (shareMatch) return `https://player.vimeo.com/video/${shareMatch[1]}`;
      return "";
      }

    function loadStoreToForm(doc) {
      const data = doc.data();
      editingId = currentUser.email;
      document.querySelector('[name=name]').value = data.name;
      document.querySelector('[name=insta_id]').value = data.insta;
      document.querySelector('[name=desc]').value = data.desc;
      document.querySelector('[name=phone]').value = data.phone || ""; // âœ… ì¶”ê°€
      document.getElementById('lat').value = data.lat;
      document.getElementById('lng').value = data.lng;
      document.querySelector('[name=vimeo]').value = data.vimeo || "";
      // í•´ì‹œíƒœê·¸ ë¡œë“œ (ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ë¡œ ë³€í™˜)
      document.querySelector('[name=hashtags]').value = (data.hashtags || []).join(', ');

      // ì˜¤í”ˆ/ë§ˆê° ì‹œê°„, ë¸Œë ˆì´í¬ íƒ€ì„, ì‰¬ëŠ” ë‚  ë¡œë“œ
      document.querySelector('[name=openTime]').value = data.openTime || '';
      document.querySelector('[name=closeTime]').value = data.closeTime || '';
      document.querySelector('[name=breakStart]').value = data.breakStart || '';
      document.querySelector('[name=breakEnd]').value = data.breakEnd || '';

      // ì‰¬ëŠ” ë‚  ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™” ë° ì²´í¬
      document.querySelectorAll('[name="offDays[]"]').forEach(cb => cb.checked = false);
      (data.offDays || []).forEach(day => {
        const checkbox = document.querySelector(`[name="offDays[]"][value="${day}"]`);
        if (checkbox) checkbox.checked = true;
      });

      setLatLng(data.lat, data.lng);
      document.getElementById('saveBtn').textContent = "ìˆ˜ì • ì €ì¥";
    }

    document.getElementById('saveBtn').addEventListener('click', async () => {
      overlay.style.display = 'flex';
      saveBtn.disabled = true;

      try {
        const raw = document.querySelector('[name=hashtags]').value;
        const tags = raw.split(',').map(t => t.trim()).filter(Boolean);
        const invalid = tags.filter(t => Array.from(t).length > 5);
        if (invalid.length) {
          alert(`ë‹¤ìŒ í•´ì‹œíƒœê·¸ëŠ” 5ê¸€ìë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤:\n${invalid.join(', ')}`);
          return;
        }

        const rawInput = document.querySelector('[name=vimeo]').value.trim();
        const vimeoUrl = rawInput ? parseVimeoInput(rawInput) : "";
        if (rawInput && !vimeoUrl) {
          alert('ìœ íš¨í•œ Vimeo ë§í¬ë‚˜ <iframe> ì½”ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.');
          return;
        }

        const openTime = document.querySelector('[name=openTime]').value;
        const closeTime = document.querySelector('[name=closeTime]').value;
        const breakStart = document.querySelector('[name=breakStart]').value;
        const breakEnd = document.querySelector('[name=breakEnd]').value;
        const offDays = Array.from(document.querySelectorAll('[name="offDays[]"]:checked')).map(cb => cb.value);


        // currentUserê°€ nullì¼ ê²½ìš° ë‹¤ì‹œ ë¡œê·¸ì¸ ê²½ê³  ë° ë¦¬í„´
        if (!currentUser) {
          alert('ë¡œê·¸ì¸ í›„ ë“±ë¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
          window.location.href = "/login.html"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¶”ê°€
          return;
        }

        const store = {
          name: document.querySelector('[name=name]').value.trim(),
          insta: document.querySelector('[name=insta_id]').value.trim(),
          desc: document.querySelector('[name=desc]').value.trim(),
          phone: document.querySelector('[name=phone]').value.trim(), // âœ… ì¶”ê°€
          lat: parseFloat(document.getElementById('lat').value),
          lng: parseFloat(document.getElementById('lng').value),
          photo: "",
          vimeo: vimeoUrl,
          hashtags: tags,
          openTime,
          closeTime,
          breakStart,
          breakEnd,
          offDays,
          userEmail: currentUser.email,
          created: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (!store.name || !store.insta || isNaN(store.lat) || isNaN(store.lng) || !openTime || !closeTime) {
          alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        const file = document.getElementById('photo').files[0];
        if (file) {
          const blob = await compressImage(file);
          const filename = `store_photos/${Date.now()}_${file.name.replace(/\s+/g, '')}`;
          const ref = storage.ref().child(filename);
          await ref.put(blob);
          store.photo = await ref.getDownloadURL();
        }

        const storeRef = db.collection('stores').doc(currentUser.email);
        if (editingId) {
          // ì‚¬ì§„ì„ ìƒˆë¡œ ì—…ë¡œë“œí•˜ì§€ ì•Šì•˜ë‹¤ë©´ ê¸°ì¡´ photo í•„ë“œ ìœ ì§€
          if (!file) {
             const existingStore = await storeRef.get();
             if (existingStore.exists) {
               store.photo = existingStore.data().photo || "";
             }
          }
          await storeRef.update(store);
          alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } else {
          const exists = await storeRef.get();
          if (exists.exists) {
            alert("ì´ë¯¸ ë“±ë¡ëœ ê°€ê²Œì…ë‹ˆë‹¤. ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.");
            loadStoreToForm({ id: currentUser.email, data: () => exists.data() });
            return;
          }
          await storeRef.set(store);
          alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // í¼ ì´ˆê¸°í™” ë° ì§€ë„ ë§ˆì»¤ ì œê±°
        document.getElementById('storeForm').reset();
        if (marker) marker.setMap(null);
        editingId = "";
        saveBtn.textContent = "ì €ì¥";

      } catch (err) {
        console.error(err);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        overlay.style.display = 'none';
        saveBtn.disabled = false;
      }
    });
  </script>

  
  <div id="videoModal" class="modal">
  <div class="modal-content">
    <button id="closeVideo">&times;</button>
    <iframe
      id="videoFrame"
      src=""
      frameborder="0"
      allow="autoplay; fullscreen"
      allowfullscreen></iframe>
  </div>
</div>
<script>
/* === ì°¸ê³  ì˜ìƒ ëª¨ë‹¬ === */
const videoModal = document.getElementById('videoModal');
const videoFrame = document.getElementById('videoFrame');
const helpBtn    = document.getElementById('helpVideoBtn');
const closeBtn   = document.getElementById('closeVideo');

helpBtn.addEventListener('click', () => {
  const url = 'https://player.vimeo.com/video/1091824548?h=bfd071815a&autoplay=1&muted=1';
  videoFrame.src = url;
  videoModal.style.display = 'flex';
});

function hideModal() {
  videoFrame.src = '';
  videoModal.style.display = 'none';
}
closeBtn.addEventListener('click', hideModal);
videoModal.addEventListener('click', e => {
  if (e.target === videoModal) hideModal();
});
</script>

</body>
</html>
