<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>내 매장 수정 (관리자용)</title>
  <!-- 네이버 지도 API -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=qpbrmxiff4"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <style>
    body { font-family:'Pretendard',sans-serif; margin:0;padding:0; }
    #header { padding:12px; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:center; }
    #header h1 { margin:0; font-size:18px; }
    #map { width:100vw; height:80vh; }
    .custom-marker { display:inline-block; background:#2d8cff; color:#fff; padding:4px 8px; border-radius:4px; white-space:nowrap; font-size:12px; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
    .info-form { display:flex; flex-direction:column; gap:8px; width:300px; }
    .info-form input, .info-form textarea, .info-form button { width:100%; padding:6px; box-sizing:border-box; border:1px solid #ddd; border-radius:4px; }
    .info-form button { background:#2d8cff; color:#fff; border:none; cursor:pointer; }
    .info-form label { margin-top:8px; font-size:14px; }
  </style>
</head>
<body>
  <div id="header"><h1>관리자 페이지: 내 매장 수정</h1></div>
  <div id="map"></div>

  <script>
    // 미리 정의된 관리자 이메일 (자동 인증)
    const ADMIN_EMAIL = 'jhpark8271@gmail.com';

    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyCVV1XUfsREQYnah3tbEKBTprg9iic",
      authDomain: "instamap-9b595.firebaseapp.com",
      projectId: "instamap-9b595",
      storageBucket: "instamap-9b595.web.app",
      messagingSenderId: "280950399393",
      appId: "1:280950399393:web:8282e0d352e50c8bcd2be0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // 이미지 압축 함수
    function compressImage(file, maxBytes = 1000000) {
      return new Promise(resolve => {
        const img = new Image(), reader = new FileReader();
        reader.onload = e => {
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const maxW = 500, scale = Math.min(1, maxW / img.width);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            let quality = 0.8;
            (function exportBlob() {
              canvas.toBlob(blob => {
                if (blob.size <= maxBytes || quality < 0.4) resolve(blob);
                else { quality -= 0.1; exportBlob(); }
              }, 'image/jpeg', quality);
            })();
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // 지도 및 InfoWindow 생성
    const map = new naver.maps.Map('map', {
      center: new naver.maps.LatLng(37.5665, 126.9780),
      zoom: 15
    });
    const infoWindow = new naver.maps.InfoWindow({ borderWidth: 0 });

    // 내 매장 로드 및 마커 생성
    db.collection('stores').doc(ADMIN_EMAIL).get()
      .then(doc => {
        if (!doc.exists) {
          alert('매장 정보가 존재하지 않습니다.');
          return;
        }
        const data = doc.data();
        const marker = new naver.maps.Marker({
          position: new naver.maps.LatLng(data.lat, data.lng),
          map,
          icon: {
            content: `<div class="custom-marker">${data.name}</div>`,
            anchor: new naver.maps.Point(0, 30)
          }
        });
        map.setCenter(marker.getPosition());
        marker.addListener('click', () => openForm(data, marker));
        openForm(data, marker);
      })
      .catch(err => console.error('매장 로드 오류:', err));

    // 편집 폼 함수
    function openForm(data, marker) {
      const pos = marker.getPosition();
      const html = `
        <div class="info-form" id="edit-form">
          <input type="file" accept="image/*" id="photo-input" />
          <input id="name-input" value="${data.name||''}" placeholder="가게 이름" />
          <input id="insta-input" value="${data.insta||''}" placeholder="인스타 ID" />
          <textarea id="desc-input" placeholder="가게 설명">${data.desc||''}</textarea>
          <input id="phone-input" value="${data.phone||''}" placeholder="전화번호" />
          <input id="hashtag-input" value="${(data.hashtags||[]).join(', ')}" placeholder="해시태그" />
          <input id="vimeo-input" value="${data.vimeo||''}" placeholder="Vimeo URL" />
          <label>오픈 시간</label><input type="time" id="openTime-input" value="${data.openTime||''}" />
          <label>마감 시간</label><input type="time" id="closeTime-input" value="${data.closeTime||''}" />
          <button id="save-btn" type="button">저장</button>
        </div>`;
      infoWindow.setContent(html);
      infoWindow.open(map, marker);

      setTimeout(() => {
        const saveBtn = document.getElementById('save-btn');
        const fileInput = document.getElementById('photo-input');
        saveBtn.onclick = async () => {
          try {
            const updated = {
              name: document.getElementById('name-input').value.trim(),
              insta: document.getElementById('insta-input').value.trim(),
              desc: document.getElementById('desc-input').value.trim(),
              phone: document.getElementById('phone-input').value.trim(),
              hashtags: document.getElementById('hashtag-input').value.split(',').map(t=>t.trim()).filter(Boolean),
              vimeo: document.getElementById('vimeo-input').value.trim(),
              openTime: document.getElementById('openTime-input').value,
              closeTime: document.getElementById('closeTime-input').value,
              lat: pos.lat(),
              lng: pos.lng()
            };
            if (fileInput.files.length) {
              const blob = await compressImage(fileInput.files[0]);
              const path = `store_photos/${Date.now()}_${fileInput.files[0].name.replace(/\s+/g,'')}`;
              const ref = storage.ref().child(path);
              await ref.put(blob);
              updated.photo = await ref.getDownloadURL();
            }
            await db.collection('stores').doc(ADMIN_EMAIL).update(updated);
            alert('정보가 저장되었습니다');
            infoWindow.close();
          } catch (e) {
            alert('저장 실패: ' + e);
            console.error(e);
          }
        };
      }, 0);
    }
  </script>
</body>
</html>
