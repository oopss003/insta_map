<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Analytics Dashboard</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=qpbrmxiff4"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* === GLOBAL VARIABLES === */
    :root {
      --primary-color: #3B82F6;
      --sidebar-bg: #1E293B;
      --sidebar-text: #94A3B8;
      --bg-color: #F3F4F6;
      --card-bg: #FFFFFF;
      --text-main: #1F2937;
      --text-sub: #6B7280;
      --border-color: #E5E7EB;
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
    }

    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

    /* === SIDEBAR === */
    .sidebar { width: 280px; background-color: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; padding: 24px; flex-shrink: 0; }
    .logo-area { margin-bottom: 40px; color: white; font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
    .logo-icon { width: 32px; height: 32px; background: var(--primary-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
    
    .nav-menu { list-style: none; padding: 0; margin: 0 0 40px 0; }
    .nav-item { padding: 12px 16px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 600; color: var(--sidebar-text); transition: all 0.2s; margin-bottom: 4px; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: var(--primary-color); color: white; }

    /* 사이드바 달력 (상단 기준 고정) */
    .sidebar-cal { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; margin-top: 24px; }
    .sb-cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; color: white; font-weight: 700; font-size: 14px; }
    .sb-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
    .sb-day-name { font-size: 10px; color: #64748B; margin-bottom: 6px; }
    .sb-date-cell { aspect-ratio: 1/1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #CBD5E1; cursor: pointer; position: relative; }
    .sb-date-cell:hover { background: rgba(255,255,255,0.1); }
    .sb-date-cell.selected { background: var(--primary-color); color: white; font-weight: 700; }
    .sb-dot { width: 4px; height: 4px; background: var(--success); border-radius: 50%; position: absolute; bottom: 4px; display: none; }
    .sb-date-cell.has-data .sb-dot { display: block; }
     /* [NEW] 로딩 스피너 & 드롭다운 스타일 */
    .sb-loader-overlay {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(30, 41, 59, 0.8); z-index: 10;
      display: none; justify-content: center; align-items: center; flex-direction: column;
      border-radius: 16px; font-size: 12px; color: white;
    }
    .sb-spinner {
      width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%; border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite; margin-bottom: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .sb-monitor-select {
      margin-top: 16px; width: 100%; padding: 10px;
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px; color: #CBD5E1; font-size: 13px; outline: none;
    }
    .sb-monitor-select option { background: #1E293B; color: #CBD5E1; }

    /* === MAIN CONTENT === */
    .main-content { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; position: relative; }
    
    /* 공통 헤더 */
    .top-section { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; flex-shrink: 0; }
    .page-header h1 { font-size: 24px; font-weight: 800; margin: 0 0 8px 0; color: var(--text-main); }
    .page-header p { margin: 0; font-size: 14px; color: #6B7280; }
    
    .header-controls { display: flex; gap: 12px; }
    .btn { padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
    .btn-white { background: white; border: 1px solid var(--border-color); color: #374151; }
    .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }
    .btn-primary:hover { background: #2563EB; transform: translateY(-1px); }

    /* 페이지 전환용 (Display None Toggle) */
    .page-view { display: none; flex-direction: column; gap: 24px; height: 100%; }
    .page-view.active { display: flex; }

    /* --- [PAGE 1] DASHBOARD STYLES --- */
    .map-card { height: 280px; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: relative; border: 1px solid var(--border-color); flex-shrink: 0; }
    .map-badge { position: absolute; top: 16px; left: 16px; z-index: 10; background: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    
    .filter-card { background: white; padding: 16px 24px; border-radius: 16px; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); flex-shrink: 0; flex-wrap: wrap; }
    .filter-item { display: flex; align-items: center; gap: 12px; }
    .filter-label { font-size: 12px; font-weight: 700; color: #9CA3AF; text-transform: uppercase; }
    .select-box { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px; font-weight: 600; outline: none; background: #F9FAFB; }
    .toggle-chips { display: flex; gap: 6px; }
    .chip { padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border-color); font-size: 12px; font-weight: 600; color: #6B7280; cursor: pointer; background: white; }
    .chip.active { background: #EFF6FF; border-color: var(--primary-color); color: var(--primary-color); }

    .dashboard-grid { display: grid; grid-template-columns: 280px 1fr; gap: 24px; flex: 1; min-height: 0; } 
    .kpi-column { display: flex; flex-direction: column; gap: 16px; }
    .kpi-box { background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 4px; }
    .kpi-head { font-size: 12px; color: #9CA3AF; font-weight: 700; }
    .kpi-val { font-size: 24px; font-weight: 800; color: #111827; }
    .kpi-sub { font-size: 12px; color: var(--success); font-weight: 600; }

    .chart-box { background: white; border-radius: 16px; border: 1px solid var(--border-color); padding: 24px; display: flex; flex-direction: column; flex: 1; }
    .heatmap-layout { display: flex; gap: 10px; flex: 1; min-height: 0; }
    .hm-y-axis { display: grid; grid-template-rows: repeat(7, 1fr); text-align: right; padding-right: 10px; }
    .hm-row-label { font-size: 12px; color: #6B7280; font-weight: 600; display:flex; align-items:center; justify-content:flex-end; }
    .hm-grid { flex: 1; display: grid; grid-template-columns: repeat(18, 1fr); gap: 2px; }
    .hm-cell { background: #F3F4F6; border-radius: 4px; }
    .l1 { background: #DBEAFE; } .l2 { background: #93C5FD; } .l3 { background: #3B82F6; } .l4 { background: #1E40AF; }
    .hm-x-axis { display: grid; grid-template-columns: repeat(18, 1fr); gap: 2px; margin-top: 8px; padding-left: 40px; }
    .hm-col-label { font-size: 10px; color: #9CA3AF; text-align: center; }

    /* --- [PAGE 2] MONITOR LIST STYLES --- */
    .table-container { background: white; border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden; flex: 1; display: flex; flex-direction: column; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .table-header { display: grid; grid-template-columns: 1fr 2fr 1.5fr 1fr 1fr 1fr; padding: 16px 24px; background: #F8FAFC; border-bottom: 1px solid var(--border-color); font-size: 12px; font-weight: 700; color: #64748B; text-transform: uppercase; }
    .monitor-list { flex: 1; overflow-y: auto; }
    .table-row { display: grid; grid-template-columns: 1fr 2fr 1.5fr 1fr 1fr 1fr; padding: 16px 24px; border-bottom: 1px solid var(--border-color); align-items: center; font-size: 14px; transition: background 0.1s; }
    .table-row:hover { background: #F9FAFB; }
    .table-row:last-child { border-bottom: none; }
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
    .st-active { background: #DCFCE7; color: #166534; } .st-inactive { background: #FEE2E2; color: #991B1B; } .st-maintenance { background: #FEF3C7; color: #92400E; }
    .st-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .action-btn { width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border-color); background: white; cursor: pointer; color: #64748B; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .action-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background: #EFF6FF; }
    .action-btn.delete:hover { border-color: var(--danger); color: var(--danger); background: #FEF2F2; }

    /* --- [PAGE 3] UPLOAD STYLES --- */
    .upload-section { display: flex; gap: 24px; height: 100%; }
    .upload-card { flex: 1; background: white; padding: 40px; border-radius: 16px; border: 2px dashed var(--border-color); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; height: 400px; }
    .upload-card:hover { border-color: var(--primary-color); background: #EFF6FF; }
    .upload-card.drag-over {
          border-color: var(--primary-color);
          background-color: #DBEAFE; /* 조금 더 진한 파란색 배경 */
          transform: scale(1.02);
        }
    .upload-icon { font-size: 48px; color: #CBD5E1; margin-bottom: 16px; }
    .upload-title { font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 8px; }
    .upload-desc { font-size: 13px; color: var(--text-sub); }
    .file-status { margin-top: 10px; font-size: 13px; font-weight: 600; color: var(--primary-color); }

    /* --- MODAL STYLES --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; justify-content: center; align-items: center; }
    .modal-box { background: white; width: 450px; padding: 24px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .modal-title { font-size: 18px; font-weight: 800; margin-bottom: 16px; }
    .form-input-full { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; font-size: 14px; }
    .modal-actions { display: flex; gap: 10px; margin-top: 10px; }
    
    /* 지도 추가 스타일 */
    .modal-map { width: 100%; height: 200px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 16px; overflow: hidden; }
    /* [NEW] 화면 전체를 덮는 로딩 오버레이 (클릭 방지용) */
        #globalLoader {
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0, 0, 0, 0.7); z-index: 9999;
          display: none; flex-direction: column; justify-content: center; align-items: center;
          color: white; font-size: 16px; font-weight: 600;
          backdrop-filter: blur(3px);
        }
        .loader-spinner {
          width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3);
          border-radius: 50%; border-top-color: var(--primary-color);
          animation: spin 1s ease-in-out infinite; margin-bottom: 20px;
        }


   /* [NEW] Dashboard Layout Update */
    .dashboard-grid { display: grid; grid-template-columns: 240px 1fr; gap: 24px; height: auto; padding-bottom: 60px;}  /* height: calc(100vh - 150px); min-height: 500px; } */
    
    /* 좌측 KPI 4칸 */
    .kpi-column { display: flex; flex-direction: column; gap: 16px; height: auto; justify-content: flex-start; } /* justify-content: space-between; height: 100%; } */
    .kpi-box { flex: 1; display: flex; flex-direction: column; justify-content: center; height: 160px; } /* in-height: 100px; } */
    
    /* 우측 차트 영역 2분할 */
    .charts-row { display: flex; gap: 16px; height: 450px; margin-bottom: 24px; } /*  height: 100%; } */
    .chart-half { flex: 1; background: white; border-radius: 16px; border: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
    
    /* 심플 바 차트 스타일 */
    .bar-chart-container { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; gap: 10px; padding-top: 20px; }
    .bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .bar-label { width: 60px; font-size: 12px; font-weight: 600; color: #64748B; text-align: right; }
    .bar-bg { flex: 1; background: #F1F5F9; height: 24px; border-radius: 6px; overflow: hidden; position: relative; }
    .bar-fill { height: 100%; background: var(--primary-color); width: 0%; transition: width 1s; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 11px; color: white; font-weight: 700; }
    
    /* 히트맵 스타일 보정 */
    .heatmap-layout { display: flex; flex-direction: column; height: 100%; }
    .hm-container { display: flex; flex: 1; gap: 8px; margin-top:10px; }
    .hm-y { display: flex; flex-direction: column; justify-content: space-between; font-size: 11px; color: #94A3B8; font-weight: 600; padding-bottom: 20px; }
    .hm-grid-box { flex: 1; display: grid; grid-template-rows: repeat(7, 1fr); grid-template-columns: repeat(14, 1fr); gap: 3px; }
    .hm-cell { background: #F1F5F9; border-radius: 4px; transition: background 0.2s; }
    .hm-x { display: flex; justify-content: space-between; padding-left: 30px; margin-top: 5px; font-size: 10px; color: #CBD5E1; }
    
    /* 히트맵 색상 레벨 */
    .lv-0 { background: #F1F5F9; }
    .lv-1 { background: #DBEAFE; }
    .lv-2 { background: #93C5FD; }
    .lv-3 { background: #3B82F6; }
    .lv-4 { background: #1E40AF; } 


    /* [NEW] 2열 그래프 스타일 */
    .scatter-container { position: relative; width: 100%; height: 100%; border-left: 1px solid #E2E8F0; border-bottom: 1px solid #E2E8F0; margin: 10px 0 20px 20px; }
    .scatter-dot { position: absolute; border-radius: 50%; opacity: 0.7; transition: transform 0.2s; cursor: pointer; }
    .scatter-dot:hover { transform: scale(1.5); opacity: 1; z-index: 10; border: 1px solid #333; }
    .scatter-dot.male { background: rgba(59, 130, 246, 0.6); } /* Blue */
    .scatter-dot.female { background: rgba(239, 68, 68, 0.6); } /* Red */
    .sc-x-label { position: absolute; bottom: -20px; font-size: 10px; color: #94A3B8; transform: translateX(-50%); }
    .sc-y-label { position: absolute; left: -25px; font-size: 10px; color: #94A3B8; transform: translateY(50%); }

    /* 세로 막대 그래프 (Dwell Time) */
    .v-bar-container { display: flex; align-items: flex-end; justify-content: space-around; height: 100%; padding-bottom: 20px; border-bottom: 1px solid #E2E8F0; }
    .v-bar-group { display: flex; flex-direction: column; align-items: center; gap: 6px; height: 100%; justify-content: flex-end; width: 40px; }
    .v-bar { width: 100%; background: #CBD5E1; border-radius: 4px 4px 0 0; transition: height 1s; position: relative; }
    .v-bar.high { background: var(--primary-color); }
    .v-bar-val { font-size: 11px; font-weight: 700; color: #64748B; margin-bottom: 4px; }
    .v-bar-lbl { font-size: 11px; color: #94A3B8; font-weight: 600; }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="logo-area">
      <div class="logo-icon"><i class="fa-solid fa-chart-simple"></i></div>
      INWAVE Analytics
    </div>

    <ul class="nav-menu">
      <li class="nav-item active" onclick="showPage('dashboard', this)"><i class="fa-solid fa-house"></i> Dashboard</li>
      <li class="nav-item" onclick="showPage('monitors', this)"><i class="fa-solid fa-desktop"></i> Monitors</li>
      <li class="nav-item" onclick="showPage('ads', this)"><i class="fa-solid fa-rectangle-ad"></i> Ad Manager</li>
      <li class="nav-item" onclick="showPage('upload', this)"><i class="fa-solid fa-file-arrow-up"></i> Data Upload</li>
    </ul>

    <div class="sidebar-cal" style="position:relative;">
          <div id="calLoader" class="sb-loader-overlay">
            <div class="sb-spinner"></div>
            <span>Checking Data...</span>
          </div>
    
          <div class="sb-cal-header">
            <span id="calMonthYear">October 2025</span>
            <div style="display:flex; gap:8px;">
              <i class="fa-solid fa-chevron-left" style="cursor:pointer" onclick="changeMonth(-1)"></i>
              <i class="fa-solid fa-chevron-right" style="cursor:pointer" onclick="changeMonth(1)"></i>
            </div>
          </div>
          <div class="sb-cal-grid" style="margin-bottom:8px;">
            <div class="sb-day-name">S</div><div class="sb-day-name">M</div><div class="sb-day-name">T</div>
            <div class="sb-day-name">W</div><div class="sb-day-name">T</div><div class="sb-day-name">F</div><div class="sb-day-name">S</div>
          </div>
          <div class="sb-cal-grid" id="sidebarCalGrid"></div>
          
          <select id="sidebarMonitorSelect" class="sb-monitor-select" onchange="filterCalendarByMonitor()">
            <option value="ALL">All Monitors</option>
          </select>
          <select id="sidebarAdSelect" class="sb-monitor-select" style="margin-top:8px;">
                      <option value="ALL">All Ads</option>
                    </select>
    
          <div style="margin-top:12px; font-size:11px; color:#94A3B8; text-align:center;">
          <button onclick="migrateExistingData()" style="width:100%; margin-top:10px; padding:8px; background:#475569; border:none; border-radius:6px; color:white; cursor:pointer; font-size:11px;">
                      <i class="fa-solid fa-bolt"></i> Refresh Old Data Stats
                    </button>
            <span style="color:white; font-weight:700;" id="selCount">0</span> days selected
          </div>
        </div>


</div> <div class="main-content">
    
    <div id="page-dashboard" class="page-view active">
      <div class="top-section">
        <div class="page-header">
          <h1>Dashboard Overview</h1>
          <p>Monitor Traffic & Ad Performance Analysis</p>
        </div>
        <div class="header-controls">
          <div class="btn-white btn" onclick="location.href='https://inwave.ai.kr/analyze.html'">
            <i class="fa-solid fa-user"></i> Admin
          </div>
          <button class="btn btn-primary"><i class="fa-solid fa-download"></i> Export</button>
        </div>
      </div>
      <div class="map-card">
        <div id="miniMap" style="width:100%; height:100%;"></div>
        <div class="map-badge"><i class="fa-solid fa-location-dot" style="color:#3B82F6"></i> Live Location</div>
      </div>
      <div class="filter-card" style="display:block; padding:20px;">
              <div style="display:flex; gap:40px; margin-bottom:16px;">
                <div class="filter-item">
                  <div class="filter-label" style="margin-bottom:8px;">Gender</div>
                  <div class="toggle-chips" id="filter_gender">
                    <div class="chip active" onclick="selectFilter('gender', this, 'ALL')">전체</div>
                    <div class="chip" onclick="selectFilter('gender', this, 'Male')">남자</div>
                    <div class="chip" onclick="selectFilter('gender', this, 'Female')">여자</div>
                  </div>
                </div>
                
                <div class="filter-item">
                  <div class="filter-label" style="margin-bottom:8px;">Attention</div>
                  <div class="toggle-chips" id="filter_attention">
                    <div class="chip active" onclick="selectFilter('attention', this, 'ALL')">전체 (All)</div>
                    <div class="chip" onclick="selectFilter('attention', this, 'High')">집중인구 (High)</div>
                  </div>
                </div>
              </div>
      
              <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div class="filter-item">
                  <div class="filter-label" style="margin-bottom:8px;">Age Group</div>
                  <div class="toggle-chips" id="filter_age" style="flex-wrap:wrap; gap:6px;">
                    <div class="chip active" onclick="selectFilter('age', this, 'ALL')">전체</div>
                    <div class="chip" onclick="selectFilter('age', this, '10')">10대</div>
                    <div class="chip" onclick="selectFilter('age', this, '20')">20대</div>
                    <div class="chip" onclick="selectFilter('age', this, '30')">30대</div>
                    <div class="chip" onclick="selectFilter('age', this, '40')">40대</div>
                    <div class="chip" onclick="selectFilter('age', this, '50')">50대</div>
                    <div class="chip" onclick="selectFilter('age', this, '60')">60대+</div>
                  </div>
                </div>
      
                <button class="btn btn-primary" style="padding:12px 24px; font-size:14px;" onclick="runAnalysis()">
                  <i class="fa-solid fa-magnifying-glass"></i> Analyze
                </button>
              </div>
            </div>
<div class="dashboard-grid">
        <div class="kpi-column">
          <div class="kpi-box">
            <div class="kpi-head" id="kpi1_title">Total Traffic</div>
            <div class="kpi-val" id="kpi1_val">-</div>
            <div class="kpi-sub" id="kpi1_sub">Select Dates</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-head" id="kpi2_title">Avg. Dwell Time</div>
            <div class="kpi-val" id="kpi2_val">-</div>
            <div class="kpi-sub" id="kpi2_sub">Seconds</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-head" id="kpi3_title">Attention Ratio</div>
            <div class="kpi-val" id="kpi3_val">-</div>
            <div class="kpi-sub" id="kpi3_sub">High Attention</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-head" id="kpi4_title">Top Persona</div>
            <div class="kpi-val" id="kpi4_val">-</div>
            <div class="kpi-sub" id="kpi4_sub">Target Group</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-head">Effective Reach</div>
            <div class="kpi-val" id="kpi5_val">-</div>
            <div class="kpi-sub">3s+ & Attn High</div>
          </div>
          
          <div class="kpi-box">
            <div class="kpi-head">Target Match</div>
            <div class="kpi-val" id="kpi6_val">-</div>
            <div class="kpi-sub">Target %</div>
          </div>
          
          <div class="kpi-box">
            <div class="kpi-head">Deep Engaged</div>
            <div class="kpi-val" id="kpi7_val">-</div>
            <div class="kpi-sub">Over 10s</div>
          </div>
          
          <div class="kpi-box">
            <div class="kpi-head">Total Attn. Hrs</div>
            <div class="kpi-val" id="kpi8_val">-</div>
            <div class="kpi-sub">Hours Consumed</div>
          </div>
        </div>

        <div class="charts-row">
          <div class="chart-half">
            <div class="chart-header">
              <div>
                <div style="font-weight:700;" id="chart1_title">Demographics</div>
                <div style="font-size:12px; color:#9CA3AF;">Gender & Age Distribution</div>
              </div>
            </div>
            <div class="bar-chart-container" id="barChartContainer">
              <div style="text-align:center; color:#CBD5E1; margin-top:40px;">Ready to Analyze</div>
            </div>
          </div>

          <div class="chart-half">
            <div class="chart-header">
              <div>
                <div style="font-weight:700;" id="chart2_title">Time Analysis</div>
                <div style="font-size:12px; color:#9CA3AF;">Peak Time Heatmap</div>
              </div>
            </div>
            <div class="heatmap-layout">
              <div class="hm-container">
                <div class="hm-y"><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span></div>
                <div class="hm-grid-box" id="analysisHeatGrid">
                   </div>
              </div>
              <div class="hm-x"><span>09</span><span>12</span><span>15</span><span>18</span><span>21</span></div>
            </div>
          </div>
        </div>
    <div class="charts-row" style="margin-top: 16px; grid-column: 2;">
          <div class="chart-half">
            <div class="chart-header">
              <div>
                <div style="font-weight:700;">Audience Pattern</div>
                <div style="font-size:12px; color:#9CA3AF;">Time(X) vs Age(Y) • Size: Attention</div>
              </div>
              <div style="font-size:10px; display:flex; gap:8px;">
                <span style="color:#3B82F6">● Male</span>
                <span style="color:#EF4444">● Female</span>
              </div>
            </div>
            <div style="flex:1; padding: 10px 20px 20px 10px;">
              <div class="scatter-container" id="scatterChart">
                 <div style="text-align:center; padding-top:60px; color:#ddd;">Select Date & Analyze</div>
              </div>
            </div>
          </div>

          <div class="chart-half">
            <div class="chart-header">
              <div>
                <div style="font-weight:700;">Engagement Quality</div>
                <div style="font-size:12px; color:#9CA3AF;">Dwell Time Distribution</div>
              </div>
            </div>
            <div style="flex:1; padding: 10px;">
              <div class="v-bar-container" id="dwellChart">
                 <div style="text-align:center; width:100%; padding-top:60px; color:#ddd;">No Data</div>
              </div>
            </div>
          </div>
        </div>
      </div>
   </div>

    <div id="page-monitors" class="page-view">
      <div class="top-section">
        <div class="page-header">
          <h1>Monitor Management</h1>
          <p>등록된 모니터 기기 목록 및 상태를 관리합니다.</p>
        </div>
        <button class="btn btn-primary" onclick="openAddModal()">
          <i class="fa-solid fa-plus"></i> Add New Monitor
        </button>
      </div>

      <div class="map-card" style="margin-bottom: 24px; height: 300px;">
        <div id="monitorMap" style="width:100%; height:100%;"></div>
        <div class="map-badge"><i class="fa-solid fa-map" style="color:#3B82F6"></i> Device Overview</div>
      </div>

      <div class="table-container">
        <div class="table-header">
          <div>ID</div><div>Location Name</div><div>Coordinates</div><div>Status</div><div>Last Update</div><div style="text-align:right">Action</div>
        </div>
        
        <div class="monitor-list" id="monitorList">
          <div style="padding:40px; text-align:center; color:#999;">데이터를 불러오는 중입니다...</div>
        </div>
      </div>
    </div>


    <div id="page-ads" class="page-view">
          <div class="top-section">
            <div class="page-header">
              <h1>Ad Manager</h1>
              <p>송출할 광고 콘텐츠 목록을 관리합니다.</p>
            </div>
            <button class="btn btn-primary" onclick="openAddAdModal()">
              <i class="fa-solid fa-plus"></i> Add New Ad
            </button>
          </div>

          <div class="table-container">
            <div class="table-header" style="grid-template-columns: 1fr 2fr 1.5fr 1fr 1fr 1fr;">
              <div>Ad ID</div><div>Ad Name</div><div>Client</div><div>Status</div><div>Registered</div><div style="text-align:right">Action</div>
            </div>
        
            <div class="monitor-list" id="adList">
              <div style="padding:40px; text-align:center; color:#999;">Loading Ads...</div>
            </div>
          </div>
        </div>

        <div id="page-upload" class="page-view">
          <div class="top-section">
            <div class="page-header">
              <h1>Data Upload</h1>
              <p>Face Analysis 및 Video Log CSV 파일을 업로드하세요.</p>
            </div>
          </div>
          
          <input type="file" id="file_face" accept=".csv, .xlsx, .xls" style="display:none" onchange="handleFileSelect(this, 'face')">
          <input type="file" id="file_video" accept=".csv, .xlsx, .xls" style="display:none" onchange="handleFileSelect(this, 'video')">
    
          <div class="upload-section">
            <div class="upload-card" id="drop_zone_face" onclick="document.getElementById('file_face').click()">
              <i class="fa-solid fa-users-viewfinder upload-icon"></i>
              <div class="upload-title">Face Analysis CSV</div>
              <div class="upload-desc">Click to Upload or Drag & Drop</div>
              <div id="status_face" class="file-status"></div>
            </div>
            
            <div class="upload-card" id="drop_zone_video" onclick="document.getElementById('file_video').click()">
              <i class="fa-solid fa-file-video upload-icon"></i>
              <div class="upload-title">Video Log CSV</div>
              <div class="upload-desc">Click to Upload or Drag & Drop</div>
              <div id="status_video" class="file-status"></div>
            </div>
          </div>
    
          <div style="margin-top:20px; text-align:right;">
            <button class="btn btn-primary" style="padding:14px 28px; font-size:15px;" onclick="startUploadProcess()">
              <i class="fa-solid fa-cloud-arrow-up"></i> Start Analysis Processing
            </button>
          </div>
        </div>
    
      </div> <div class="modal-overlay" id="addModal">
        <div class="modal-box">
          <div class="modal-title">Add New Monitor</div>
          <input type="text" id="new_id" class="form-input-full" placeholder="Monitor ID (ex: SEOUL_GN_01)">
          <input type="text" id="new_name" class="form-input-full" placeholder="Location Name (ex: 강남역 1번출구)">
          <div style="display:flex; gap:10px;">
            <input type="text" id="new_lat" class="form-input-full" placeholder="Latitude (위도)" readonly style="background:#f9f9f9">
            <input type="text" id="new_lng" class="form-input-full" placeholder="Longitude (경도)" readonly style="background:#f9f9f9">
          </div>
          <div class="modal-actions">
            <button class="btn btn-primary" style="flex:1" onclick="saveNewMonitor()">Save</button>
            <button class="btn btn-white" style="flex:1" onclick="closeAddModal()">Cancel</button>
          </div>
        </div>
      </div>
      <div class="modal-overlay" id="addAdModal">
              <div class="modal-box">
                <div class="modal-title">Add New Ad</div>
                <input type="text" id="new_ad_id" class="form-input-full" placeholder="Ad ID (ex: AD_NIKE_001)">
                <input type="text" id="new_ad_name" class="form-input-full" placeholder="Ad Name (ex: 나이키 썸머 세일)">
                <input type="text" id="new_ad_client" class="form-input-full" placeholder="Client Name (ex: 나이키 코리아)">
          
                <label style="font-size:12px; font-weight:bold; color:#666; display:block; margin-bottom:8px;">Status</label>
                <select id="new_ad_status" class="form-input-full">
                  <option value="active">Active (집행 중)</option>
                  <option value="inactive">Inactive (중지)</option>
                </select>

                <div class="modal-actions">
                  <button class="btn btn-primary" style="flex:1" onclick="saveNewAd()">Save Ad</button>
                  <button class="btn btn-white" style="flex:1" onclick="closeAddAdModal()">Cancel</button>
                </div>
              </div>
           </div>


  <script>
  /* 1. FIREBASE CONFIGURATION */
  const firebaseConfig = {
    apiKey: "AIzaSyDjxFnP5wEE6ivH6VSUHsu8nR_X8GkARB0",
    authDomain: "twopage-ea909.firebaseapp.com",
    projectId: "twopage-ea909",
    storageBucket: "twopage-ea909.firebasestorage.app",
    messagingSenderId: "398686352913",
    appId: "1:398686352913:web:0bb872aa1e71c62ad863b0"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /* 2. DYNAMIC UI INJECTION */
  const modalBox = document.querySelector('.modal-box');
  if (modalBox) {
    const mapContainer = document.createElement('div');
    mapContainer.id = "modalMap";
    mapContainer.className = "modal-map";
    const title = modalBox.querySelector('.modal-title');
    title.insertAdjacentElement('afterend', mapContainer);
  }
  const uploadHeader = document.querySelector('#page-upload .page-header');
  if (uploadHeader) {
    const selectDiv = document.createElement('div');
    selectDiv.style.marginTop = "16px";
    selectDiv.innerHTML = `<label style="font-size:13px; font-weight:700; color:#374151; display:block; margin-bottom:8px;">Target Monitor</label><select id="upload_monitor_select" style="width:100%; max-width:300px; padding:10px; border:1px solid #E5E7EB; border-radius:8px; font-size:14px;"><option value="">Select a monitor...</option></select>`;
    uploadHeader.appendChild(selectDiv);
  }

  /* 3. MAP LOGIC */
  var dashboardMap = null;
  var monitorMap = null; // [NEW] 모니터 관리용 지도
  var modalMap = null;
  var tempMarker = null;
  var monitorMarkers = []; // [NEW] 모니터 지도 마커 리스트
  var dashboardMarkers = []; // [추가됨] 대시보드 마커 리스트

  function initMaps() {
    // 1. 대시보드 맵
    dashboardMap = new naver.maps.Map('miniMap', { center: new naver.maps.LatLng(37.498095, 127.027610), zoom: 15 });
    
    // 2. [NEW] 모니터 관리 맵
    monitorMap = new naver.maps.Map('monitorMap', { center: new naver.maps.LatLng(37.498095, 127.027610), zoom: 14 });

    // 3. 모달 맵
    modalMap = new naver.maps.Map('modalMap', { center: new naver.maps.LatLng(37.498095, 127.027610), zoom: 15 });
    naver.maps.Event.addListener(modalMap, 'click', function(e) { setModalMarker(e.coord); });
  }

  function setModalMarker(latlng) {
    if (tempMarker) tempMarker.setMap(null);
    tempMarker = new naver.maps.Marker({
      position: latlng, map: modalMap,
      icon: { content: '<div style="background:#2563EB; width:20px; height:20px; border:3px solid white; border-radius:50%; box-shadow:0 0 10px rgba(37,99,235,0.5);"></div>', anchor: new naver.maps.Point(10, 10) }
    });
    document.getElementById('new_lat').value = latlng.lat();
    document.getElementById('new_lng').value = latlng.lng();
  }

  /* 4. PAGE NAVIGATION */
  /* 수정된 showPage 함수 */
  function showPage(pageId, btn) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.page-view').forEach(el => el.classList.remove('active'));
    document.getElementById('page-' + pageId).classList.add('active');
  
    // 지도 깨짐 방지 및 데이터 로드
    if(pageId === 'dashboard') {
      // 대시보드 맵 리사이즈 (기존 코드 유지)
      setTimeout(() => dashboardMap.setSize(new naver.maps.Size(document.querySelector('#page-dashboard .map-card').offsetWidth, 280)), 100);
    } else if (pageId === 'monitors') {
      // [수정됨] 모니터 페이지 열릴 때 정확한 타겟(.map-card)의 너비를 가져오도록 수정
      setTimeout(() => {
        // 1. #page-monitors 안의 .map-card를 찾도록 수정
        const monitorCard = document.querySelector('#page-monitors .map-card'); 
        
        if (monitorCard) {
          monitorMap.setSize(new naver.maps.Size(monitorCard.offsetWidth, 300));
          
          // (선택사항) 리사이즈 후 중심점이 어긋나는 것을 방지하기 위해 센터 재설정 추천
          // monitorMap.setCenter(new naver.maps.LatLng(37.498095, 127.027610)); 
        }
        
        loadMonitorList(); 
      }, 100);
    } else if (pageId === 'upload') {
          loadMonitorSelectOptions();
        } else if (pageId === 'ads') {
          loadAdList();
        }
      }

  /* 5. MONITOR MANAGEMENT (리스트 + 지도 마커) */
  /* 5. MONITOR MANAGEMENT (리스트 + 지도 마커) */
  function loadMonitorList() {
    const listEl = document.getElementById('monitorList');
    listEl.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">Loading...</div>';
    
    // 1. 기존 마커들 초기화
    monitorMarkers.forEach(m => m.setMap(null));
    monitorMarkers = [];
    
    // 대시보드 마커 초기화 (변수가 없으면 안전하게 생성)
    if(typeof dashboardMarkers !== 'undefined') {
        dashboardMarkers.forEach(m => m.setMap(null));
        dashboardMarkers = [];
    } else {
        window.dashboardMarkers = [];
    }

    // 2. 지도 범위(Bounds) 객체 생성 (자동 줌 조절용)
    const bounds = new naver.maps.LatLngBounds();

    db.collection("monitors").orderBy("updated_at", "desc").get().then((snapshot) => {
      let html = '';
      if (snapshot.empty) {
        listEl.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">등록된 모니터가 없습니다.</div>';
        return;
      }

      snapshot.forEach((doc) => {
        const d = doc.data();
        const badgeClass = d.status === 'active' ? 'st-active' : 'st-inactive';
        let dateStr = '-';
        if(d.updated_at) {
          const date = d.updated_at.toDate();
          dateStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
        }

        // --- HTML 리스트 생성 ---
        html += `
          <div class="table-row">
            <div style="font-weight:700; color:#3B82F6;">#${d.monitor_id}</div>
            <div style="font-weight:600;">${d.name}</div>
            <div style="color:#6B7280; font-size:13px;">${d.location.lat.toFixed(4)}, ${d.location.lng.toFixed(4)}</div>
            <div><span class="status-badge ${badgeClass}"><span class="st-dot"></span> ${d.status.toUpperCase()}</span></div>
            <div style="color:#6B7280; font-size:13px;">${dateStr}</div>
            <div style="text-align:right; display:flex; justify-content:flex-end; gap:8px;">
              <button class="action-btn" onclick="openEditModal('${d.monitor_id}', '${d.name}', ${d.location.lat}, ${d.location.lng})"><i class="fa-solid fa-pen"></i></button>
              <button class="action-btn" onclick="deleteMonitor('${d.monitor_id}')"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
        `;

        const position = new naver.maps.LatLng(d.location.lat, d.location.lng);
        
        // [중요] 데이터가 있는 위치로 지도 범위 확장
        bounds.extend(position);

        // --- A. 모니터 관리 페이지용 마커 (파란색) ---
        const mMarker = new naver.maps.Marker({
          position: position,
          map: monitorMap,
          icon: {
            content: `<div style="position:relative; cursor:pointer;">
              <div style="background:#3B82F6; width:12px; height:12px; border:2px solid white; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>
              <div style="position:absolute; top:-25px; left:50%; transform:translateX(-50%); background:white; padding:3px 6px; border-radius:6px; font-size:10px; font-weight:700; box-shadow:0 1px 3px rgba(0,0,0,0.2); white-space:nowrap;">${d.name}</div>
            </div>`,
            anchor: new naver.maps.Point(6, 6)
          }
        });
        monitorMarkers.push(mMarker);

        // --- B. 대시보드용 마커 (빨간색 점) ---
        if(dashboardMap) {
            const dMarker = new naver.maps.Marker({
              position: position,
              map: dashboardMap,
              icon: {
                content: `<div style="background:#EF4444; width:10px; height:10px; border:2px solid white; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.3);" title="${d.name}"></div>`,
                anchor: new naver.maps.Point(5, 5)
              }
            });
            dashboardMarkers.push(dMarker);
        }
      });
      
      listEl.innerHTML = html;
      
      // [핵심] 마커들이 모두 보이도록 지도 중심과 줌을 자동 조절
      if(monitorMarkers.length > 0) {
        monitorMap.fitBounds(bounds, { padding: 50 }); // 모니터 맵 자동 조절
        if(dashboardMap) {
            dashboardMap.fitBounds(bounds, { padding: 30 }); // 대시보드 맵 자동 조절
        }
      }
    });
  }

  function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }

  function saveNewMonitor() {
    const id = document.getElementById('new_id').value;
    const name = document.getElementById('new_name').value;
    const lat = parseFloat(document.getElementById('new_lat').value);
    const lng = parseFloat(document.getElementById('new_lng').value);

    if(!id || !name || isNaN(lat)) return alert("ID, 이름, 위치(지도클릭)는 필수입니다.");

    db.collection("monitors").doc(id).set({
      monitor_id: id, name: name, location: {lat, lng}, status: 'active',
      updated_at: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true }).then(() => {
      alert("저장되었습니다!");
      closeAddModal();
      loadMonitorList();
    });
  }

  function deleteMonitor(id) {
    if(confirm("정말 삭제하시겠습니까?")) {
      db.collection("monitors").doc(id).delete().then(() => loadMonitorList());
    }
  }
  /* [NEW] AD MANAGER LOGIC */
    function loadAdList() {
      const listEl = document.getElementById('adList');
      listEl.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">Loading Ads...</div>';
      
      db.collection("ads").orderBy("updated_at", "desc").get().then((snapshot) => {
        let html = '';
        if (snapshot.empty) {
          listEl.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">등록된 광고가 없습니다.</div>';
          return;
        }
  
        snapshot.forEach((doc) => {
          const d = doc.data();
          const badgeClass = d.status === 'active' ? 'st-active' : 'st-inactive';
          let dateStr = '-';
          if(d.updated_at) {
            const date = d.updated_at.toDate();
            dateStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
          }
  
          html += `
            <div class="table-row" style="grid-template-columns: 1fr 2fr 1.5fr 1fr 1fr 1fr;">
              <div style="font-weight:700; color:#3B82F6;">${d.ad_id}</div>
              <div style="font-weight:600;">${d.name}</div>
              <div style="color:#6B7280; font-size:13px;">${d.client || '-'}</div>
              <div><span class="status-badge ${badgeClass}"><span class="st-dot"></span> ${d.status.toUpperCase()}</span></div>
              <div style="color:#6B7280; font-size:13px;">${dateStr}</div>
              <div style="text-align:right;">
                <button class="action-btn delete" onclick="deleteAd('${d.ad_id}')"><i class="fa-solid fa-trash"></i></button>
              </div>
            </div>
          `;
        });
        listEl.innerHTML = html;
      });
    }
  
    function openAddAdModal() {
      document.getElementById('new_ad_id').value = '';
      document.getElementById('new_ad_name').value = '';
      document.getElementById('new_ad_client').value = '';
      document.getElementById('addAdModal').style.display = 'flex';
    }
  
    function closeAddAdModal() {
      document.getElementById('addAdModal').style.display = 'none';
    }
  
  // [수정됨] 광고 등록: 중복 ID 체크 로직 추가
  function saveNewAd() {
    const id = document.getElementById('new_ad_id').value.trim(); // 공백 제거
    const name = document.getElementById('new_ad_name').value;
    const client = document.getElementById('new_ad_client').value;
    const status = document.getElementById('new_ad_status').value;

    if(!id || !name) return alert("ID와 광고명은 필수입니다.");

    // 1. 먼저 해당 ID가 존재하는지 확인 (중복 체크)
    db.collection("ads").doc(id).get().then((docSnapshot) => {
      if (docSnapshot.exists) {
        // 2. 이미 존재하면 경고창 띄우고 중단
        alert(`[중복 오류] Ad ID '${id}'는 이미 등록된 ID입니다.\n다른 ID를 사용해주세요.`);
        return; 
      } else {
        // 3. 존재하지 않으면 저장 진행
        db.collection("ads").doc(id).set({
          ad_id: id, 
          name: name, 
          client: client, 
          status: status,
          updated_at: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          alert("광고가 성공적으로 등록되었습니다!");
          closeAddAdModal();
          loadAdList();
        });
      }
    }).catch((error) => {
      console.error("Error checking ID:", error);
      alert("ID 확인 중 오류가 발생했습니다.");
    });
  }
  
    function deleteAd(id) {
      if(confirm("이 광고 정보를 삭제하시겠습니까?")) {
        db.collection("ads").doc(id).delete().then(() => loadAdList());
      }
    }
  // [새로운 코드] 추가 버튼 눌렀을 때 (내용 비우고 열기)
    function openAddModal() { 
      // 1. 입력창 초기화
      document.getElementById('new_id').value = '';
      document.getElementById('new_name').value = '';
      document.getElementById('new_lat').value = '';
      document.getElementById('new_lng').value = '';
      
      // 2. ID 입력창 활성화 (수정 모드에서 잠겼을 수 있으므로 풀기)
      const idInput = document.getElementById('new_id');
      idInput.disabled = false;
      idInput.style.backgroundColor = "white";
  
      // 3. 타이틀 변경
      const titleEl = document.querySelector('.modal-title');
      if(titleEl) titleEl.innerText = "Add New Monitor";
  
      // 4. 모달 열기
      document.getElementById('addModal').style.display = 'flex';
      
      // 5. 지도 세팅 (기존 마커 제거)
      setTimeout(() => {
        if(modalMap) {
            modalMap.setSize(new naver.maps.Size(document.getElementById('modalMap').offsetWidth, 200));
            if(tempMarker) tempMarker.setMap(null); 
        }
      }, 100);
    }
  
    // [새로운 코드] 수정 버튼 눌렀을 때 (내용 채우고 열기)
    function openEditModal(id, name, lat, lng) {
      // 1. 기존 값 채워넣기
      const idInput = document.getElementById('new_id');
      idInput.value = id;
      document.getElementById('new_name').value = name;
      document.getElementById('new_lat').value = lat;
      document.getElementById('new_lng').value = lng;
  
      // 2. ID는 수정 못하게 막기 (회색 처리)
      idInput.disabled = true;
      idInput.style.backgroundColor = "#F3F4F6"; 
  
      // 3. 타이틀 변경
      const titleEl = document.querySelector('.modal-title');
      if(titleEl) titleEl.innerText = "Edit Monitor";
  
      // 4. 모달 열기
      document.getElementById('addModal').style.display = 'flex';
  
      // 5. 지도 세팅 (해당 위치에 마커 찍기)
      setTimeout(() => {
        if(modalMap) {
            modalMap.setSize(new naver.maps.Size(document.getElementById('modalMap').offsetWidth, 200));
            
            const targetLoc = new naver.maps.LatLng(lat, lng);
            modalMap.setCenter(targetLoc); // 지도 중심 이동
            setModalMarker(targetLoc);     // 마커 표시
        }
      }, 100);
    }

  function loadMonitorSelectOptions() {
    const sel = document.getElementById('upload_monitor_select');
    if(!sel) return;
    
    db.collection("monitors").get().then((snapshot) => {
      let opts = '<option value="">Select a monitor...</option>';
      snapshot.forEach((doc) => {
        const d = doc.data();
        opts += `<option value="${d.monitor_id}">${d.name} (${d.monitor_id})</option>`;
      });
      sel.innerHTML = opts;
    });
  }
/* 6. [NEW] EXCEL UPLOAD & PROCESSING LOGIC (Final: Multi-File + Date Parsing) */
  // [변경] 여러 파일을 담기 위해 배열([])로 초기화
  let selectedFiles = { face: [], video: [] };

  // [수정됨] 파일 목록 처리 함수 (여러 파일 처리)
  function handleFileUpdate(files, type) {
    if (files && files.length > 0) {
      // FileList를 배열로 변환하여 저장
      selectedFiles[type] = Array.from(files);
      
      // UI 업데이트: 선택된 파일 개수 표시
      const count = selectedFiles[type].length;
      const firstName = selectedFiles[type][0].name;
      const text = count === 1 ? 
        `Ready: ${firstName}` : 
        `Ready: ${count} files selected`;
      
      document.getElementById('status_' + type).innerText = text;
      
      // 드래그 효과 유지를 위한 스타일
      document.getElementById('drop_zone_' + type).style.borderColor = "#3B82F6";
      document.getElementById('drop_zone_' + type).style.backgroundColor = "#EFF6FF";
    }
  }

  // [기존] Input 변경 시 호출
  function handleFileSelect(input, type) {
    handleFileUpdate(input.files, type);
  }

  // [기존] 드래그 앤 드롭 초기화
  function initDragAndDrop() {
    const zones = [
      { id: 'drop_zone_face', type: 'face' },
      { id: 'drop_zone_video', type: 'video' }
    ];

    zones.forEach(item => {
      const zone = document.getElementById(item.id);
      if (!zone) return;

      ['dragenter', 'dragover'].forEach(eventName => {
        zone.addEventListener(eventName, (e) => {
          e.preventDefault(); e.stopPropagation();
          zone.classList.add('drag-over');
        }, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        zone.addEventListener(eventName, (e) => {
          e.preventDefault(); e.stopPropagation();
          zone.classList.remove('drag-over');
        }, false);
      });

      zone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        handleFileUpdate(dt.files, item.type); // 여러 파일 전달
      }, false);
    });
  }

  // [수정됨] 다중 파일 업로드 시작 로직
  // [수정됨] 업로드 시작 함수: 로딩 화면 제어 및 예외 처리 강화
  async function startUploadProcess() {
    const monitorId = document.getElementById('upload_monitor_select').value;
    
    if (!monitorId) return alert("Please select a Target Monitor first.");
    if (selectedFiles.face.length === 0 && selectedFiles.video.length === 0) {
      return alert("Please select files to upload.");
    }

    const totalFiles = selectedFiles.face.length + selectedFiles.video.length;

    if (confirm(`Monitor [${monitorId}]에 총 ${totalFiles}개의 파일을 업로드 하시겠습니까?`)) {
      // 1. 화면 잠금 (로딩 시작) - 사용자가 다른 버튼을 못 누르게 함
      document.getElementById('globalLoader').style.display = 'flex';
      document.getElementById('globalLoaderMsg').innerText = "Starting Upload...";

      const promises = [];

      // Face 파일 처리
      selectedFiles.face.forEach(file => {
        promises.push(processAndUpload(file, 'face_analysis', monitorId));
      });

      // Video 파일 처리
      selectedFiles.video.forEach(file => {
        promises.push(processAndUpload(file, 'video_logs', monitorId));
      });

      // 모든 처리가 끝날 때까지 대기
      try {
        await Promise.all(promises);
        
        // 성공 시 초기화
        selectedFiles = { face: [], video: [] };
        document.getElementById('status_face').innerText = "";
        document.getElementById('status_video').innerText = "";
        
        // 달력 데이터 갱신
        checkDataExistence();
        
        alert(`Successfully processed ${totalFiles} files!`);
      } catch (error) {
        console.error(error);
        alert("Some uploads failed. Check console for details.");
      } finally {
        // 2. 화면 잠금 해제 (성공하든 실패하든 무조건 실행)
        document.getElementById('globalLoader').style.display = 'none';
      }
    }
  }

  // [수정됨] 개별 파일 파싱 및 업로드 (Promise 반환)
  function processAndUpload(file, collectionName, monitorId) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);

          if(jsonData.length === 0) {
            console.warn(`File ${file.name} is empty.`);
            resolve(); 
            return;
          }

          // 파일명(file.name)을 전달하여 배치 업로드 호출
          uploadInBatches(jsonData, collectionName, monitorId, file.name)
            .then(() => {
              console.log(`Finished: ${file.name}`);
              resolve();
            })
            .catch(err => reject(err));

        } catch (err) {
          console.error("Error parsing file:", file.name, err);
          reject(err);
        }
      };
      
      reader.onerror = (err) => reject(err);
      reader.readAsArrayBuffer(file);
    });
  }


  // [수정됨] 1. 파일명에 날짜가 없으면 절대 저장하지 않도록 강제 (12월 2일 데이터 생성 방지)
  async function uploadInBatches(data, collectionName, monitorId, fileName) {
    const BATCH_SIZE = 450;
    const total = data.length;
    
    // 날짜 포맷 허용 범위 확장 (2025-05-09, 2025.05.09, 2025_05_09 모두 허용)
    const dateRegex = /(\d{4})[-_.](\d{2})[-_.](\d{2})/;
    const match = fileName.match(dateRegex);
    
    let fileDateObj = null;
    let dateStr = ""; 
    
    if (match) {
      const year = parseInt(match[1]);
      const month = parseInt(match[2]);
      const day = parseInt(match[3]);
      
      // DB 검색용 문자열 (YYYY-MM-DD 통일)
      dateStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      
      // 날짜 객체 (시간은 낮 12시로 고정하여 타임존 이슈 방지)
      fileDateObj = new Date(year, month - 1, day, 12, 0, 0);
      
      console.log(`[Date Detected] ${fileName} -> ${dateStr}`);
    } else {
      // [핵심 수정] 날짜를 못 찾으면 오늘 날짜로 대체하지 않고, 경고 후 중단합니다.
      alert(`[업로드 실패] 파일명에서 날짜를 찾을 수 없습니다.\n\n파일명: ${fileName}\n\n데이터 오염을 방지하기 위해 업로드를 중단합니다.\n파일명에 '2025-05-09'와 같은 날짜를 포함해주세요.`);
      throw new Error("Date extraction failed. Upload aborted to prevent bad data."); 
    }
    
    // 데이터 저장 시작
    for (let i = 0; i < total; i += BATCH_SIZE) {
      const batch = db.batch();
      const chunk = data.slice(i, i + BATCH_SIZE);
      
      chunk.forEach((row) => {
        const docRef = db.collection(collectionName).doc();
        
        let newRow = {
          monitor_id: monitorId,
          // uploaded_at은 '데이터가 DB에 들어온 시각' 기록용으로만 남김 (달력 표시용 아님)
          uploaded_at: firebase.firestore.Timestamp.now(), 
          
          // ★ 달력과 분석에는 무조건 아래 두 필드만 사용됨
          file_date: firebase.firestore.Timestamp.fromDate(fileDateObj), 
          date: dateStr, 
          
          source_filename: fileName
        };

        // 데이터 매핑 (기존과 동일)
        if (collectionName === 'face_analysis') {
            newRow.age = Number(row['평균 나이']) || 0;
            newRow.age_group = Math.floor(newRow.age / 10) * 10;
            newRow.gender = row['성별'] || 'Unknown';
            newRow.attention = Number(row['정면 점수']) || 0;
            newRow.start_time = row['처음 발견된 시간'] || '';
            newRow.end_time = row['없어진 시간'] || '';
            newRow.duration = row['지속 시간'] || '';
        } else if (collectionName === 'video_logs') {
            newRow.start_time = row['송출시작 시간'] || '';
            newRow.end_time = row['송출 끝난시간'] || '';
            newRow.ad_id = row['영상이름'] ? row['영상이름'].replace(/\.mp4$/i, '').trim() : 'UNKNOWN';
        }

        batch.set(docRef, newRow);
      });

      await batch.commit();

      // [달력 데이터 갱신] 반드시 추출된 파일 날짜(dateStr)를 키로 사용
      const statsDocId = `${dateStr}_${monitorId}`;
      await db.collection('calendar_stats').doc(statsDocId).set({
        dateKey: dateStr, 
        monitor_id: monitorId,
        has_data: true
      }, { merge: true });
    }
  }
/* 7. CALENDAR LOGIC (Real Data Integration) */
  let currentCalDate = new Date();
  let selectedDates = []; 
  let dataDates = new Set(); // [NEW] 데이터가 존재하는 날짜들을 저장하는 집합


    // [수정됨] 2. 잘못된 날짜(오늘) 데이터를 삭제하고, 파일 원본 날짜만 달력에 표시
    async function migrateExistingData() {
      if(!confirm("달력 데이터를 '파일 날짜' 기준으로 재설정하시겠습니까?\n(잘못된 오늘 날짜 데이터는 달력에서 사라집니다)")) return;
      
      const loader = document.getElementById('calLoader');
      if(loader) { loader.style.display = 'flex'; loader.querySelector('span').innerText = "Fixing Calendar..."; }
  
      try {
        // A. 기존 달력 정보(calendar_stats) 전체 삭제 (초기화)
        const oldStats = await db.collection('calendar_stats').get();
        const deleteBatch = db.batch();
        oldStats.forEach(doc => deleteBatch.delete(doc.ref));
        await deleteBatch.commit();
        console.log("기존 달력 데이터 초기화 완료");

        // B. Face Analysis 데이터 전수 조사
        const snap = await db.collection('face_analysis').get();
        const batch = db.batch();
        let count = 0;
        let addedKeys = new Set();
  
        snap.forEach(doc => {
          const d = doc.data();
          
          let targetDateKey = null;

          // [핵심] 오직 'date' 필드나 'file_date' 필드가 있을 때만 달력에 추가
          // uploaded_at(업로드 시간)은 절대 참조하지 않음 -> 12월 2일 문제 해결
          if (d.date && d.date.match(/^\d{4}-\d{2}-\d{2}$/)) {
            targetDateKey = d.date; 
          } 
          else if (d.file_date) {
            const dateObj = d.file_date.toDate();
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            targetDateKey = `${y}-${m}-${day}`;
          }
          
          // 유효한 날짜가 없으면 건너뜀 (오늘 날짜로 찍히는 것 방지)
          if (!targetDateKey) return;

          if(d.monitor_id) {
            const statsId = `${targetDateKey}_${d.monitor_id}`;
  
            if(!addedKeys.has(statsId)) {
              const ref = db.collection('calendar_stats').doc(statsId);
              batch.set(ref, {
                dateKey: targetDateKey, // 예: "2025-05-09"
                monitor_id: d.monitor_id,
                has_data: true
              }, { merge: true });
              
              addedKeys.add(statsId);
              count++;
            }
          }
        });
  
        await batch.commit();
        alert(`달력 복구가 완료되었습니다.\n총 ${count}일의 유효한 데이터가 복구되었습니다.`);
        
        // C. 달력 새로고침
        checkDataExistence(); 
        
      } catch(e) {
        console.error(e);
        alert("복구 중 오류 발생: " + e.message);
      } finally {
        if(loader) loader.style.display = 'none';
      }
    }
    let allLogCache = []; // 전체 데이터를 메모리에 저장 (속도 최적화)
    /* [NEW] Filter & Analysis Logic */
// [수정됨] 필터 상태 저장 변수 (나이는 배열[]로 초기화)
      let currentFilters = { gender: 'ALL', age: ['ALL'], attention: 'ALL' };
      
      // [수정됨] 필터 칩 선택 함수 (나이 그룹 복수 선택 지원)
      function selectFilter(type, el, value) {
        const group = document.getElementById('filter_' + type);

        // A. 나이(Age) 외의 필터 (기존 방식: 단일 선택)
        if (type !== 'age') {
          group.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          el.classList.add('active');
          currentFilters[type] = value;
        } 
        
        // B. 나이(Age) 필터 (복수 선택 로직)
        else {
          // B-1. "전체(ALL)"을 클릭했을 때
          if (value === 'ALL') {
            // 모든 칩 끄고 ALL만 켜기
            group.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            currentFilters.age = ['ALL'];
          } 
          // B-2. 특정 나이대를 클릭했을 때
          else {
            // 만약 현재 'ALL'이 켜져 있었다면 -> 끄고 시작
            const allChip = group.firstElementChild; // 첫 번째 칩이 '전체'라고 가정
            if (currentFilters.age.includes('ALL')) {
                allChip.classList.remove('active');
                currentFilters.age = [];
            }

            // 클릭한 칩 토글 (켜져있으면 끄고, 꺼져있으면 켜기)
            if (el.classList.contains('active')) {
              el.classList.remove('active');
              currentFilters.age = currentFilters.age.filter(v => v !== value); // 배열에서 제거
            } else {
              el.classList.add('active');
              currentFilters.age.push(value); // 배열에 추가
            }

            // 다 껐을 경우 -> 자동으로 '전체(ALL)' 다시 선택
            if (currentFilters.age.length === 0) {
              allChip.classList.add('active');
              currentFilters.age = ['ALL'];
            }
          }
        }
        
        // 디버깅용: 현재 선택된 필터 상태 확인
        console.log("Current Filters:", currentFilters);
      }
    
      // 사이드바 광고 목록 불러오기
      function loadSidebarAds() {
        const adSel = document.getElementById('sidebarAdSelect');
        if(!adSel) return;
    
        db.collection("ads").get().then(snapshot => {
          let opts = '<option value="ALL">All Ads</option>';
          snapshot.forEach(doc => {
            const d = doc.data();
            // 삭제되지 않은(active/inactive) 광고만 표시
            opts += `<option value="${d.ad_id}">${d.name}</option>`;
          });
          adSel.innerHTML = opts;
        });
      }
    
      // [핵심] 분석 버튼 클릭 시 실행
    // ==========================================
    // [3. ANALYTICS LOGIC START]
    // ==========================================
    // [NEW] 서버의 시간 문자열(HH:MM:SS.ms)을 초(Seconds) 단위 숫자로 변환하는 함수
        function parseServerDuration(raw) {
          if (typeof raw === 'number') return raw; 
          if (typeof raw === 'string') {
            if (raw.includes(':')) {
              const parts = raw.split(':');
              if (parts.length === 3) {
                const h = parseFloat(parts[0]) || 0;
                const m = parseFloat(parts[1]) || 0;
                const s = parseFloat(parts[2]) || 0; 
                return (h * 3600) + (m * 60) + s;
              }
            }
            return parseFloat(raw) || 0;
          }
          return 0;
        }

    // [CORE] 분석 실행 함수 (버튼 클릭 시 호출)
    async function runAnalysis() {
      const monitorId = document.getElementById('sidebarMonitorSelect').value;
      const adId = document.getElementById('sidebarAdSelect').value;
      
      // 1. 유효성 검사
      if (selectedDates.length === 0) return alert("분석할 날짜를 달력에서 최소 하루 이상 선택해주세요.");
      if (monitorId === 'ALL') return alert("분석할 특정 모니터를 선택해주세요.");

      // 2. 로딩 UI 표시
      document.getElementById('kpi1_val').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
      document.getElementById('kpi2_val').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
      document.getElementById('kpi3_val').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
      document.getElementById('kpi4_val').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
      document.getElementById('barChartContainer').innerHTML = '<div style="text-align:center; padding-top:40px; color:#999;">Loading...</div>';
      document.getElementById('analysisHeatGrid').innerHTML = ''; // 히트맵 초기화
      
      try {
        // 3. Face Analysis 데이터 가져오기 (선택된 날짜 루프)
        let rawFaceData = [];
        for(const date of selectedDates) {
           // 해당 날짜 + 모니터 데이터 조회
           const snap = await db.collection('face_analysis')
             .where('monitor_id', '==', monitorId)
             .where('date', '==', date)
             .get();

                      
           // [수정됨] 데이터를 가져올 때 시간 변환 적용
           snap.forEach(doc => {
               let data = doc.data();
               data.duration = parseServerDuration(data.duration); // 변환 함수 실행
               rawFaceData.push(data);
           });
        }
           

        // 4. 시나리오 분기
        if (adId === 'ALL') {
           // --- [Scenario A] 일반 트래픽 분석 ---
           console.log(`[Analysis] General Traffic Mode: ${rawFaceData.length} rows`);
           analyzeGeneralTraffic(rawFaceData);
        } else {
           // --- [Scenario B] 광고 성과 분석 ---
           // 광고 로그(Video Logs)도 추가로 가져와야 함
           let rawAdLogs = [];
           for(const date of selectedDates) {
             const snap = await db.collection('video_logs')
               .where('monitor_id', '==', monitorId)
               .where('date', '==', date)
               .where('ad_id', '==', adId) // 특정 광고 ID만 필터링
               .get();
             snap.forEach(doc => rawAdLogs.push(doc.data()));
           }
           console.log(`[Analysis] Ad Mode: ${rawAdLogs.length} ad plays found`);
           analyzeAdPerformance(rawFaceData, rawAdLogs, adId);
        }

      } catch(err) {
        console.error(err);
        alert("데이터 분석 중 오류가 발생했습니다. 콘솔을 확인해주세요.");
        document.getElementById('kpi1_val').innerText = "Error";
      }
    }

    // --- [Logic 1] 일반 트래픽 분석 함수 ---
    function analyzeGeneralTraffic(data) {
       // 1. 필터 적용 (성별/연령/주목도)
       const filtered = applyFilters(data);

       // 2. KPI 계산
       const total = filtered.length;
       
       // 평균 체류시간 계산
       const avgDwell = total > 0 ? (filtered.reduce((acc, cur) => acc + (cur.duration || 0), 0) / total).toFixed(1) : 0;
       
       // 주목도 비율 (0.5 이상인 사람 수)
       const highAttn = filtered.filter(d => (d.attention || 0) >= 0.5).length;
       const attnRatio = total > 0 ? ((highAttn / total) * 100).toFixed(1) : 0;
       
       // 주요 방문 페르소나
       const topPersona = getTopPersona(filtered);

       // 3. KPI 박스 업데이트
       updateKPI("Total Traffic", total.toLocaleString(), "Visitors", 
                 "Avg. Dwell Time", avgDwell + "s", "Target: 5.0s",
                 "Attention Ratio", attnRatio + "%", "High Score > 0.5",
                 "Top Persona", topPersona, "Most Frequent");

       // 4. 차트 렌더링
       renderDemographicsBar(filtered);
       renderTimeHeatmap(filtered, 'count'); // 일반 모드는 '방문자 수' 기준 히트맵
       
       // 5. 차트 제목 업데이트
       document.getElementById('chart1_title').innerText = "Demographics";
       document.getElementById('chart2_title').innerText = "Hourly Traffic";
       
       renderBottomCharts(filtered);
    }

    // --- [Logic 2] 광고 성과 분석 함수 ---
    function analyzeAdPerformance(faceData, adLogs, adId) {
       // 1. 시간 매칭 (Time Matching)
       // 광고가 송출된 시간(Start~End) 사이에 감지된 얼굴 데이터만 추출
       let matchedFaces = [];
       
       // 시간 문자열("12:30:00") -> 분(Minute) 단위 정수로 변환하는 헬퍼
       const timeToMin = (t) => { 
           if(!t) return -1; 
           const p = t.split(':'); 
           return parseInt(p[0])*60 + parseInt(p[1]); 
       };

       adLogs.forEach(log => {
          const logStart = timeToMin(log.start_time);
          const logEnd = timeToMin(log.end_time);
          
          // 같은 날짜의 얼굴 데이터 중 시간이 겹치는 것 찾기
          const dayFaces = faceData.filter(f => f.date === log.date);
          
          dayFaces.forEach(face => {
             const faceStart = timeToMin(face.start_time);
             // 얼굴 감지 시간이 광고 송출 시간 범위 내에 있으면 매칭
             if(faceStart >= logStart && faceStart <= logEnd) {
                matchedFaces.push(face);
             }
          });
       });
       
       // 중복 제거 (한 사람이 같은 광고를 여러 번 본 경우 등 처리)
       matchedFaces = [...new Set(matchedFaces)];

       // 2. 필터 적용
       const filtered = applyFilters(matchedFaces);

       // 3. KPI 계산
       const impressions = filtered.length; // 노출 수
       const avgWatch = impressions > 0 ? (filtered.reduce((acc, cur) => acc + (cur.duration || 0), 0) / impressions).toFixed(1) : 0;
       
       // 광고는 주목도 기준을 조금 높게(0.6) 잡아봄
       const highAttn = filtered.filter(d => (d.attention || 0) >= 0.6).length;
       const attnRatio = impressions > 0 ? ((highAttn / impressions) * 100).toFixed(1) : 0;
       
       const targetGroup = getTopPersona(filtered);

       // 4. KPI 박스 업데이트
       updateKPI("Ad Impressions", impressions.toLocaleString(), "Views", 
                 "Avg. Watch Time", avgWatch + "s", `Ad ID: ${adId}`,
                 "High Attention %", attnRatio + "%", "Score > 0.6",
                 "Effective Reach", targetGroup, "Main Viewer Group");

       // 5. 차트 렌더링
       renderDemographicsBar(filtered);
       renderTimeHeatmap(filtered, 'attention'); // 광고 모드는 '주목도 평균' 기준 히트맵

       // 6. 차트 제목 업데이트
       document.getElementById('chart1_title').innerText = "Viewer Demographics";
       document.getElementById('chart2_title').innerText = "Ad Effectiveness (Attention)";
       renderBottomCharts(filtered);
    }

    // --- [Helper] 필터링 적용 공통 함수 ---
    function applyFilters(data) {
       return data.filter(d => {
         // 1. 성별 필터
         if (currentFilters.gender !== 'ALL') {
            // 데이터엔 '남자'/'여자'로 저장됨 -> Male/Female로 변환해서 비교
            const g = d.gender === '남자' ? 'Male' : 'Female';
            if (g !== currentFilters.gender) return false;
         }
         // 2. 주목도 필터 (High 선택 시 0.5 미만 제외)
         if (currentFilters.attention === 'High') {
            if ((d.attention || 0) < 0.5) return false;
         }
         // 3. 연령대 필터 (다중 선택)
         if (!currentFilters.age.includes('ALL')) {
            const ageG = Math.floor(d.age / 10) * 10; // 24 -> 20
            if (!currentFilters.age.includes(String(ageG))) return false;
         }
         return true;
       });
    }

    // --- [Helper] 가장 많이 등장한 페르소나(나이+성별) 찾기 ---
    function getTopPersona(data) {
       if(data.length === 0) return "-";
       const counts = {};
       data.forEach(d => {
          const g = d.gender === '남자' ? 'M' : 'F';
          const a = Math.floor(d.age / 10) * 10;
          const key = `${a}'s ${g}`;
          counts[key] = (counts[key] || 0) + 1;
       });
       // 가장 카운트가 높은 키 반환
       return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
    }

    // --- [Helper] KPI UI 텍스트 업데이트 ---
    function updateKPI(t1, v1, s1, t2, v2, s2, t3, v3, s3, t4, v4, s4) {
      document.getElementById('kpi1_title').innerText = t1; 
      document.getElementById('kpi1_val').innerText = v1; 
      document.getElementById('kpi1_sub').innerText = s1;
      
      document.getElementById('kpi2_title').innerText = t2; 
      document.getElementById('kpi2_val').innerText = v2; 
      document.getElementById('kpi2_sub').innerText = s2;
      
      document.getElementById('kpi3_title').innerText = t3; 
      document.getElementById('kpi3_val').innerText = v3; 
      document.getElementById('kpi3_sub').innerText = s3;
      
      document.getElementById('kpi4_title').innerText = t4; 
      document.getElementById('kpi4_val').innerText = v4; 
      document.getElementById('kpi4_sub').innerText = s4;
    }

    // --- [Chart 1] 막대 그래프 그리기 ---
    function renderDemographicsBar(data) {
      const container = document.getElementById('barChartContainer');
      container.innerHTML = '';
      if(data.length === 0) { 
          container.innerHTML = '<div style="text-align:center; color:#ccc; margin-top:40px;">No Data Found</div>'; 
          return; 
      }

      // 연령대별 카운팅
      const ageGroups = { '10대':0, '20대':0, '30대':0, '40대':0, '50대':0, '60대+':0 };
      data.forEach(d => {
         let ag = Math.floor(d.age / 10) * 10;
         if(ag < 10) ag = 10; 
         if(ag > 60) ag = 60;
         const label = ag === 60 ? '60대+' : ag + '대';
         if(ageGroups[label] !== undefined) ageGroups[label]++;
      });

      const maxVal = Math.max(...Object.values(ageGroups)); // 그래프 최대 길이 기준
      
      // HTML 생성
      for(const [label, count] of Object.entries(ageGroups)) {
         const pct = maxVal > 0 ? (count / maxVal) * 100 : 0;
         // 바 안쪽에 숫자가 보이도록
         const barHtml = `
           <div class="bar-row">
             <div class="bar-label">${label}</div>
             <div class="bar-bg">
               <div class="bar-fill" style="width:${pct}%">${count > 0 ? count : ''}</div>
             </div>
           </div>`;
         container.innerHTML += barHtml;
      }
    }

    // --- [Chart 2] 히트맵 그리기 (타입: 방문자수 'count' / 주목도 'attention') ---
    function renderTimeHeatmap(data, type) {
       const grid = document.getElementById('analysisHeatGrid');
       grid.innerHTML = '';
       
       // 7일(월~일) x 14시간(09~22시) 매트릭스 생성
       const matrix = Array.from({ length: 7 }, () => Array(14).fill(0)); 
       const counts = Array.from({ length: 7 }, () => Array(14).fill(0)); // 평균 계산용 분모

       data.forEach(d => {
          if(!d.date || !d.start_time) return;
          
          // 요일 계산 (월요일=0, 일요일=6 으로 맞춤)
          const dateObj = new Date(d.date);
          let day = dateObj.getDay() - 1; 
          if(day === -1) day = 6; // 일요일 처리

          // 시간 계산 (09시=0, 22시=13)
          const hour = parseInt(d.start_time.split(':')[0]);
          const colIdx = hour - 9; // 9시부터 시작

          if(colIdx >= 0 && colIdx < 14) {
             if(type === 'count') {
                matrix[day][colIdx]++;
             } else {
                // 주목도 모드일 경우 합계 누적
                matrix[day][colIdx] += (d.attention || 0);
                counts[day][colIdx]++;
             }
          }
       });

       // 주목도 모드라면 평균값 계산 (총합 / 인원수)
       if(type === 'attention') {
          for(let r=0; r<7; r++) {
             for(let c=0; c<14; c++) {
                if(counts[r][c] > 0) matrix[r][c] = matrix[r][c] / counts[r][c];
             }
          }
       }

       // 최대값 찾기 (색상 레벨 정규화용)
       let max = 0;
       matrix.forEach(row => row.forEach(v => { if(v > max) max = v; }));

       // 그리드 돔 생성
       const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
       for(let r=0; r<7; r++) {
          for(let c=0; c<14; c++) {
             const val = matrix[r][c];
             let lv = 0;
             if(val > 0) {
                const ratio = val / (max || 1);
                // 4단계 색상 지정
                if(ratio < 0.25) lv = 1;
                else if(ratio < 0.5) lv = 2;
                else if(ratio < 0.75) lv = 3;
                else lv = 4;
             }
             
             const cell = document.createElement('div');
             cell.className = `hm-cell lv-${lv}`;
             // 마우스 올리면 상세 수치 표시
             cell.title = `${days[r]} ${c+9}H: ${val.toFixed(1)}`;
             grid.appendChild(cell);
          }
       }
    }
    // ==========================================
    // [3. ANALYTICS LOGIC END]
    // ==========================================
  
    async function checkDataExistence() {
      const loader = document.getElementById('calLoader');
      const monitorSel = document.getElementById('sidebarMonitorSelect');
      
      // 1. 로딩 시작 표시
      if(loader) loader.style.display = 'flex';
      
      try {
        // 2. 모니터 목록 가져와서 드롭다운 채우기 (한 번만 실행)
        const monitorSnap = await db.collection("monitors").get();
        let options = '<option value="ALL">All Monitors</option>';
        monitorSnap.forEach(doc => {
          const m = doc.data();
          options += `<option value="${m.monitor_id}">${m.name}</option>`;
        });
        if(monitorSel) monitorSel.innerHTML = options;
  
        // 3. [최적화됨] 요약 컬렉션(calendar_stats)에서 조회 (속도 100배 향상)
        // 수만 개의 로그 대신 날짜별 요약본만 가져오므로 매우 빠름
        const statsSnap = await db.collection('calendar_stats').get();
        
        allLogCache = []; // 캐시 초기화
        statsSnap.forEach(doc => {
          const d = doc.data();
          if (d.dateKey && d.monitor_id) {
            // 이미 요약된 정보이므로 그대로 캐시에 저장
            allLogCache.push({ dateKey: d.dateKey, monitor_id: d.monitor_id });
          }
        });
  
        // 4. 초기 필터링 (All Monitors) 실행
        filterCalendarByMonitor();
  
      } catch (err) {
        console.error("Data Load Error:", err);
      } finally {
        // 5. 로딩 종료
        if(loader) loader.style.display = 'none';
      }
    }
  
    // 모니터 선택 시 달력 점만 다시 찍는 함수 (서버 통신 X, 즉시 반응)
    function filterCalendarByMonitor() {
      const selectedId = document.getElementById('sidebarMonitorSelect').value;
      
      // Set 초기화
      dataDates.clear();
  
      // 메모리(allLogCache)에서 필터링
      allLogCache.forEach(item => {
        if (selectedId === 'ALL' || item.monitor_id === selectedId) {
          dataDates.add(item.dateKey);
        }
      });
  
      // 달력 다시 그리기
      renderSbCal();
    }

  function changeMonth(step) {
    currentCalDate.setDate(1);
    currentCalDate.setMonth(currentCalDate.getMonth() + step);
    renderSbCal();
  }

  function renderSbCal() {
    const year = currentCalDate.getFullYear();
    const month = currentCalDate.getMonth();

    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    document.getElementById('calMonthYear').innerText = `${monthNames[month]} ${year}`;

    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();

    const grid = document.getElementById('sidebarCalGrid');
    grid.innerHTML = '';

    for (let i = 0; i < firstDay; i++) {
      grid.innerHTML += `<div></div>`;
    }

    for (let d = 1; d <= lastDate; d++) {
      // [수정됨] DB의 dateKey ("2025-05-09") 포맷과 일치하도록 padStart(2, '0') 적용
      const mStr = (month + 1).toString().padStart(2, '0');
      const dStr = d.toString().padStart(2, '0');
      const dateKey = `${year}-${mStr}-${dStr}`;
      
      const isSelected = selectedDates.includes(dateKey);
      
      // dataDates Set에는 이미 DB 포맷(YYYY-MM-DD)으로 저장되어 있으므로 이제 매칭됨
      const hasData = dataDates.has(dateKey);

      const cls = `sb-date-cell ${hasData ? 'has-data' : ''} ${isSelected ? 'selected' : ''}`;
      
      grid.innerHTML += `
        <div class="${cls}" onclick="toggleDate('${dateKey}')">
          ${d}
          <div class="sb-dot"></div>
        </div>`;
    }
    
    document.getElementById('selCount').innerText = selectedDates.length;
  }

  window.toggleDate = (dateKey) => {
    if (selectedDates.includes(dateKey)) {
      selectedDates = selectedDates.filter(d => d !== dateKey);
    } else {
      selectedDates.push(dateKey);
    }
    renderSbCal();
  };
// [NEW] 하단 차트 2개 렌더링 함수 (산점도 + 체류시간)
    function renderBottomCharts(data) {
       // --- 1. 산점도 (Audience Pattern) ---
       const scContainer = document.getElementById('scatterChart');
       if(scContainer) {
           scContainer.innerHTML = '';
           
           if(data.length === 0) {
              scContainer.innerHTML = '<div style="text-align:center; padding-top:60px; color:#ccc;">No Data</div>';
           } else {
              // Y축 라벨 (나이 10~70)
              for(let i=10; i<=70; i+=20) {
                 scContainer.innerHTML += `<div class="sc-y-label" style="bottom:${((i-10)/60)*100}%">${i}</div>`;
              }
              // X축 라벨 (시간 09~22)
              [9, 12, 15, 18, 21].forEach(h => {
                 const pct = ((h-9)/13)*100;
                 if(pct>=0 && pct<=100) scContainer.innerHTML += `<div class="sc-x-label" style="left:${pct}%">${h}h</div>`;
              });

              // 점(Dot) 찍기
              data.forEach(d => {
                 if(!d.start_time || !d.age) return;
                 
                 // X좌표: 시간 (09:00 ~ 22:00 기준)
                 const timeParts = d.start_time.split(':');
                 const hour = parseInt(timeParts[0]) + parseInt(timeParts[1])/60;
                 let xPct = ((hour - 9) / 13) * 100;
                 
                 // Y좌표: 나이 (10세 ~ 70세 기준)
                 let age = d.age;
                 if(age < 10) age = 10; if(age > 70) age = 70;
                 let yPct = ((age - 10) / 60) * 100;

                 if(xPct < 0 || xPct > 100) return; 

                 // [수정됨] 성별 판별 로직 (M/F/Male/Female/남자/남 모두 처리)
                 // 1. 데이터를 문자열로 바꾸고, 공백 제거 후 대문자로 통일 (' m ' -> 'M')
                 let gStr = String(d.gender || "").trim().toUpperCase(); 
                 
                 // 2. 남자로 인정할 단어 목록 확인
                 const isMale = (gStr === 'M' || gStr === 'MALE' || gStr === '남자' || gStr === '남');
                 
                 const colorClass = isMale ? 'male' : 'female';
                 const size = 4 + (d.attention || 0) * 8; 

                 const dot = document.createElement('div');
                 dot.className = `scatter-dot ${colorClass}`;
                 dot.style.left = `${xPct}%`;
                 dot.style.bottom = `${yPct}%`;
                 dot.style.width = `${size}px`;
                 dot.style.height = `${size}px`;
                 // 툴팁: 마우스 올리면 정확히 어떤 값인지 보여줌
                 dot.title = `Gender: ${d.gender}\nAge: ${d.age}\nTime: ${d.start_time}`;
                 
                 scContainer.appendChild(dot);
              });
           }
       }

       // --- 2. 체류 시간 분포 (Engagement Quality) ---
       const dwContainer = document.getElementById('dwellChart');
       if(dwContainer) {
           dwContainer.innerHTML = '';
           
           if(data.length === 0) {
              dwContainer.innerHTML = '<div style="text-align:center; width:100%; padding-top:60px; color:#ccc;">No Data</div>';
           } else {
              // 구간별 카운트
              const bins = { 'Pass (<3s)':0, 'Short (3-5s)':0, 'Engaged (5-10s)':0, 'Deep (10s+)':0 };
              data.forEach(d => {
                 const t = d.duration || 0;
                 if(t < 3) bins['Pass (<3s)']++;
                 else if(t < 5) bins['Short (3-5s)']++;
                 else if(t < 10) bins['Engaged (5-10s)']++;
                 else bins['Deep (10s+)']++;
              });

              const maxVal = Math.max(...Object.values(bins)) || 1;

              for(const [label, count] of Object.entries(bins)) {
                 const heightPct = (count / maxVal) * 80; 
                 const isHigh = label.includes('Engaged') || label.includes('Deep'); 
                 
                 const html = `
                   <div class="v-bar-group">
                     <div class="v-bar-val">${count}</div>
                     <div class="v-bar ${isHigh ? 'high' : ''}" style="height:${heightPct}%"></div>
                     <div class="v-bar-lbl">${label.split(' ')[0]}</div>
                   </div>
                 `;
                 dwContainer.innerHTML += html;
              }
           }
       }
    }
    window.onload = function() {
        initMaps();
        loadMonitorList();     // 모니터 목록 불러오기
        initDragAndDrop();     // 드래그 앤 드롭 설정

        loadSidebarAds();      // [★여기에 추가] 사이드바 광고 목록 불러오기 함수 실행
        
        // [추가됨] 데이터가 있는 날짜 확인 시작
        checkDataExistence();  
        
        renderSbCal();         // 일단 빈 달력 먼저 그리기
      };

  const heatGrid = document.getElementById('heatGrid');
  if(heatGrid) {
    for(let i=0; i<7*18; i++) {
      const lv = Math.ceil(Math.random()*4);
      const div = document.createElement('div');
      div.className = `hm-cell l${lv}`;
      heatGrid.appendChild(div);
    }
  }
</script>
<div id="globalLoader">
    <div class="loader-spinner"></div>
    <div id="globalLoaderMsg">Processing Data...</div>
  </div>
</body>
</html>
