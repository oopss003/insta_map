<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Analytics Dashboard</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=qpbrmxiff4"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* === GLOBAL VARIABLES === */
    :root {
      --primary-color: #3B82F6;
      --sidebar-bg: #1E293B;
      --sidebar-text: #94A3B8;
      --bg-color: #F3F4F6;
      --card-bg: #FFFFFF;
      --text-main: #1F2937;
      --text-sub: #6B7280;
      --border-color: #E5E7EB;
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
    }

    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

    /* === SIDEBAR === */
    .sidebar { width: 280px; background-color: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; padding: 24px; flex-shrink: 0; }
    .logo-area { margin-bottom: 40px; color: white; font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
    .logo-icon { width: 32px; height: 32px; background: var(--primary-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
    
    .nav-menu { list-style: none; padding: 0; margin: 0 0 40px 0; }
    .nav-item { padding: 12px 16px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 600; color: var(--sidebar-text); transition: all 0.2s; margin-bottom: 4px; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: var(--primary-color); color: white; }

    /* 사이드바 달력 */
    .sidebar-cal { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; margin-top: auto; }
    .sb-cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; color: white; font-weight: 700; font-size: 14px; }
    .sb-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
    .sb-day-name { font-size: 10px; color: #64748B; margin-bottom: 6px; }
    .sb-date-cell { aspect-ratio: 1/1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #CBD5E1; cursor: pointer; position: relative; }
    .sb-date-cell:hover { background: rgba(255,255,255,0.1); }
    .sb-date-cell.selected { background: var(--primary-color); color: white; font-weight: 700; }
    .sb-dot { width: 4px; height: 4px; background: var(--success); border-radius: 50%; position: absolute; bottom: 4px; display: none; }
    .sb-date-cell.has-data .sb-dot { display: block; }

    /* === MAIN CONTENT === */
    .main-content { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; position: relative; }
    
    /* 공통 헤더 */
    .top-section { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; flex-shrink: 0; }
    .page-header h1 { font-size: 24px; font-weight: 800; margin: 0 0 8px 0; color: var(--text-main); }
    .page-header p { margin: 0; font-size: 14px; color: #6B7280; }
    
    .header-controls { display: flex; gap: 12px; }
    .btn { padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
    .btn-white { background: white; border: 1px solid var(--border-color); color: #374151; }
    .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }
    .btn-primary:hover { background: #2563EB; transform: translateY(-1px); }

    /* 페이지 전환용 (Display None Toggle) */
    .page-view { display: none; flex-direction: column; gap: 24px; height: 100%; }
    .page-view.active { display: flex; }

    /* --- [PAGE 1] DASHBOARD STYLES --- */
    .map-card { height: 280px; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: relative; border: 1px solid var(--border-color); flex-shrink: 0; }
    .map-badge { position: absolute; top: 16px; left: 16px; z-index: 10; background: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    
    .filter-card { background: white; padding: 16px 24px; border-radius: 16px; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); flex-shrink: 0; flex-wrap: wrap; }
    .filter-item { display: flex; align-items: center; gap: 12px; }
    .filter-label { font-size: 12px; font-weight: 700; color: #9CA3AF; text-transform: uppercase; }
    .select-box { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px; font-weight: 600; outline: none; background: #F9FAFB; }
    .toggle-chips { display: flex; gap: 6px; }
    .chip { padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border-color); font-size: 12px; font-weight: 600; color: #6B7280; cursor: pointer; background: white; }
    .chip.active { background: #EFF6FF; border-color: var(--primary-color); color: var(--primary-color); }

    .dashboard-grid { display: grid; grid-template-columns: 280px 1fr; gap: 24px; flex: 1; min-height: 0; } 
    .kpi-column { display: flex; flex-direction: column; gap: 16px; }
    .kpi-box { background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 4px; }
    .kpi-head { font-size: 12px; color: #9CA3AF; font-weight: 700; }
    .kpi-val { font-size: 24px; font-weight: 800; color: #111827; }
    .kpi-sub { font-size: 12px; color: var(--success); font-weight: 600; }

    .chart-box { background: white; border-radius: 16px; border: 1px solid var(--border-color); padding: 24px; display: flex; flex-direction: column; flex: 1; }
    .heatmap-layout { display: flex; gap: 10px; flex: 1; min-height: 0; }
    .hm-y-axis { display: grid; grid-template-rows: repeat(7, 1fr); text-align: right; padding-right: 10px; }
    .hm-row-label { font-size: 12px; color: #6B7280; font-weight: 600; display:flex; align-items:center; justify-content:flex-end; }
    .hm-grid { flex: 1; display: grid; grid-template-columns: repeat(18, 1fr); gap: 2px; }
    .hm-cell { background: #F3F4F6; border-radius: 4px; }
    .l1 { background: #DBEAFE; } .l2 { background: #93C5FD; } .l3 { background: #3B82F6; } .l4 { background: #1E40AF; }
    .hm-x-axis { display: grid; grid-template-columns: repeat(18, 1fr); gap: 2px; margin-top: 8px; padding-left: 40px; }
    .hm-col-label { font-size: 10px; color: #9CA3AF; text-align: center; }

    /* --- [PAGE 2] MONITOR LIST STYLES --- */
    .table-container { background: white; border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden; flex: 1; display: flex; flex-direction: column; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .table-header { display: grid; grid-template-columns: 1fr 2fr 1.5fr 1fr 1fr 1fr; padding: 16px 24px; background: #F8FAFC; border-bottom: 1px solid var(--border-color); font-size: 12px; font-weight: 700; color: #64748B; text-transform: uppercase; }
    .monitor-list { flex: 1; overflow-y: auto; }
    .table-row { display: grid; grid-template-columns: 1fr 2fr 1.5fr 1fr 1fr 1fr; padding: 16px 24px; border-bottom: 1px solid var(--border-color); align-items: center; font-size: 14px; transition: background 0.1s; }
    .table-row:hover { background: #F9FAFB; }
    .table-row:last-child { border-bottom: none; }
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
    .st-active { background: #DCFCE7; color: #166534; } .st-inactive { background: #FEE2E2; color: #991B1B; } .st-maintenance { background: #FEF3C7; color: #92400E; }
    .st-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .action-btn { width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border-color); background: white; cursor: pointer; color: #64748B; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .action-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background: #EFF6FF; }
    .action-btn.delete:hover { border-color: var(--danger); color: var(--danger); background: #FEF2F2; }

    /* --- [PAGE 3] UPLOAD STYLES --- */
    .upload-section { display: flex; gap: 24px; height: 100%; }
    .upload-card { flex: 1; background: white; padding: 40px; border-radius: 16px; border: 2px dashed var(--border-color); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; height: 400px; }
    .upload-card:hover { border-color: var(--primary-color); background: #EFF6FF; }
    .upload-card.drag-over {
          border-color: var(--primary-color);
          background-color: #DBEAFE; /* 조금 더 진한 파란색 배경 */
          transform: scale(1.02);
        }
    .upload-icon { font-size: 48px; color: #CBD5E1; margin-bottom: 16px; }
    .upload-title { font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 8px; }
    .upload-desc { font-size: 13px; color: var(--text-sub); }
    .file-status { margin-top: 10px; font-size: 13px; font-weight: 600; color: var(--primary-color); }

    /* --- MODAL STYLES --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; justify-content: center; align-items: center; }
    .modal-box { background: white; width: 450px; padding: 24px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .modal-title { font-size: 18px; font-weight: 800; margin-bottom: 16px; }
    .form-input-full { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; font-size: 14px; }
    .modal-actions { display: flex; gap: 10px; margin-top: 10px; }
    
    /* 지도 추가 스타일 */
    .modal-map { width: 100%; height: 200px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 16px; overflow: hidden; }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="logo-area">
      <div class="logo-icon"><i class="fa-solid fa-chart-simple"></i></div>
      INWAVE Analytics
    </div>

    <ul class="nav-menu">
      <li class="nav-item active" onclick="showPage('dashboard', this)"><i class="fa-solid fa-house"></i> Dashboard</li>
      <li class="nav-item" onclick="showPage('monitors', this)"><i class="fa-solid fa-desktop"></i> Monitors</li>
      <li class="nav-item" onclick="showPage('upload', this)"><i class="fa-solid fa-file-arrow-up"></i> Data Upload</li>
    </ul>

    <div class="sidebar-cal">
          <div class="sb-cal-header">
            <span id="calMonthYear">October 2025</span>
            <div style="display:flex; gap:8px;">
              <i class="fa-solid fa-chevron-left" style="cursor:pointer" onclick="changeMonth(-1)"></i>
              <i class="fa-solid fa-chevron-right" style="cursor:pointer" onclick="changeMonth(1)"></i>
            </div>
          </div>
          <div class="sb-cal-grid" style="margin-bottom:8px;">
            <div class="sb-day-name">S</div><div class="sb-day-name">M</div><div class="sb-day-name">T</div>
            <div class="sb-day-name">W</div><div class="sb-day-name">T</div><div class="sb-day-name">F</div><div class="sb-day-name">S</div>
          </div>
          <div class="sb-cal-grid" id="sidebarCalGrid"></div>
          <div style="margin-top:16px; font-size:11px; color:#94A3B8; text-align:center;">
            <span style="color:white; font-weight:700;" id="selCount">0</span> days selected
          </div>
        </div>


  <div class="main-content">
    
    <div id="page-dashboard" class="page-view active">
      <div class="top-section">
        <div class="page-header">
          <h1>Dashboard Overview</h1>
          <p>Monitor Traffic & Ad Performance Analysis</p>
        </div>
        <div class="header-controls">
          <div class="btn-white btn" onclick="location.href='https://inwave.ai.kr/analyze.html'">
            <i class="fa-solid fa-user"></i> Admin
          </div>
          <button class="btn btn-primary"><i class="fa-solid fa-download"></i> Export</button>
        </div>
      </div>
      <div class="map-card">
        <div id="miniMap" style="width:100%; height:100%;"></div>
        <div class="map-badge"><i class="fa-solid fa-location-dot" style="color:#3B82F6"></i> Live Location</div>
      </div>
      <div class="filter-card">
        <div class="filter-item">
          <div class="filter-label">Target</div>
          <select class="select-box"><option>All Traffic</option><option>Nike Ad</option></select>
        </div>
        <div style="width:1px; height:24px; background:#E5E7EB;"></div>
        <div class="filter-item">
          <div class="filter-label">Filter</div>
          <div class="toggle-chips">
            <div class="chip active">Traffic</div>
            <div class="chip">Male</div>
            <div class="chip">Female</div>
          </div>
        </div>
      </div>
      <div class="dashboard-grid">
        <div class="kpi-column">
          <div class="kpi-box">
            <div class="kpi-head">Total Impressions</div>
            <div class="kpi-val">42,593</div>
            <div class="kpi-sub">+12.5%</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-head">Avg. Dwell Time</div>
            <div class="kpi-val">4.8s</div>
            <div class="kpi-sub" style="color:#6B7280">Target: 5.0s</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-head">Peak Hour</div>
            <div class="kpi-val">19:00</div>
            <div class="kpi-sub" style="color:#6B7280">Fri</div>
          </div>
        </div>
        <div class="chart-box">
          <div class="chart-header">
            <div style="font-weight:700;">Weekly Heatmap</div>
            <div style="font-size:12px; color:#9CA3AF;">Low ■ ■ ■ ■ High</div>
          </div>
          <div class="heatmap-layout">
            <div class="hm-y-axis"><div class="hm-row-label">Mon</div><div class="hm-row-label">Tue</div><div class="hm-row-label">Wed</div><div class="hm-row-label">Thu</div><div class="hm-row-label">Fri</div><div class="hm-row-label">Sat</div><div class="hm-row-label">Sun</div></div>
            <div class="hm-grid" id="heatGrid"></div>
          </div>
          <div class="hm-x-axis"><span class="hm-col-label">06</span><span class="hm-col-label">09</span><span class="hm-col-label">12</span><span class="hm-col-label">15</span><span class="hm-col-label">18</span><span class="hm-col-label">21</span></div>
        </div>
      </div>
    </div>


    <div id="page-monitors" class="page-view">
      <div class="top-section">
        <div class="page-header">
          <h1>Monitor Management</h1>
          <p>등록된 모니터 기기 목록 및 상태를 관리합니다.</p>
        </div>
        <button class="btn btn-primary" onclick="openAddModal()">
          <i class="fa-solid fa-plus"></i> Add New Monitor
        </button>
      </div>

      <div class="map-card" style="margin-bottom: 24px; height: 300px;">
        <div id="monitorMap" style="width:100%; height:100%;"></div>
        <div class="map-badge"><i class="fa-solid fa-map" style="color:#3B82F6"></i> Device Overview</div>
      </div>

      <div class="table-container">
        <div class="table-header">
          <div>ID</div><div>Location Name</div><div>Coordinates</div><div>Status</div><div>Last Update</div><div style="text-align:right">Action</div>
        </div>
        
        <div class="monitor-list" id="monitorList">
          <div style="padding:40px; text-align:center; color:#999;">데이터를 불러오는 중입니다...</div>
        </div>
      </div>
    </div>


    <div id="page-upload" class="page-view">
          <div class="top-section">
            <div class="page-header">
              <h1>Data Upload</h1>
              <p>Face Analysis 및 Video Log CSV 파일을 업로드하세요.</p>
            </div>
          </div>
          
          <input type="file" id="file_face" accept=".csv, .xlsx, .xls" style="display:none" onchange="handleFileSelect(this, 'face')">
          <input type="file" id="file_video" accept=".csv, .xlsx, .xls" style="display:none" onchange="handleFileSelect(this, 'video')">
    
          <div class="upload-section">
            <div class="upload-card" id="drop_zone_face" onclick="document.getElementById('file_face').click()">
              <i class="fa-solid fa-users-viewfinder upload-icon"></i>
              <div class="upload-title">Face Analysis CSV</div>
              <div class="upload-desc">Click to Upload or Drag & Drop</div>
              <div id="status_face" class="file-status"></div>
            </div>
            
            <div class="upload-card" id="drop_zone_video" onclick="document.getElementById('file_video').click()">
              <i class="fa-solid fa-file-video upload-icon"></i>
              <div class="upload-title">Video Log CSV</div>
              <div class="upload-desc">Click to Upload or Drag & Drop</div>
              <div id="status_video" class="file-status"></div>
            </div>
          </div>
    
          <div style="margin-top:20px; text-align:right;">
            <button class="btn btn-primary" style="padding:14px 28px; font-size:15px;" onclick="startUploadProcess()">
              <i class="fa-solid fa-cloud-arrow-up"></i> Start Analysis Processing
            </button>
          </div>
        </div>
    
      </div> <div class="modal-overlay" id="addModal">
        <div class="modal-box">
          <div class="modal-title">Add New Monitor</div>
          <input type="text" id="new_id" class="form-input-full" placeholder="Monitor ID (ex: SEOUL_GN_01)">
          <input type="text" id="new_name" class="form-input-full" placeholder="Location Name (ex: 강남역 1번출구)">
          <div style="display:flex; gap:10px;">
            <input type="text" id="new_lat" class="form-input-full" placeholder="Latitude (위도)" readonly style="background:#f9f9f9">
            <input type="text" id="new_lng" class="form-input-full" placeholder="Longitude (경도)" readonly style="background:#f9f9f9">
          </div>
          <div class="modal-actions">
            <button class="btn btn-primary" style="flex:1" onclick="saveNewMonitor()">Save</button>
            <button class="btn btn-white" style="flex:1" onclick="closeAddModal()">Cancel</button>
          </div>
        </div>
      </div>


  <script>
  /* 1. FIREBASE CONFIGURATION */
  const firebaseConfig = {
    apiKey: "AIzaSyDjxFnP5wEE6ivH6VSUHsu8nR_X8GkARB0",
    authDomain: "twopage-ea909.firebaseapp.com",
    projectId: "twopage-ea909",
    storageBucket: "twopage-ea909.firebasestorage.app",
    messagingSenderId: "398686352913",
    appId: "1:398686352913:web:0bb872aa1e71c62ad863b0"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /* 2. DYNAMIC UI INJECTION */
  const modalBox = document.querySelector('.modal-box');
  if (modalBox) {
    const mapContainer = document.createElement('div');
    mapContainer.id = "modalMap";
    mapContainer.className = "modal-map";
    const title = modalBox.querySelector('.modal-title');
    title.insertAdjacentElement('afterend', mapContainer);
  }
  const uploadHeader = document.querySelector('#page-upload .page-header');
  if (uploadHeader) {
    const selectDiv = document.createElement('div');
    selectDiv.style.marginTop = "16px";
    selectDiv.innerHTML = `<label style="font-size:13px; font-weight:700; color:#374151; display:block; margin-bottom:8px;">Target Monitor</label><select id="upload_monitor_select" style="width:100%; max-width:300px; padding:10px; border:1px solid #E5E7EB; border-radius:8px; font-size:14px;"><option value="">Select a monitor...</option></select>`;
    uploadHeader.appendChild(selectDiv);
  }

  /* 3. MAP LOGIC */
  var dashboardMap = null;
  var monitorMap = null; // [NEW] 모니터 관리용 지도
  var modalMap = null;
  var tempMarker = null;
  var monitorMarkers = []; // [NEW] 모니터 지도 마커 리스트

  function initMaps() {
    // 1. 대시보드 맵
    dashboardMap = new naver.maps.Map('miniMap', { center: new naver.maps.LatLng(37.498095, 127.027610), zoom: 15 });
    
    // 2. [NEW] 모니터 관리 맵
    monitorMap = new naver.maps.Map('monitorMap', { center: new naver.maps.LatLng(37.498095, 127.027610), zoom: 14 });

    // 3. 모달 맵
    modalMap = new naver.maps.Map('modalMap', { center: new naver.maps.LatLng(37.498095, 127.027610), zoom: 15 });
    naver.maps.Event.addListener(modalMap, 'click', function(e) { setModalMarker(e.coord); });
  }

  function setModalMarker(latlng) {
    if (tempMarker) tempMarker.setMap(null);
    tempMarker = new naver.maps.Marker({
      position: latlng, map: modalMap,
      icon: { content: '<div style="background:#2563EB; width:20px; height:20px; border:3px solid white; border-radius:50%; box-shadow:0 0 10px rgba(37,99,235,0.5);"></div>', anchor: new naver.maps.Point(10, 10) }
    });
    document.getElementById('new_lat').value = latlng.lat();
    document.getElementById('new_lng').value = latlng.lng();
  }

  /* 4. PAGE NAVIGATION */
  /* 수정된 showPage 함수 */
  function showPage(pageId, btn) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.page-view').forEach(el => el.classList.remove('active'));
    document.getElementById('page-' + pageId).classList.add('active');
  
    // 지도 깨짐 방지 및 데이터 로드
    if(pageId === 'dashboard') {
      // 대시보드 맵 리사이즈 (기존 코드 유지)
      setTimeout(() => dashboardMap.setSize(new naver.maps.Size(document.querySelector('#page-dashboard .map-card').offsetWidth, 280)), 100);
    } else if (pageId === 'monitors') {
      // [수정됨] 모니터 페이지 열릴 때 정확한 타겟(.map-card)의 너비를 가져오도록 수정
      setTimeout(() => {
        // 1. #page-monitors 안의 .map-card를 찾도록 수정
        const monitorCard = document.querySelector('#page-monitors .map-card'); 
        
        if (monitorCard) {
          monitorMap.setSize(new naver.maps.Size(monitorCard.offsetWidth, 300));
          
          // (선택사항) 리사이즈 후 중심점이 어긋나는 것을 방지하기 위해 센터 재설정 추천
          // monitorMap.setCenter(new naver.maps.LatLng(37.498095, 127.027610)); 
        }
        
        loadMonitorList(); 
      }, 100);
    } else if (pageId === 'upload') {
      loadMonitorSelectOptions();
    }
  }

  /* 5. MONITOR MANAGEMENT (리스트 + 지도 마커) */
  function loadMonitorList() {
    const listEl = document.getElementById('monitorList');
    listEl.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">Loading...</div>';
    
    // 기존 마커 제거
    monitorMarkers.forEach(m => m.setMap(null));
    monitorMarkers = [];

    db.collection("monitors").orderBy("updated_at", "desc").get().then((snapshot) => {
      let html = '';
      if (snapshot.empty) {
        listEl.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">등록된 모니터가 없습니다.</div>';
        return;
      }

      snapshot.forEach((doc) => {
        const d = doc.data();
        const badgeClass = d.status === 'active' ? 'st-active' : 'st-inactive';
        let dateStr = '-';
        if(d.updated_at) {
          const date = d.updated_at.toDate();
          dateStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
        }

        // 1. 리스트 추가
        html += `
          <div class="table-row">
            <div style="font-weight:700; color:#3B82F6;">#${d.monitor_id}</div>
            <div style="font-weight:600;">${d.name}</div>
            <div style="color:#6B7280; font-size:13px;">${d.location.lat.toFixed(4)}, ${d.location.lng.toFixed(4)}</div>
            <div><span class="status-badge ${badgeClass}"><span class="st-dot"></span> ${d.status.toUpperCase()}</span></div>
            <div style="color:#6B7280; font-size:13px;">${dateStr}</div>
            <div style="text-align:right; display:flex; justify-content:flex-end; gap:8px;">
              <button class="action-btn" onclick="openEditModal('${d.monitor_id}', '${d.name}', ${d.location.lat}, ${d.location.lng})"><i class="fa-solid fa-pen"></i></button>
              <button class="action-btn" onclick="deleteMonitor('${d.monitor_id}')"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
        `;

        // 2. 지도 마커 추가
        const marker = new naver.maps.Marker({
          position: new naver.maps.LatLng(d.location.lat, d.location.lng),
          map: monitorMap,
          icon: {
            content: `<div style="position:relative; cursor:pointer;">
              <div style="background:#3B82F6; width:12px; height:12px; border:2px solid white; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>
              <div style="position:absolute; top:-25px; left:50%; transform:translateX(-50%); background:white; padding:3px 6px; border-radius:6px; font-size:10px; font-weight:700; box-shadow:0 1px 3px rgba(0,0,0,0.2); white-space:nowrap;">${d.name}</div>
            </div>`,
            anchor: new naver.maps.Point(6, 6)
          }
        });
        monitorMarkers.push(marker);
      });
      
      listEl.innerHTML = html;
      
      // 마커가 있다면 첫 번째 마커로 이동
      if(monitorMarkers.length > 0) {
        monitorMap.panTo(monitorMarkers[0].getPosition());
      }
    });
  }

  function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }

  function saveNewMonitor() {
    const id = document.getElementById('new_id').value;
    const name = document.getElementById('new_name').value;
    const lat = parseFloat(document.getElementById('new_lat').value);
    const lng = parseFloat(document.getElementById('new_lng').value);

    if(!id || !name || isNaN(lat)) return alert("ID, 이름, 위치(지도클릭)는 필수입니다.");

    db.collection("monitors").doc(id).set({
      monitor_id: id, name: name, location: {lat, lng}, status: 'active',
      updated_at: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true }).then(() => {
      alert("저장되었습니다!");
      closeAddModal();
      loadMonitorList();
    });
  }

  function deleteMonitor(id) {
    if(confirm("정말 삭제하시겠습니까?")) {
      db.collection("monitors").doc(id).delete().then(() => loadMonitorList());
    }
  }
  // [새로운 코드] 추가 버튼 눌렀을 때 (내용 비우고 열기)
    function openAddModal() { 
      // 1. 입력창 초기화
      document.getElementById('new_id').value = '';
      document.getElementById('new_name').value = '';
      document.getElementById('new_lat').value = '';
      document.getElementById('new_lng').value = '';
      
      // 2. ID 입력창 활성화 (수정 모드에서 잠겼을 수 있으므로 풀기)
      const idInput = document.getElementById('new_id');
      idInput.disabled = false;
      idInput.style.backgroundColor = "white";
  
      // 3. 타이틀 변경
      const titleEl = document.querySelector('.modal-title');
      if(titleEl) titleEl.innerText = "Add New Monitor";
  
      // 4. 모달 열기
      document.getElementById('addModal').style.display = 'flex';
      
      // 5. 지도 세팅 (기존 마커 제거)
      setTimeout(() => {
        if(modalMap) {
            modalMap.setSize(new naver.maps.Size(document.getElementById('modalMap').offsetWidth, 200));
            if(tempMarker) tempMarker.setMap(null); 
        }
      }, 100);
    }
  
    // [새로운 코드] 수정 버튼 눌렀을 때 (내용 채우고 열기)
    function openEditModal(id, name, lat, lng) {
      // 1. 기존 값 채워넣기
      const idInput = document.getElementById('new_id');
      idInput.value = id;
      document.getElementById('new_name').value = name;
      document.getElementById('new_lat').value = lat;
      document.getElementById('new_lng').value = lng;
  
      // 2. ID는 수정 못하게 막기 (회색 처리)
      idInput.disabled = true;
      idInput.style.backgroundColor = "#F3F4F6"; 
  
      // 3. 타이틀 변경
      const titleEl = document.querySelector('.modal-title');
      if(titleEl) titleEl.innerText = "Edit Monitor";
  
      // 4. 모달 열기
      document.getElementById('addModal').style.display = 'flex';
  
      // 5. 지도 세팅 (해당 위치에 마커 찍기)
      setTimeout(() => {
        if(modalMap) {
            modalMap.setSize(new naver.maps.Size(document.getElementById('modalMap').offsetWidth, 200));
            
            const targetLoc = new naver.maps.LatLng(lat, lng);
            modalMap.setCenter(targetLoc); // 지도 중심 이동
            setModalMarker(targetLoc);     // 마커 표시
        }
      }, 100);
    }

  function loadMonitorSelectOptions() {
    const sel = document.getElementById('upload_monitor_select');
    if(!sel) return;
    
    db.collection("monitors").get().then((snapshot) => {
      let opts = '<option value="">Select a monitor...</option>';
      snapshot.forEach((doc) => {
        const d = doc.data();
        opts += `<option value="${d.monitor_id}">${d.name} (${d.monitor_id})</option>`;
      });
      sel.innerHTML = opts;
    });
  }
/* 6. [NEW] EXCEL UPLOAD & PROCESSING LOGIC (Drag & Drop Updated) */
  let selectedFiles = { face: null, video: null };

  // [수정됨] 파일 처리 공통 함수 (Input 변경 및 Drop 공용)
  function handleFileUpdate(file, type) {
    if (file) {
      selectedFiles[type] = file;
      document.getElementById('status_' + type).innerText = `Ready: ${file.name} (${(file.size/1024).toFixed(1)} KB)`;
    }
  }

  // [기존] Input type="file" 변경 시 호출 (HTML onchange 연결)
  function handleFileSelect(input, type) {
    if (input.files && input.files[0]) {
      handleFileUpdate(input.files[0], type);
    }
  }

  // [추가됨] 드래그 앤 드롭 이벤트 초기화 함수
  function initDragAndDrop() {
    const zones = [
      { id: 'drop_zone_face', type: 'face' },
      { id: 'drop_zone_video', type: 'video' }
    ];

    zones.forEach(item => {
      const zone = document.getElementById(item.id);
      if (!zone) return;

      // 1. 드래그 진입/오버 시 스타일 변경 및 기본 동작 방지
      ['dragenter', 'dragover'].forEach(eventName => {
        zone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
          zone.classList.add('drag-over');
        }, false);
      });

      // 2. 드래그 떠날 시 스타일 복구
      ['dragleave', 'drop'].forEach(eventName => {
        zone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
          zone.classList.remove('drag-over');
        }, false);
      });

      // 3. 파일 드롭 시 처리
      zone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files && files.length > 0) {
          // 첫 번째 파일만 처리
          handleFileUpdate(files[0], item.type);
        }
      }, false);
    });
  }

  // 업로드 시작 버튼 로직 (기존 동일)
  async function startUploadProcess() {
    const monitorId = document.getElementById('upload_monitor_select').value;
    
    if (!monitorId) return alert("Please select a Target Monitor first.");
    if (!selectedFiles.face && !selectedFiles.video) return alert("Please select at least one file to upload.");

    if (confirm(`Monitor [${monitorId}]에 데이터를 업로드 하시겠습니까?`)) {
      if(selectedFiles.face) await processAndUpload(selectedFiles.face, 'face_analysis', monitorId);
      if(selectedFiles.video) await processAndUpload(selectedFiles.video, 'video_logs', monitorId);
    }
  }

  // 엑셀 파싱 및 업로드 (기존 동일)
  function processAndUpload(file, collectionName, monitorId) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

        if(jsonData.length === 0) {
          alert(`File ${file.name} is empty.`);
          resolve();
          return;
        }

        uploadInBatches(jsonData, collectionName, monitorId).then(() => {
          alert(`[${collectionName}] Upload Complete! (${jsonData.length} rows)`);
          resolve();
        });
      };
      reader.readAsArrayBuffer(file);
    });
  }

  // 배치 업로드 (기존 동일)
  async function uploadInBatches(data, collectionName, monitorId) {
    const BATCH_SIZE = 450;
    const total = data.length;
    
    for (let i = 0; i < total; i += BATCH_SIZE) {
      const batch = db.batch();
      const chunk = data.slice(i, i + BATCH_SIZE);
      
      chunk.forEach((row) => {
        row.monitor_id = monitorId;
        row.uploaded_at = firebase.firestore.FieldValue.serverTimestamp();
        const docRef = db.collection(collectionName).doc();
        batch.set(docRef, row);
      });

      await batch.commit();
      console.log(`Uploaded batch ${i/BATCH_SIZE + 1} / ${Math.ceil(total/BATCH_SIZE)}`);
    }
  }
/* 7. CALENDAR LOGIC (Real Date Calculation) */
  let currentCalDate = new Date(); // 현재 날짜 기준
  let selectedDates = []; // 선택된 날짜 저장

  // 월 변경 함수
  function changeMonth(step) {
    currentCalDate.setMonth(currentCalDate.getMonth() + step);
    renderSbCal();
  }

  // 달력 그리기 함수
  function renderSbCal() {
    const year = currentCalDate.getFullYear();
    const month = currentCalDate.getMonth(); // 0~11

    // 1. 헤더 텍스트 업데이트 (예: October 2025)
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    document.getElementById('calMonthYear').innerText = `${monthNames[month]} ${year}`;

    // 2. 날짜 계산
    // 이번 달 1일이 무슨 요일인지 (0:일, 1:월 ...)
    const firstDay = new Date(year, month, 1).getDay();
    // 이번 달 마지막 날짜가 며칠인지 (28, 30, 31)
    const lastDate = new Date(year, month + 1, 0).getDate();

    const grid = document.getElementById('sidebarCalGrid');
    grid.innerHTML = '';

    // 3. 앞쪽 빈칸 채우기 (요일 맞추기)
    for (let i = 0; i < firstDay; i++) {
      grid.innerHTML += `<div></div>`;
    }

    // 4. 날짜 채우기
    // (더미 데이터: 예시로 짝수 날짜에 데이터가 있다고 가정)
    for (let d = 1; d <= lastDate; d++) {
      // 해당 날짜의 고유 키 생성 (YYYY-MM-DD)
      const dateKey = `${year}-${month+1}-${d}`;
      const isSelected = selectedDates.includes(dateKey);
      const hasData = d % 2 === 0; // 예시: 짝수 날짜면 점 표시 (나중에 DB연동 가능)

      const cls = `sb-date-cell ${hasData ? 'has-data' : ''} ${isSelected ? 'selected' : ''}`;
      
      grid.innerHTML += `
        <div class="${cls}" onclick="toggleDate('${dateKey}')">
          ${d}
          <div class="sb-dot"></div>
        </div>`;
    }
    
    // 선택된 날짜 개수 업데이트
    document.getElementById('selCount').innerText = selectedDates.length;
  }

  // 날짜 클릭 토글 함수
  window.toggleDate = (dateKey) => {
    if (selectedDates.includes(dateKey)) {
      selectedDates = selectedDates.filter(d => d !== dateKey);
    } else {
      selectedDates.push(dateKey);
    }
    renderSbCal(); // 상태 반영을 위해 다시 그리기
  };

  /* ▲▲▲▲▲ [여기까지 붙여넣기] ▲▲▲▲▲ */

    window.onload = function() {
    initMaps();
    renderSbCal();
    loadMonitorList();
    
    // [추가됨] 드래그 앤 드롭 초기화 실행
    initDragAndDrop();
  };

  const heatGrid = document.getElementById('heatGrid');
  if(heatGrid) {
    for(let i=0; i<7*18; i++) {
      const lv = Math.ceil(Math.random()*4);
      const div = document.createElement('div');
      div.className = `hm-cell l${lv}`;
      heatGrid.appendChild(div);
    }
  }
</script>
</body>
</html>
